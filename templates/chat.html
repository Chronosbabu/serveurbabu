<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no">
  <title>Chat avec {{ chat_user }}</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    /* ---------- GLOBAL ---------- */
    :root {
      --bg-color: #fafafa;
      --text-color: #262626;
      --border-color: #dbdbdb;
      --card-bg: #fff;
      --link-hover: #0095f6;
      --shadow-color: rgba(0,0,0,0.05);
      --badge-bg: #ed4956;
      --badge-border: #fff;
      --messages-bg: #e5e5e5;
      --message-me-bg: #dcf8c6;
      --message-other-bg: #fff;
      --input-bg: #fafafa;
      --button-bg: #0095f6;
      --button-hover: #00376b;
      --file-btn-bg: #262626;
      --file-btn-hover: #1a1a1a;
      --mic-btn-bg: #ed4956;
      --mic-btn-recording: #d32f2f;
      --status-color: #8e8e8e;
      --read-color: #4caf50;
      --audio-me-bg: #dcf8c6;
      --audio-other-bg: #ffffff;
      --audio-waveform-color: #007AFF;
      --audio-progress-bg: #E5E5EA;
      --audio-progress-color: #007AFF;
      --progress-thumb-bg: #007AFF;
      --progress-thumb-border: #fafafa;
      --initial-bg: #dbdbdb;
    }

    [data-theme="dark"] {
      --bg-color: #1a1a1a;
      --text-color: #e0e0e0;
      --border-color: #333;
      --card-bg: #262626;
      --link-hover: #4dabf7;
      --shadow-color: rgba(0,0,0,0.3);
      --badge-bg: #ff6b6b;
      --badge-border: #262626;
      --messages-bg: #2d2d2d;
      --message-me-bg: #2a6041;
      --message-other-bg: #3a3a3a;
      --input-bg: #333;
      --button-bg: #4dabf7;
      --button-hover: #1c6dd0;
      --file-btn-bg: #444;
      --file-btn-hover: #555;
      --mic-btn-bg: #ff6b6b;
      --mic-btn-recording: #b71c1c;
      --status-color: #6b7280;
      --read-color: #66bb6a;
      --audio-me-bg: #2a6041;
      --audio-other-bg: #3a3a3a;
      --audio-waveform-color: #0A84FF;
      --audio-progress-bg: #38383D;
      --audio-progress-color: #0A84FF;
      --progress-thumb-bg: #0A84FF;
      --progress-thumb-border: #1a1a1a;
      --initial-bg: #444444;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body {
      height: 100%;
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      line-height: 1.5;
      overflow: hidden; /* Prevent body scrolling */
    }
    a { text-decoration: none; color: inherit; }
    .main-container { 
      max-width: 935px; 
      margin: 0 auto; 
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    /* ---------- HEADER ---------- */
    .main-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 20px;
      background: var(--card-bg);
      border-bottom: 1px solid var(--border-color);
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      box-shadow: 0 1px 2px var(--shadow-color);
    }
    .profile-info {
      display: flex;
      align-items: center;
    }
    .profile-pic {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 10px;
    }
    .profile-initial {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--initial-bg);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      margin-right: 10px;
    }
    .name-status {
      display: flex;
      flex-direction: column;
    }
    .chat-name {
      font-size: 1.2rem;
      font-weight: bold;
    }
    .typing-status {
      font-size: 0.8rem;
      color: var(--status-color);
      font-style: italic;
      display: none;
    }
    .header-icons {
      display: flex;
      align-items: center;
      gap: 24px;
      flex-wrap: nowrap;
    }
    .header-icons a {
      color: var(--text-color);
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: color 0.2s ease, transform 0.2s ease;
      position: relative;
      background: none;
      border: none;
      cursor: pointer;
    }
    .header-icons a:hover {
      color: var(--link-hover);
      transform: scale(1.1);
    }
    .header-icons a.active {
      color: var(--link-hover);
    }
    .message-badge {
      position: absolute;
      top: -8px;
      right: -8px;
      background: var(--badge-bg);
      color: #fff;
      font-size: 0.7rem;
      font-weight: 600;
      padding: 3px 6px;
      border-radius: 50%;
      line-height: 1;
      border: 2px solid var(--badge-border);
    }

    /* ---------- BOTTOM NAVIGATION BAR ---------- */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: var(--card-bg);
      border-top: 1px solid var(--border-color);
      display: flex;
      justify-content: space-around;
      align-items: center;
      padding: 12px 0;
      z-index: 1100; /* Higher than input-box to ensure visibility */
      box-shadow: 0 -1px 2px var(--shadow-color);
    }
    .bottom-nav a {
      color: var(--text-color);
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: color 0.2s ease, transform 0.2s ease;
    }
    .bottom-nav a:hover {
      color: var(--link-hover);
      transform: scale(1.1);
    }
    .bottom-nav a.active {
      color: var(--link-hover);
    }

    /* ---------- MESSAGES ---------- */
    .messages {
      flex: 1;
      padding: 12px 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      background: var(--messages-bg); /* WhatsApp-like background */
    }
    .messages::-webkit-scrollbar { width: 6px; }
    .messages::-webkit-scrollbar-thumb { background: var(--shadow-color); border-radius: 3px; }

    /* ---------- MESSAGE INDIVIDUAL ---------- */
    .message {
      padding: 10px 14px !important; /* Forcer le padding pour les messages texte */
      border-radius: 15px !important;
      max-width: 75% !important;
      min-width: 100px !important; /* Prevent overly narrow bubbles */
      overflow-wrap: break-word !important;
      font-size: 0.9rem !important; /* Forcer la taille de police */
      line-height: 1.4 !important; /* Forcer la hauteur de ligne */
      white-space: pre-line !important;
      box-shadow: 0 1px 3px var(--shadow-color) !important;
      box-sizing: border-box !important;
      width: fit-content !important;
      transform: scale(1) !important; /* Empêcher toute mise à l'échelle */
      max-height: none !important;
      overflow: visible !important;
      background-clip: padding-box !important; /* Assurer que le fond respecte le padding */
      -webkit-text-size-adjust: 100% !important; /* Empêcher les ajustements automatiques sur mobile */
      position: relative; /* For status indicator positioning */
    }
    .from-me {
      background: var(--message-me-bg) !important; /* WhatsApp-like green for sent messages */
      align-self: flex-end !important;
    }
    .from-other {
      background: var(--message-other-bg) !important; /* White for received messages */
      align-self: flex-start !important;
    }
    .message.audio-wrapper {
      background: none !important;
      padding: 0 !important;
      border: none !important;
      max-width: 100% !important;
      min-width: 0 !important; /* Allow audio to size naturally */
      box-shadow: none !important;
      display: flex !important;
      align-items: center !important;
      gap: 10px !important;
    }
    .message.audio-wrapper .audio-container {
      display: flex !important;
      flex-direction: column !important;
      gap: 5px !important;
      padding: 10px 14px !important;
      border-radius: 15px !important;
      max-width: 75% !important;
      min-width: 200px !important;
      box-shadow: 0 1px 3px var(--shadow-color) !important;
    }
    .message.audio-wrapper.from-me .audio-container {
      background: var(--audio-me-bg) !important;
    }
    .message.audio-wrapper.from-other .audio-container {
      background: var(--audio-other-bg) !important;
    }
    .message.audio-wrapper audio {
      width: 100% !important;
      outline: none !important;
      border-radius: 8px !important;
      margin: 0 !important;
    }
    .message img, .message video {
      max-width: 100% !important;
      border-radius: 15px !important;
      display: block !important;
    }
    .message video { max-height: 300px !important; }

    /* ---------- AUDIO DURATION & TIMER ---------- */
    .audio-duration {
      font-size: 0.8rem !important;
      color: var(--text-color) !important;
      font-weight: 500 !important;
      margin: 0 !important;
      text-align: right !important;
      opacity: 0.8 !important;
    }
    .audio-progress {
      width: 100% !important;
      height: 3px !important;
      background: var(--audio-progress-bg) !important;
      border-radius: 2px !important;
      margin-top: 5px !important;
      overflow: visible !important;
      cursor: pointer !important;
      position: relative !important;
    }
    .audio-progress-bar {
      height: 100% !important;
      background: var(--audio-progress-color) !important;
      width: 0% !important;
      transition: width 0.1s ease !important;
      border-radius: 2px !important;
      position: relative !important;
    }
    .progress-thumb {
      position: absolute !important;
      right: -6px !important;
      top: 50% !important;
      transform: translateY(-50%) !important;
      width: 12px !important;
      height: 12px !important;
      background: var(--progress-thumb-bg) !important;
      border-radius: 50% !important;
      border: 2px solid var(--progress-thumb-border) !important;
      transition: right 0.1s ease !important;
      pointer-events: none !important;
    }
    .audio-waveform {
      display: flex !important;
      align-items: center !important;
      gap: 8px !important;
      margin-top: 5px !important;
    }
    .waveform-bars {
      display: flex !important;
      gap: 2px !important;
      height: 20px !important;
    }
    .waveform-bar {
      width: 3px !important;
      background: var(--audio-waveform-color) !important;
      border-radius: 2px !important;
      animation: wave 1.5s ease-in-out infinite !important;
    }
    .waveform-bar:nth-child(2) { animation-delay: 0.1s !important; }
    .waveform-bar:nth-child(3) { animation-delay: 0.2s !important; }
    .waveform-bar:nth-child(4) { animation-delay: 0.3s !important; }
    @keyframes wave {
      0%, 100% { transform: scaleY(0.5); }
      50% { transform: scaleY(1); }
    }
    .current-time {
      font-size: 0.75rem !important;
      color: var(--text-color) !important;
      opacity: 0.7 !important;
      min-width: 40px !important;
    }

    /* ---------- MESSAGE STATUS INDICATOR ---------- */
    .status-indicator {
      position: absolute;
      bottom: 5px;
      right: 10px;
      font-size: 0.8rem;
      color: var(--status-color);
    }
    .status-indicator.read {
      color: var(--read-color);
    }

    /* ---------- INPUT BOX ---------- */
    .input-box {
      position: fixed;
      left: 0;
      right: 0;
      display: flex;
      align-items: center;
      padding: 8px 16px;
      background: var(--card-bg);
      gap: 8px;
      box-shadow: 0 -1px 2px var(--shadow-color);
      z-index: 1000;
      transition: bottom 0.3s ease; /* Smooth transition for keyboard */
    }
    .input-box textarea {
      flex: 1;
      padding: 10px 12px;
      border-radius: 20px;
      border: 1px solid var(--border-color);
      font-size: 0.9rem;
      resize: none;
      min-height: 40px;
      max-height: 100px;
      background: var(--input-bg);
      color: var(--text-color);
    }
    .input-box button {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--button-bg);
      color: #fff;
      border: none;
      font-size: 1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s ease;
    }
    .input-box button:hover { background: var(--button-hover); }
    #fileBtn { background: var(--file-btn-bg); }
    #fileBtn:hover { background: var(--file-btn-hover); }
    #micBtn { background: var(--mic-btn-bg); }
    #micBtn.recording {
      background: var(--mic-btn-recording);
      animation: pulse 1s infinite;
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(237,73,86,0.7); }
      70% { box-shadow: 0 0 0 10px rgba(237,73,86,0); }
      100% { box-shadow: 0 0 0 0 rgba(237,73,86,0); }
    }
    .input-box input[type="file"] { display: none; }

    /* ---------- RESPONSIVE ---------- */
    @media (max-width: 600px) {
      .main-container { padding: 16px 16px 70px 16px; }
      .main-header { padding: 10px 16px; }
      .logo { font-size: 1.5rem; }
      .header-icons { gap: 16px; }
      .header-icons a { font-size: 1.3rem; }
      .bottom-nav { padding: 10px 0; }
      .bottom-nav a { font-size: 1.3rem; }
      .messages { padding: 10px 12px; }
      .message {
        font-size: 0.9rem !important; /* Forcer la taille de police */
        padding: 10px 14px !important; /* Forcer le padding */
        line-height: 1.4 !important; /* Forcer la hauteur de ligne */
        max-width: 75% !important;
        min-width: 100px !important;
        overflow-wrap: break-word !important;
        width: fit-content !important;
        transform: scale(1) !important;
        max-height: none !important;
        overflow: visible !important;
        background-clip: padding-box !important;
        -webkit-text-size-adjust: 100% !important;
      }
      .message.audio-wrapper .audio-container { min-width: 180px !important; }
      .message.audio-wrapper audio { width: calc(100% - 20px) !important; }
      .input-box { padding: 6px 12px; }
      .input-box textarea { font-size: 0.9rem; padding: 10px 12px; }
      .input-box button { width: 36px; height: 36px; font-size: 0.9rem; }
      .status-indicator { font-size: 0.7rem; bottom: 4px; right: 8px; }
      .audio-duration { font-size: 0.75rem !important; }
      .current-time { font-size: 0.7rem !important; min-width: 35px !important; }
      .waveform-bars { height: 16px !important; }
      .waveform-bar { width: 2px !important; }
      .progress-thumb { width: 10px !important; height: 10px !important; right: -5px !important; }
      .profile-pic, .profile-initial { width: 32px; height: 32px; font-size: 1rem; }
      .chat-name { font-size: 1rem; }
      .typing-status { font-size: 0.75rem; }
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body data-username="{{ session['username'] }}" data-theme="light">
  <div class="main-container">
    <header class="main-header">
      <div class="profile-info">
        {% if chat_user_data.avatar %}
          <img src="{{ url_for('avatar_file', filename=chat_user_data.avatar) }}" alt="Profile" class="profile-pic">
        {% else %}
          <div class="profile-initial">{{ (chat_user_data.prenom or chat_user)[:1] | upper }}</div>
        {% endif %}
        <div class="name-status">
          {% set full_name = (chat_user_data.prenom or '') ~ ' ' ~ (chat_user_data.nom or '') | trim %}
          {% set words = full_name.split() %}
          {% if words|length >= 2 and full_name|length > 12 %}
            {% set truncated_name = words[0] ~ ' ' ~ words[1][:4] ~ '......' %}
          {% elif full_name|length > 12 %}
            {% set truncated_name = full_name[:12] ~ '...' %}
          {% else %}
            {% set truncated_name = full_name %}
          {% endif %}
          <span class="chat-name">{{ truncated_name or chat_user }}</span>
          <span id="typing-status" class="typing-status"></span>
        </div>
      </div>
      <nav class="header-icons">
        <a href="{{ url_for('index') }}" title="Accueil"><i class="fa-solid fa-house"></i></a>
        <a href="{{ url_for('add_post') }}" title="Nouvelle publication"><i class="fa-solid fa-circle-plus"></i></a>
        <a href="{{ url_for('profile', username=session.get('username')) }}" title="Profil"><i class="fa-regular fa-user"></i></a>
        <a href="{{ url_for('conversations') }}" title="Messages" class="active">
          <i class="fa-regular fa-message"></i>
          <span class="message-badge" id="unread-count" style="display:none;">0</span>
        </a>
      </nav>
    </header>

    <div class="messages" id="messages">
      {% for msg in messages %}
      <div class="message {% if msg.type == 'audio' %}audio-wrapper{% endif %} {% if msg.sender == session['username'] %}from-me{% else %}from-other{% endif %}" data-msg-id="{{ msg.id if 'id' in msg else 'old-' + loop.index0|string }}">
        {% if msg.type == 'text' %}
        {{ msg.text | replace("\n", "<br>") | safe }}
        {% elif msg.type == 'image' %}
        <img src="{{ msg.url }}" alt="image">
        {% elif msg.type == 'video' %}
        <video src="{{ msg.url }}" controls></video>
        {% elif msg.type == 'audio' %}
        <div class="audio-container">
          <audio controls src="{{ msg.url }}" class="audio-player" data-duration="{{ msg.duration if 'duration' in msg else '0' }}"></audio>
          <div class="audio-waveform">
            <div class="waveform-bars">
              <div class="waveform-bar"></div>
              <div class="waveform-bar"></div>
              <div class="waveform-bar"></div>
              <div class="waveform-bar"></div>
            </div>
            <span class="current-time">0:00</span>
          </div>
          <div class="audio-progress">
            <div class="audio-progress-bar">
              <div class="progress-thumb"></div>
            </div>
          </div>
          <p class="audio-duration">{{ msg.duration if 'duration' in msg else '0:00' }}</p>
        </div>
        {% endif %}
        {% if msg.sender == session['username'] %}
        {% set read_len = msg.read_by|length if 'read_by' in msg else 1 %}
        {% set delivered_len = msg.delivered_to|length if 'delivered_to' in msg else 0 %}
        {% set status = 'read' if read_len > 1 else 'delivered' if delivered_len > 0 else 'sent' %}
        <span class="status-indicator {{ status }}"><i class="fa-solid fa-check{{ '-double' if status != 'sent' else '' }}"></i></span>
        {% endif %}
      </div>
      {% else %}
      <div class="message from-other">Aucun message pour le moment.</div>
      {% endfor %}
    </div>

    <div class="input-box">
      <button id="fileBtn" title="Joindre un fichier"><i class="fa-solid fa-paperclip"></i></button>
      <button id="micBtn" title="Enregistrer un audio"><i class="fa-solid fa-microphone"></i></button>
      <textarea id="messageInput" placeholder="Écrire un message..." autocomplete="off"></textarea>
      <button id="sendBtn" title="Envoyer"><i class="fa-solid fa-paper-plane"></i></button>
      <input type="file" id="fileInput" accept="image/*,video/*,audio/*">
    </div>

    <nav class="bottom-nav">
      <a href="{{ url_for('notifications') }}" title="Notifications" id="notifications-link">
        <i class="fa-regular fa-bell"></i>
        <span class="message-badge" id="notifications-count" style="display:none;">0</span>
      </a>
      <a href="{{ url_for('search_users') }}" title="Rechercher"><i class="fa-solid fa-magnifying-glass"></i></a>
      <a href="{{ url_for('login') }}" title="Déconnexion" class="logout-btn"><i class="fa-solid fa-right-from-bracket"></i></a>
    </nav>
  </div>

  <script>
    // Theme application from localStorage
    const body = document.body;
    const savedTheme = localStorage.getItem('theme') || 'light';
    body.dataset.theme = savedTheme;

    const socket = io({
      reconnection: true,
      reconnectionAttempts: 5,
      reconnectionDelay: 1000,
      timeout: 20000,
      forceNew: true
    });
    const username = document.body.dataset.username;
    const chatUser = "{{ chat_user }}";
    const input = document.getElementById('messageInput');
    const btn = document.getElementById('sendBtn');
    const fileBtn = document.getElementById('fileBtn');
    const micBtn = document.getElementById('micBtn');
    const fileInput = document.getElementById('fileInput');
    const messagesDiv = document.getElementById('messages');
    const inputBox = document.querySelector('.input-box');
    const typingStatus = document.getElementById('typing-status');

    let selectedFile = null;
    let recordedAudio = null;
    let mediaRecorder, audioChunks = [];
    let isSending = false;
    let typingTimer;
    let audioDuration = 0; // For local recording duration

    // Normaliser les styles des messages texte
    function normalizeMessages() {
      console.log('Normalisation des messages...');
      const messages = document.querySelectorAll('.message:not(.audio-wrapper)');
      messages.forEach(msg => {
        msg.style.fontSize = '0.9rem';
        msg.style.lineHeight = '1.4';
        msg.style.padding = '10px 14px';
        msg.style.maxWidth = '75%';
        msg.style.minWidth = '100px';
        msg.style.width = 'fit-content';
        msg.style.transform = 'scale(1)';
        msg.style.maxHeight = 'none';
        msg.style.overflow = 'visible';
        msg.style.backgroundClip = 'padding-box';
        msg.style.webkitTextSizeAdjust = '100%';
        msg.style.whiteSpace = 'pre-line';
        console.log(`Message ${msg.dataset.msgId}: font-size=${msg.style.fontSize}, padding=${msg.style.padding}`);
      });
    }

    // Appliquer les styles à tous les messages (y compris audio)
    function normalizeAllMessages() {
      console.log('Normalisation de tous les messages...');
      const messages = document.querySelectorAll('.message');
      messages.forEach(msg => {
        if (msg.classList.contains('audio-wrapper')) {
          msg.style.padding = '0';
          msg.style.maxWidth = '100%';
          msg.style.minWidth = '0';
          msg.style.background = 'none';
          msg.style.boxShadow = 'none';
          const container = msg.querySelector('.audio-container');
          if (container) {
            container.style.background = msg.classList.contains('from-me') ? 'var(--audio-me-bg)' : 'var(--audio-other-bg)';
          }
        } else {
          msg.style.fontSize = '0.9rem';
          msg.style.lineHeight = '1.4';
          msg.style.padding = '10px 14px';
          msg.style.maxWidth = '75%';
          msg.style.minWidth = '100px';
          msg.style.width = 'fit-content';
          msg.style.transform = 'scale(1)';
          msg.style.maxHeight = 'none';
          msg.style.overflow = 'visible';
          msg.style.backgroundClip = 'padding-box';
          msg.style.webkitTextSizeAdjust = '100%';
        }
      });
      initializeAudioPlayers();
    }

    // Initialiser les players audio avec timer et progress
    function initializeAudioPlayers() {
      const audioPlayers = document.querySelectorAll('.audio-player');
      audioPlayers.forEach(player => {
        const container = player.closest('.audio-container');
        const durationEl = container.querySelector('.audio-duration');
        const currentTimeEl = container.querySelector('.current-time');
        const progressBar = container.querySelector('.audio-progress-bar');
        const progressContainer = container.querySelector('.audio-progress');
        const waveform = container.querySelector('.waveform-bars');
        const thumb = container.querySelector('.progress-thumb');

        // Set initial duration immediately after load
        player.addEventListener('loadedmetadata', () => {
          const duration = Math.floor(player.duration || 0);
          const minutes = Math.floor(duration / 60);
          const seconds = duration % 60;
          durationEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
          player.dataset.duration = duration;
          console.log(`Durée audio chargée: ${duration}s`);
        });

        // Fallback if metadata not loaded immediately
        if (!player.dataset.duration) {
          player.load();
        }

        player.addEventListener('timeupdate', () => {
          const current = Math.floor(player.currentTime);
          const duration = parseInt(player.dataset.duration) || 0;
          const progress = duration > 0 ? (current / duration) * 100 : 0;
          progressBar.style.width = `${progress}%`;
          if (thumb) {
            thumb.style.right = `${100 - progress}%`; // Move thumb from left to right
          }
          const minutes = Math.floor(current / 60);
          const seconds = current % 60;
          currentTimeEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;

          // Animate waveform based on progress
          const bars = waveform.querySelectorAll('.waveform-bar');
          bars.forEach((bar, index) => {
            const delay = (index / bars.length) * 0.5;
            if (current > 0 && !player.paused) {
              bar.style.animationPlayState = 'running';
              bar.style.animationDelay = `${delay}s`;
            } else {
              bar.style.animationPlayState = 'paused';
            }
          });
        });

        player.addEventListener('ended', () => {
          // Keep progress at 100% and thumb at end, don't reset
          const duration = parseInt(player.dataset.duration) || 0;
          const progress = 100;
          progressBar.style.width = `${progress}%`;
          if (thumb) {
            thumb.style.right = `${100 - progress}%`;
          }
          currentTimeEl.textContent = durationEl.textContent; // Show full duration
          waveform.querySelectorAll('.waveform-bar').forEach(bar => {
            bar.style.animationPlayState = 'paused';
          });
          console.log('Audio terminé, progress maintenu à 100%');
        });

        player.addEventListener('play', () => {
          // Resume waveform animation
          const bars = waveform.querySelectorAll('.waveform-bar');
          bars.forEach(bar => {
            bar.style.animationPlayState = 'running';
          });
        });

        player.addEventListener('pause', () => {
          // Pause waveform
          const bars = waveform.querySelectorAll('.waveform-bar');
          bars.forEach(bar => {
            bar.style.animationPlayState = 'paused';
          });
        });

        // Click on progress to seek
        progressContainer.addEventListener('click', (e) => {
          const rect = progressContainer.getBoundingClientRect();
          const clickX = e.clientX - rect.left;
          const width = rect.width;
          const seekTime = (clickX / width) * player.duration;
          player.currentTime = seekTime;
          console.log(`Seek to: ${seekTime}s`);
        });
      });
    }

    // Rejoindre sa room et normaliser les messages
    socket.on('connect', () => {
      socket.emit('join_room', { username: username });
      socket.emit('mark_read', { sender: chatUser });
      adjustInputHeight();
      scrollToBottom();
      adjustMessagesHeight();
      normalizeMessages();
      console.log('Connexion Socket.IO établie');
    });

    // Gérer la reconnexion
    socket.on('reconnect', (attempt) => {
      console.log(`Reconnexion réussie après ${attempt} tentatives`);
      socket.emit('join_room', { username: username });
      socket.emit('mark_read', { sender: chatUser });
      adjustMessagesHeight();
      normalizeMessages();
    });

    socket.on('reconnect_error', (error) => {
      console.error('Erreur de reconnexion Socket.IO:', error);
    });

    // Scroll automatique
    function scrollToBottom() {
      requestAnimationFrame(() => {
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
        console.log('Scroll vers le bas effectué');
      });
    }

    // Ajuster la hauteur du textarea
    function adjustInputHeight() {
      input.style.height = 'auto';
      const newHeight = Math.min(Math.max(input.scrollHeight, 40), 100);
      input.style.height = `${newHeight}px`;
      adjustMessagesHeight();
      console.log(`Hauteur textarea ajustée: ${newHeight}px`);
    }

    // Ajuster la hauteur du conteneur de messages
    function adjustMessagesHeight() {
      const headerHeight = document.querySelector('.main-header').offsetHeight || 60;
      const inputBoxHeight = inputBox.offsetHeight || 60;
      const bottomNavHeight = document.querySelector('.bottom-nav').offsetHeight || 60;
      const availableHeight = window.innerHeight - headerHeight - inputBoxHeight - bottomNavHeight;
      messagesDiv.style.height = `${availableHeight}px`;
      messagesDiv.style.marginTop = `${headerHeight}px`;
      messagesDiv.style.marginBottom = `${inputBoxHeight}px`;
      inputBox.style.bottom = `${bottomNavHeight}px`;
      console.log(`Hauteur messages ajustée: height=${availableHeight}px, margin-top=${headerHeight}px, margin-bottom=${inputBoxHeight}px, bottom-nav=${bottomNavHeight}px`);
    }

    // Gérer l'apparition du clavier
    function handleKeyboard() {
      const initialHeight = window.innerHeight;
      const bottomNavHeight = document.querySelector('.bottom-nav').offsetHeight || 60;
      window.addEventListener('resize', () => {
        const newHeight = window.innerHeight;
        if (newHeight < initialHeight) {
          inputBox.style.bottom = `${bottomNavHeight}px`;
          adjustMessagesHeight();
          scrollToBottom();
        } else {
          inputBox.style.bottom = `${bottomNavHeight}px`;
          adjustMessagesHeight();
        }
        normalizeMessages();
      });

      input.addEventListener('focus', () => {
        setTimeout(scrollToBottom, 300);
      });
    }

    // Initialisation
    window.addEventListener('load', () => {
      messagesDiv.style.height = 'auto'; // Réinitialiser pour éviter l'accumulation
      adjustInputHeight();
      scrollToBottom();
      adjustMessagesHeight();
      handleKeyboard();
      normalizeAllMessages();
      console.log('Page chargée, normalisation initiale effectuée');
    });

    // Réappliquer les styles lors de la navigation
    window.addEventListener('popstate', () => {
      messagesDiv.style.height = 'auto'; // Réinitialiser pour éviter l'accumulation
      adjustMessagesHeight();
      normalizeAllMessages();
      console.log('Navigation détectée (popstate), styles réappliqués');
    });

    input.addEventListener('input', adjustInputHeight);

    // Fonction pour obtenir l'icône de statut
    function getStatusIcon(status) {
      if (status === 'pending') {
        return '<i class="fa-solid fa-clock"></i>';
      } else if (status === 'sent') {
        return '<i class="fa-solid fa-check"></i>';
      } else {
        return '<i class="fa-solid fa-check-double"></i>';
      }
    }

    // Ajouter un message avec indicateur de statut
    function addMessage(msg, isLocal = false) {
      if (document.querySelector(`.message[data-msg-id="${msg.id}"]`)) return;
      const div = document.createElement('div');
      div.className = `message ${msg.type === 'audio' ? 'audio-wrapper' : ''} ${msg.sender === username ? 'from-me' : 'from-other'}`;
      div.dataset.msgId = msg.id;
      if (msg.type === 'text') {
        div.innerHTML = msg.text.replace(/\n/g, '<br>');
      } else if (msg.type === 'image') {
        const img = document.createElement('img');
        img.src = msg.url;
        div.appendChild(img);
      } else if (msg.type === 'video') {
        const video = document.createElement('video');
        video.src = msg.url;
        video.controls = true;
        div.appendChild(video);
      } else if (msg.type === 'audio') {
        const audioContainer = document.createElement('div');
        audioContainer.className = 'audio-container';
        const audio = document.createElement('audio');
        audio.src = msg.url;
        audio.className = 'audio-player';
        audio.controls = true;
        audio.dataset.duration = msg.duration || 0;
        audioContainer.appendChild(audio);

        const waveformContainer = document.createElement('div');
        waveformContainer.className = 'audio-waveform';
        const waveformBars = document.createElement('div');
        waveformBars.className = 'waveform-bars';
        for (let i = 0; i < 4; i++) {
          const bar = document.createElement('div');
          bar.className = 'waveform-bar';
          waveformBars.appendChild(bar);
        }
        const currentTime = document.createElement('span');
        currentTime.className = 'current-time';
        currentTime.textContent = '0:00';
        waveformContainer.appendChild(waveformBars);
        waveformContainer.appendChild(currentTime);
        audioContainer.appendChild(waveformContainer);

        const progressContainer = document.createElement('div');
        progressContainer.className = 'audio-progress';
        const progressBar = document.createElement('div');
        progressBar.className = 'audio-progress-bar';
        const thumb = document.createElement('div');
        thumb.className = 'progress-thumb';
        progressBar.appendChild(thumb);
        progressContainer.appendChild(progressBar);
        audioContainer.appendChild(progressContainer);

        const durationEl = document.createElement('p');
        durationEl.className = 'audio-duration';
        const dur = msg.duration || 0;
        const minutes = Math.floor(dur / 60);
        const seconds = dur % 60;
        durationEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        audioContainer.appendChild(durationEl);

        div.appendChild(audioContainer);
      }
      // Appliquer les styles explicitement
      if (msg.type === 'audio') {
        div.style.padding = '0';
        div.style.maxWidth = '100%';
        div.style.minWidth = '0';
        div.style.background = 'none';
        div.style.boxShadow = 'none';
        const container = div.querySelector('.audio-container');
        if (container) {
          container.style.background = msg.sender === username ? 'var(--audio-me-bg)' : 'var(--audio-other-bg)';
        }
      } else {
        div.style.fontSize = '0.9rem';
        div.style.lineHeight = '1.4';
        div.style.padding = '10px 14px';
        div.style.maxWidth = '75%';
        div.style.minWidth = '100px';
        div.style.width = 'fit-content';
        div.style.transform = 'scale(1)';
        div.style.maxHeight = 'none';
        div.style.overflow = 'visible';
        div.style.backgroundClip = 'padding-box';
        div.style.webkitTextSizeAdjust = '100%';
      }
      // Ajouter l'indicateur de statut pour les messages envoyés
      if (msg.sender === username) {
        const statusSpan = document.createElement('span');
        statusSpan.className = `status-indicator ${isLocal ? 'pending' : 'delivered'}`;
        statusSpan.innerHTML = getStatusIcon(isLocal ? 'pending' : 'delivered');
        div.appendChild(statusSpan);
      }
      messagesDiv.appendChild(div)
      scrollToBottom();
      adjustMessagesHeight();
      if (msg.sender === chatUser && !isLocal) {
        socket.emit('mark_read', { sender: chatUser });
      }
      console.log(`Message ajouté: type=${msg.type}, id=${div.dataset.msgId}, local=${isLocal}`);
    }

    // Mettre à jour le statut du message
    function updateMessageStatus(msgId, status) {
      const message = document.querySelector(`.message[data-msg-id="${msgId}"]`);
      if (message) {
        const statusSpan = message.querySelector('.status-indicator');
        if (statusSpan) {
          statusSpan.innerHTML = getStatusIcon(status);
          statusSpan.classList.toggle('read', status === 'read');
          statusSpan.className = `status-indicator ${status} ${status === 'read' ? 'read' : ''}`;
          console.log(`Statut mis à jour pour message ${msgId}: ${status}`);
        }
      }
    }

    // Envoyer un message avec tentative de réessai
    async function sendMessage() {
      if (isSending) return;
      isSending = true;
      const text = input.value.trim();

      let msgId = Date.now().toString(36) + Math.random().toString(36).substr(2);
      if (selectedFile) {
        const formData = new FormData();
        formData.append('recipient', chatUser);
        formData.append('file', selectedFile);
        try {
          const res = await fetch('/send_file', { 
            method: 'POST', 
            body: formData,
            timeout: 30000 // 30s timeout
          });
          if (res.ok) {
            const data = await res.json();
            fileInput.value = '';
            selectedFile = null;
            input.value = '';
            adjustInputHeight();
            // Add local message immediately after successful upload
            addMessage({
              id: data.id || msgId,
              sender: username,
              type: data.type,
              url: data.url,
              duration: 0 // Will be fetched by player
            }, true);
            console.log('Fichier envoyé avec succès:', data);
          } else {
            console.error('Échec de l\'envoi du fichier, statut:', res.status);
            alert('Erreur lors de l\'envoi du fichier. Réessayez.');
            // Retry once
            setTimeout(() => sendMessage(), 1000);
          }
        } catch (e) {
          console.error('Erreur réseau lors de l\'envoi du fichier:', e);
          alert('Erreur réseau lors de l\'envoi du fichier. Réessayez.');
          // Retry once
          setTimeout(() => sendMessage(), 1000);
        }
      } else if (recordedAudio) {
        // Get duration before sending
        const tempAudio = new Audio(URL.createObjectURL(recordedAudio));
        tempAudio.addEventListener('loadedmetadata', () => {
          audioDuration = Math.floor(tempAudio.duration);
          tempAudio.pause();
          URL.revokeObjectURL(tempAudio.src);
          // Now send
          const formData = new FormData();
          formData.append('recipient', chatUser);
          formData.append('file', recordedAudio, "audio_message.webm");
          fetch('/send_file', { 
            method: 'POST', 
            body: formData,
            timeout: 30000
          }).then(res => {
            if (res.ok) {
              return res.json();
            } else {
              throw new Error(`HTTP ${res.status}`);
            }
          }).then(data => {
            recordedAudio = null;
            input.value = '';
            adjustInputHeight();
            // Add local message immediately
            addMessage({
              id: data.id || msgId,
              sender: username,
              type: 'audio',
              url: data.url,
              duration: audioDuration
            }, true);
            console.log('Audio envoyé avec succès:', data);
          }).catch(e => {
            console.error('Erreur lors de l\'envoi de l\'audio:', e);
            alert('Erreur lors de l\'envoi de l\'audio. Réessayez.');
            // Retry once
            setTimeout(() => sendMessage(), 1000);
          });
        });
        tempAudio.load();
      } else if (text) {
        addMessage({
          id: msgId,
          sender: username,
          text: text,
          type: 'text',
          date: new Date().toISOString()
        }, true);
        // Tenter d'envoyer le message avec retry
        let attempts = 0;
        const maxAttempts = 5;
        const sendAttempt = () => {
          if (attempts >= maxAttempts) {
            console.error('Échec de l\'envoi du message après', maxAttempts, 'tentatives');
            alert('Échec de l\'envoi du message après plusieurs tentatives. Vérifiez votre connexion.');
            return;
          }
          if (socket.connected) {
            socket.emit('send_message', { receiver: chatUser, text: text, type: 'text', id: msgId });
            updateMessageStatus(msgId, 'sent');
            console.log(`Message envoyé: id=${msgId}, texte=${text}`);
          } else {
            attempts++;
            console.warn(`Tentative ${attempts} échouée, Socket.IO non connecté`);
            setTimeout(sendAttempt, 2000 * attempts); // Exponential backoff
          }
        };
        sendAttempt();
        input.value = '';
        adjustInputHeight();
      }
      isSending = false;
    }

    // Fichiers
    fileBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', () => {
      const file = fileInput.files[0];
      if (!file) return;
      selectedFile = file;
      input.value = "[Fichier prêt]";
      adjustInputHeight();
      console.log('Fichier sélectionné:', file.name);
    });

    // Micro avec enregistrement robuste
    micBtn.addEventListener('click', async () => {
      if (!mediaRecorder || mediaRecorder.state === "inactive") {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ 
            audio: {
              echoCancellation: true,
              noiseSuppression: true,
              sampleRate: 44100
            } 
          });
          mediaRecorder = new MediaRecorder(stream, {
            mimeType: 'audio/webm;codecs=opus'
          });
          audioChunks = [];
          mediaRecorder.ondataavailable = e => {
            if (e.data.size > 0) audioChunks.push(e.data);
          };
          mediaRecorder.onstop = () => {
            if (audioChunks.length > 0) {
              recordedAudio = new Blob(audioChunks, { type: "audio/webm" });
              input.value = "[Audio prêt]";
              adjustInputHeight();
            }
            stream.getTracks().forEach(track => track.stop());
            console.log('Enregistrement audio terminé');
          };
          mediaRecorder.onerror = (e) => {
            console.error('Erreur MediaRecorder:', e);
            alert('Erreur lors de l\'enregistrement. Réessayez.');
            micBtn.classList.remove("recording");
            stream.getTracks().forEach(track => track.stop());
          };
          mediaRecorder.start(1000); // Collect data every second for smoother chunks
          micBtn.classList.add("recording");
          console.log('Enregistrement audio démarré');
        } catch (e) {
          console.error('Erreur d\'accès au micro:', e);
          alert("Impossible d'accéder au micro. Vérifiez les permissions.");
        }
      } else {
        mediaRecorder.stop();
        micBtn.classList.remove("recording");
      }
    });

    // Bouton envoyer
    btn.addEventListener('click', sendMessage);
    input.addEventListener('keypress', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // Gestion typing
    input.addEventListener('input', () => {
      if (input.value.trim()) {
        socket.emit('typing', { receiver: chatUser });
        clearTimeout(typingTimer);
        typingTimer = setTimeout(() => {
          socket.emit('stop_typing', { receiver: chatUser });
        }, 500);
      } else {
        socket.emit('stop_typing', { receiver: chatUser });
      }
    });

    // Réception messages
    socket.on('new_message', msg => {
      if (msg.sender === username) {
        updateMessageStatus(msg.id, 'sent');
      } else {
        addMessage(msg);
      }
      normalizeMessages();
    });

    socket.on('message_delivered', data => {
      updateMessageStatus(data.id, 'delivered');
    });

    socket.on('messages_read', data => {
      data.ids.forEach(id => {
        updateMessageStatus(id, 'read');
      });
    });

    socket.on('user_typing', data => {
      if (data.sender === chatUser) {
        typingStatus.textContent = 'écrit...';
        typingStatus.style.display = 'inline';
      }
    });

    socket.on('stop_typing', data => {
      if (data.sender === chatUser) {
        typingStatus.textContent = '';
        typingStatus.style.display = 'none';
      }
    });

    // Gestion badge messages
    let unreadCount = 0;
    const updateUnreadBadge = () => {
      const badge = document.getElementById('unread-count');
      if (!badge) return;
      if (unreadCount > 0) {
        badge.style.display = 'inline';
        badge.textContent = unreadCount;
      } else {
        badge.style.display = 'none';
      }
    };

    socket.on('new_message', (message) => {
      const currentChatUser = window.location.pathname.includes('/chat/') ? window.location.pathname.split('/chat/')[1] : null;
      if (message.sender !== username && (!currentChatUser || currentChatUser !== message.sender)) {
        unreadCount++;
        updateUnreadBadge();
        console.log('Nouveau message non lu, compte:', unreadCount);
      }
    });

    window.addEventListener('load', () => {
      if (window.location.pathname.includes('/conversations') || window.location.pathname.includes('/chat/')) {
        unreadCount = 0;
        updateUnreadBadge();
      }
    });

    // Gestion badge notifications
    let notifCount = 0;
    const updateNotifBadge = () => {
      const badge = document.getElementById('notifications-count');
      if (!badge) return;
      if (notifCount > 0) {
        badge.style.display = 'inline';
        badge.textContent = notifCount;
      } else {
        badge.style.display = 'none';
      }
    };

    socket.on('new_notification', (notification) => {
      notifCount++;
      updateNotifBadge();
      console.log('Nouvelle notification, compte:', notifCount);
    });

    window.addEventListener('load', () => {
      if (window.location.pathname.includes('/notifications')) {
        notifCount = 0;
        updateNotifBadge();
      }
    });
  </script>
</body>
</html>
