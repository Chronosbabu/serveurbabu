<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CHRONOS</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Lobster&display=swap" rel="stylesheet">
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    /* ---------- GLOBAL ---------- */
    :root {
      --bg-color: #fafafa;
      --text-color: #262626;
      --border-color: #dbdbdb;
      --card-bg: #fff;
      --link-hover: #0095f6;
      --shadow-color: rgba(0,0,0,0.05);
      --button-bg: #0095f6;
      --button-hover: #00376b;
      --comment-form-bg: #fff;
      --textarea-bg: #fafafa;
      --gradient-start: #f09433;
      --gradient-end: #bc1888;
    }

    [data-theme="dark"] {
      --bg-color: #000000;
      --text-color: #ffffff;
      --border-color: #262626;
      --card-bg: #1a1a1a;
      --link-hover: #4dabf7;
      --shadow-color: rgba(255,255,255,0.1);
      --button-bg: #4dabf7;
      --button-hover: #1c6dd0;
      --comment-form-bg: #1a1a1a;
      --textarea-bg: #262626;
      --gradient-start: #f09433;
      --gradient-end: #bc1888;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      line-height: 1.5;
      overflow-x: hidden;
      transition: background 0.3s ease;
    }
    a { text-decoration: none; color: inherit; }
    .main-container { max-width: 935px; margin: 0 auto; padding: 20px 20px 80px 20px; }

    /* ---------- HEADER ---------- */
    .main-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 20px;
      background: var(--card-bg);
      border-bottom: 1px solid var(--border-color);
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 1px 2px var(--shadow-color);
      transition: background 0.3s ease, box-shadow 0.3s ease;
    }
    .logo {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--text-color);
      font-family: 'Lobster', cursive;
      letter-spacing: 1px;
      flex-shrink: 0;
      transition: color 0.3s ease;
    }
    .header-icons {
      display: flex;
      align-items: center;
      gap: 24px;
      flex-wrap: nowrap;
    }
    .header-icons a, .header-icons button {
      color: var(--text-color);
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: color 0.2s ease, transform 0.2s ease;
      position: relative;
      background: none;
      border: none;
      cursor: pointer;
    }
    .header-icons a:hover, .header-icons button:hover {
      color: var(--link-hover);
      transform: scale(1.1);
    }

    /* ---------- BOTTOM NAVIGATION BAR ---------- */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: var(--card-bg);
      border-top: 1px solid var(--border-color);
      display: flex;
      justify-content: space-around;
      align-items: center;
      padding: 12px 0;
      z-index: 1000;
      box-shadow: 0 -1px 2px var(--shadow-color);
      transition: background 0.3s ease, box-shadow 0.3s ease;
    }
    .bottom-nav a {
      color: var(--text-color);
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: color 0.2s ease, transform 0.2s ease;
      position: relative;
    }
    .bottom-nav a:hover {
      color: var(--link-hover);
      transform: scale(1.1);
    }
    .bottom-nav a.active {
      color: var(--link-hover);
    }
    .message-badge {
      position: absolute;
      top: -8px;
      right: -8px;
      background: #ed4956;
      color: #fff;
      font-size: 0.7rem;
      font-weight: 600;
      padding: 3px 6px;
      border-radius: 50%;
      line-height: 1;
      border: 2px solid var(--card-bg);
    }

    /* ---------- STORIES ---------- */
    .stories-container {
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 20px;
      padding: 10px 0;
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 2px 8px var(--shadow-color);
      transition: box-shadow 0.3s ease;
    }
    .stories-scroll {
      display: flex;
      overflow-x: auto;
      gap: 15px;
      padding: 10px 0;
      scrollbar-width: none;
    }
    .stories-scroll::-webkit-scrollbar {
      display: none;
    }
    .story-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 80px;
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    .story-item:hover {
      transform: translateY(-4px);
    }
    .story-circle {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: linear-gradient(45deg, var(--gradient-start), var(--gradient-end));
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      box-shadow: 0 2px 4px var(--shadow-color);
      transition: box-shadow 0.2s ease;
    }
    .has-story .story-circle {
      border: 3px solid #db2777;
    }
    .no-story .story-circle {
      border: 3px solid var(--border-color);
    }
    .story-circle img, .story-circle .avatar-fallback {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--card-bg);
    }
    .add-story {
      position: absolute;
      bottom: 0;
      right: 0;
      background: var(--button-bg);
      color: #fff;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      box-shadow: 0 1px 2px var(--shadow-color);
    }
    .add-story.small {
      bottom: -4px;
      right: -4px;
      width: 20px;
      height: 20px;
      font-size: 1rem;
    }
    .story-item p {
      font-size: 0.75rem;
      margin-top: 5px;
      text-align: center;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 80px;
    }

    /* ---------- STORY MODAL ---------- */
    #story-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.9);
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }
    .story-progress {
      position: absolute;
      top: 15px;
      left: 5%;
      width: 90%;
      display: flex;
      gap: 3px;
    }
    .progress-bar {
      flex: 1;
      height: 3px;
      background: rgba(255,255,255,0.4);
      border-radius: 3px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: white;
      width: 0;
      border-radius: 3px;
      transition: width 0.1s linear;
    }
    .story-carousel {
      width: 100%;
      height: 100%;
      position: relative;
    }
    .story-track {
      display: flex;
      width: 100%;
      height: 100vh;
      overflow-x: hidden;
      transition: transform 0.3s ease;
    }
    .story-slide {
      flex: 0 0 100%;
      width: 100%;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .story-slide img, .story-slide video {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    }
    .tap-left, .tap-right {
      position: absolute;
      top: 0;
      height: 100%;
      width: 50%;
      z-index: 15;
    }
    .tap-left {
      left: 0;
    }
    .tap-right {
      right: 0;
    }

    /* ---------- STORY VIEWERS ---------- */
    #viewer-count {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      color: white;
      cursor: pointer;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 5px;
      background: rgba(0,0,0,0.5);
      padding: 5px 10px;
      border-radius: 20px;
    }
    #viewer-modal {
      display: none;
      position: absolute;
      bottom: 60px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255,255,255,0.9);
      color: #000;
      padding: 15px;
      border-radius: 12px;
      max-height: 300px;
      overflow-y: auto;
      width: 80%;
      max-width: 400px;
      z-index: 25;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    #viewer-modal.dark {
      background: rgba(0,0,0,0.9);
      color: #fff;
    }
    .viewer-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 0;
      border-bottom: 1px solid rgba(0,0,0,0.1);
    }
    .viewer-item:last-child {
      border-bottom: none;
    }
    .viewer-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
    }
    .viewer-username {
      font-weight: 600;
    }

    /* ---------- POSTS ---------- */
    .scroll-box {
      padding: 20px 0;
    }
    .post {
      background: var(--card-bg);
      margin-bottom: 24px;
      border: 1px solid var(--border-color);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 4px 16px var(--shadow-color);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .post:hover {
      transform: translateY(-6px);
      box-shadow: 0 8px 24px var(--shadow-color);
    }
    .user-info {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border-color);
    }
    .avatar-post, .avatar-fallback {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      object-fit: cover;
      background: linear-gradient(45deg, var(--gradient-start), var(--gradient-end));
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 1.1rem;
      color: #fff;
      border: 2px solid var(--card-bg);
      box-shadow: 0 2px 4px var(--shadow-color);
      transition: transform 0.2s ease;
    }
    .avatar-post:hover, .avatar-fallback:hover {
      transform: scale(1.05);
    }
    .username-link {
      margin-left: 12px;
      font-weight: 600;
      font-size: 0.95rem;
      color: var(--text-color);
      transition: color 0.2s ease;
    }
    .username-link:hover {
      color: var(--link-hover);
    }
    .description {
      padding: 12px 16px;
      font-size: 0.9rem;
      line-height: 1.4;
      word-wrap: break-word;
      overflow-wrap: break-word;
      white-space: normal;
      max-width: 100%;
      overflow: hidden;
      display: -webkit-box;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: 2;
      position: relative;
    }
    .description.expanded {
      -webkit-line-clamp: unset;
    }
    .toggle-description {
      display: none;
      color: var(--link-hover);
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 600;
      padding: 0 16px 12px 16px;
      transition: color 0.2s ease;
    }
    .toggle-description:hover {
      color: var(--button-hover);
    }
    .description.long + .toggle-description {
      display: block;
    }

    /* ---------- MEDIA ---------- */
    .post-image, video {
      width: 100%;
      max-height: 80vh;
      object-fit: cover;
      display: block;
      background: #000;
      cursor: pointer;
      transition: filter 0.3s ease;
    }
    .post-image:hover, video:hover {
      filter: brightness(1.1);
    }
    .video-container {
      position: relative;
    }
    .mute-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1rem;
      z-index: 10;
      transition: background 0.2s ease, transform 0.2s ease;
    }
    .mute-btn:hover {
      background: rgba(0, 0, 0, 0.9);
      transform: scale(1.1);
    }

    /* ---------- CAROUSEL MULTIMEDIA ---------- */
    .carousel {
      position: relative;
      width: 100%;
      overflow: hidden;
    }
    .carousel-track {
      display: flex;
      width: 100%;
      overflow-x: auto;
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      scroll-behavior: smooth;
    }
    .carousel-track::-webkit-scrollbar { display: none; }
    .carousel-track > * {
      flex: 0 0 100%;
      width: 100%;
      scroll-snap-align: start;
    }
    .carousel-indicators {
      position: absolute;
      bottom: 12px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 8px;
      z-index: 10;
    }
    .carousel-indicators .dot {
      width: 8px;
      height: 8px;
      background: rgba(255, 255, 255, 0.5);
      border-radius: 50%;
      transition: transform 0.2s ease, background 0.2s ease;
      cursor: pointer;
    }
    .carousel-indicators .dot.active {
      background: #fff;
      transform: scale(1.4);
    }

    /* ---------- ACTIONS ---------- */
    .post-actions {
      display: flex;
      align-items: center;
      padding: 8px 16px;
      border-top: 1px solid var(--border-color);
    }
    .like-btn {
      border: none;
      background: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-color);
      transition: transform 0.2s ease, color 0.2s ease;
    }
    .like-btn:hover {
      transform: scale(1.15);
      color: #ed4956;
    }
    .like-btn.liked {
      color: #ed4956;
      animation: heart-bounce 0.3s ease;
    }
    @keyframes heart-bounce {
      0% { transform: scale(1); }
      50% { transform: scale(1.3); }
      100% { transform: scale(1); }
    }
    .comment-btn {
      display: flex;
      align-items: center;
      margin-left: 16px;
      font-size: 1.5rem;
      color: var(--text-color);
      transition: transform 0.2s ease, color 0.2s ease;
    }
    .comment-btn:hover {
      transform: scale(1.15);
      color: var(--link-hover);
    }
    .like-count, .comment-count {
      margin-left: 8px;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-color);
    }
    .follow-btn {
      margin-left: auto;
      background: var(--button-bg);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 6px 16px;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: background 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
    }
    .follow-btn i {
      font-size: 0.9rem;
    }
    .follow-btn:hover {
      background: var(--button-hover);
      transform: scale(1.05);
      box-shadow: 0 2px 4px var(--shadow-color);
    }
    .follow-btn.following {
      background: var(--textarea-bg);
      color: var(--text-color);
      border: 1px solid var(--border-color);
    }
    .follow-btn.following:hover {
      background: var(--border-color);
    }

    /* ---------- DATE ---------- */
    .date {
      font-size: 0.75rem;
      color: #8e8e8e;
      padding: 8px 16px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* ---------- COMMENTS ---------- */
    .comments-section {
      display: none;
      flex-direction: column;
      height: 300px;
      position: relative;
      border-top: 1px solid var(--border-color);
    }
    .comments-section.open {
      display: flex;
    }
    .comments-box {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      scrollbar-width: none;
    }
    .comments-box::-webkit-scrollbar { display: none; }
    .comment {
      display: flex;
      align-items: flex-start;
      padding: 8px 0;
      opacity: 1;
      z-index: 1;
      transition: opacity 0.3s ease;
    }
    .avatar-comment, .avatar-fallback {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      object-fit: cover;
      background: linear-gradient(45deg, var(--gradient-start), var(--gradient-end));
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 1rem;
      color: #fff;
      border: 2px solid var(--card-bg);
      box-shadow: 0 2px 4px var(--shadow-color);
      margin-right: 10px;
      transition: transform 0.2s ease;
    }
    .avatar-comment:hover, .avatar-fallback:hover {
      transform: scale(1.05);
    }
    .comment-content {
      flex: 1;
      max-width: calc(100% - 46px);
    }
    .comment-content p:first-child {
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--text-color);
    }
    .comment-content p:first-child a:hover {
      color: var(--link-hover);
    }
    .comment-content p:nth-child(2) {
      font-size: 0.85rem;
      color: var(--text-color);
      word-wrap: break-word;
      overflow-wrap: break-word;
      white-space: normal;
      max-width: 100%;
      line-height: 1.4;
    }
    .comment-content small {
      font-size: 0.75rem;
      color: #8e8e8e;
      display: block;
      margin-top: 4px;
    }
    .no-comments {
      font-size: 0.9rem;
      color: #6b7280;
      text-align: center;
      padding: 16px 0;
    }

    /* ---------- COMMENT FORM ---------- */
    .comment-form {
      padding: 12px 16px;
      border-top: 1px solid var(--border-color);
      background: var(--comment-form-bg);
      position: sticky;
      bottom: 0;
      width: 100%;
      z-index: 20;
      transition: background 0.3s ease;
    }
    .comment-form form {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .comment-form textarea {
      flex: 1;
      padding: 8px 12px;
      font-size: 0.85rem;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      resize: none;
      height: 40px;
      background: var(--textarea-bg);
      color: var(--text-color);
      font-family: inherit;
      word-wrap: break-word;
      overflow-wrap: break-word;
      white-space: pre-wrap;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    .comment-form textarea:focus {
      outline: none;
      border-color: var(--link-hover);
      box-shadow: 0 0 0 2px rgba(0,149,246,0.2);
    }
    .comment-form button {
      background: var(--button-bg);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
    }
    .comment-form button:hover {
      background: var(--button-hover);
      transform: scale(1.05);
      box-shadow: 0 2px 4px var(--shadow-color);
    }
    .comment-form button:disabled {
      background: #b2dffc;
      cursor: not-allowed;
    }

    /* ---------- RESPONSIVE ---------- */
    @media (max-width: 600px) {
      .main-container { padding: 16px 16px 70px 16px; }
      .avatar-post, .avatar-fallback, .avatar-comment { width: 36px; height: 36px; font-size: 0.9rem; }
      .post-image, video { max-height: 70vh; }
      .header-icons { gap: 16px; }
      .header-icons a, .header-icons button { font-size: 1.3rem; }
      .bottom-nav { padding: 10px 0; }
      .bottom-nav a { font-size: 1.3rem; }
      .mute-btn { width: 28px; height: 28px; font-size: 0.9rem; }
      .logo { font-size: 1.5rem; }
      .post { margin-bottom: 16px; }
      .user-info { padding: 10px 12px; }
      .username-link { font-size: 0.9rem; }
      .description { font-size: 0.85rem; padding: 10px 12px; }
      .post-actions { padding: 6px 12px; }
      .follow-btn { padding: 5px 12px; font-size: 0.8rem; }
      .date { padding: 6px 12px; }
      .comments-section { height: 250px; }
      .comment-form { padding: 10px 12px; }
      .comment-form textarea { font-size: 0.8rem; height: 36px; }
      .comment-form button { padding: 6px 12px; font-size: 0.8rem; }
    }
  </style>
</head>
<body data-username="{{ username }}" data-theme="light">
  <div class="main-container">
    <header class="main-header">
      <h2 class="logo">CHRONOS</h2>
      <nav class="header-icons">
        <a href="#" title="Accueil" id="home-btn"><i class="fa-solid fa-house"></i><span class="message-badge" style="display:none;"></span></a>
        <a href="{{ url_for('add_post') }}" title="Nouvelle publication"><i class="fa-solid fa-circle-plus"></i></a>
        <a href="{{ url_for('profile', username=username) }}" title="Profil"><i class="fa-regular fa-user"></i></a>
        <a href="{{ url_for('conversations') }}" title="Messages" id="messages-link">
          <i class="fa-regular fa-message"></i>
          <span class="message-badge" id="unread-count" style="display:none;">0</span>
        </a>
        <button id="theme-toggle" title="Changer de thème"><i class="fa-solid fa-moon"></i></button>
      </nav>
    </header>
    <div class="stories-container">
      <div class="stories-scroll">
        <!-- Own Story -->
        <div class="story-item">
          <div class="story-circle {% if own_stories %}has-story view-trigger{% else %}no-story add-story-trigger{% endif %}" data-username="{{ username }}">
            {% if avatar %}
            <img src="{{ url_for('avatar_file', filename=avatar) }}?t={{ 'now'|timestamp }}" alt="{{ username }}">
            {% else %}
            <div class="avatar-fallback">{{ username[:1]|upper }}</div>
            {% endif %}
            <div class="add-story {% if own_stories %}small add-story-trigger{% endif %}">+</div>
          </div>
          <p>Your Story</p>
        </div>
        <!-- Other Stories -->
        {% for user in other_stories_users %}
        <div class="story-item">
          <div class="story-circle has-story view-trigger" data-username="{{ user }}">
            {% if users[user].avatar %}
            <img src="{{ url_for('avatar_file', filename=users[user].avatar) }}?t={{ 'now'|timestamp }}" alt="{{ user }}">
            {% else %}
            <div class="avatar-fallback">{{ user[:1]|upper }}</div>
            {% endif %}
          </div>
          <p>{{ user }}</p>
        </div>
        {% endfor %}
      </div>
    </div>
    <main class="scroll-box" id="posts">
      {% for post in posts %}
      <div class="post" data-post-id="{{ post.id }}">
        <div class="user-info">
          {% if post.avatar %}
          <a class="avatar-link" href="{{ url_for('profile', username=post.username) }}">
            <img src="{{ url_for('avatar_file', filename=post.avatar) }}?t={{ 'now'|timestamp }}" alt="avatar" class="avatar-post" />
          </a>
          {% else %}
          <a class="avatar-link" href="{{ url_for('profile', username=post.username) }}">
            <div class="avatar-fallback">{{ post.username[:1]|upper }}</div>
          </a>
          {% endif %}
          <a class="username-link" href="{{ url_for('profile', username=post.username) }}">
            <p class="username">{{ post.username }}</p>
          </a>
        </div>
        <p class="description">{{ post.description }}</p>
        <span class="toggle-description">Afficher plus</span>
        {# ---- Single file ---- #}
        {% if post.type == "image" and not post.files %}
        <img src="{{ url_for('uploaded_file', filename=post.file) }}" alt="image" class="post-image" />
        {% elif post.type == "video" and not post.files %}
        <div class="video-container">
          <video src="{{ url_for('uploaded_file', filename=post.file) }}" muted loop class="post-video"></video>
          <button class="mute-btn" title="Activer/Désactiver le son">
            <i class="fa-solid fa-volume-xmark"></i>
          </button>
        </div>
        {% endif %}
        {# ---- Multiple files (carousel) ---- #}
        {% if post.files|length > 0 %}
        <div class="carousel">
          <div class="carousel-track">
            {% for file in post.files %}
            {% if file.type == "image" %}
            <img src="{{ url_for('uploaded_file', filename=file.name) }}" alt="image" class="post-image" />
            {% elif file.type == "video" %}
            <div class="video-container">
              <video src="{{ url_for('uploaded_file', filename=file.name) }}" muted loop class="post-video"></video>
              <button class="mute-btn" title="Activer/Désactiver le son">
                <i class="fa-solid fa-volume-xmark"></i>
              </button>
            </div>
            {% endif %}
            {% endfor %}
          </div>
          <div class="carousel-indicators">
            {% for file in post.files %}
            <span class="dot{% if loop.first %} active{% endif %}"></span>
            {% endfor %}
          </div>
        </div>
        {% endif %}
        <div class="post-actions">
          <button class="like-btn{% if post.liked_by_user %} liked{% endif %}">
            <i class="{% if post.liked_by_user %}fa-solid{% else %}fa-regular{% endif %} fa-heart"></i>
          </button>
          <span class="like-count">{{ post.likes if post.likes else 0 }}</span>
          <button class="comment-btn">
            <i class="fa-regular fa-comment"></i>
            <span class="comment-count">{{ post.comments_count if post.comments_count else 0 }}</span>
          </button>
          <button
            class="follow-btn{% if post.following %} following{% endif %}"
            data-following="{{ 'true' if post.following else 'false' }}"
          >
            {% if post.following %}
            Abonné ✔
            {% else %}
            <i class="fa-solid fa-plus"></i> Suivre
            {% endif %}
          </button>
        </div>
        <p class="date">Publié le {{ post.date }}</p>
        <section class="comments-section" id="comments-{{ post.id }}">
          <div class="comments-box" id="commentsBox-{{ post.id }}">
            {% if post.comments|length == 0 %}
              <p class="no-comments">Aucun commentaire pour l’instant.</p>
            {% else %}
              {% for comment in post.comments %}
              <div class="comment">
                {% if comment.avatar %}
                <a href="{{ url_for('profile', username=comment.username) }}">
                  <img src="{{ url_for('avatar_file', filename=comment.avatar) }}?t={{ 'now'|timestamp }}" alt="avatar" class="avatar-comment" />
                </a>
                {% else %}
                <a href="{{ url_for('profile', username=comment.username) }}">
                  <div class="avatar-fallback">{{ comment.username[:1]|upper }}</div>
                </a>
                {% endif %}
                <div class="comment-content">
                  <p><strong><a href="{{ url_for('profile', username=comment.username) }}">{{ comment.username }}</a></strong></p>
                  <p>{{ comment.content }}</p>
                  <small>{{ comment.date }}</small>
                </div>
              </div>
              {% endfor %}
            {% endif %}
          </div>
          <div class="comment-form">
            <form data-post-id="{{ post.id }}">
              <textarea name="comment" placeholder="Écrire un commentaire..." required></textarea>
              <button type="submit">Commenter</button>
            </form>
          </div>
        </section>
      </div>
      {% endfor %}
    </main>
    <nav class="bottom-nav">
      <a href="{{ url_for('notifications') }}" title="Notifications" id="notifications-link">
        <i class="fa-regular fa-bell"></i>
        <span class="message-badge" id="notifications-count" style="display:none;">0</span>
      </a>
      <a href="{{ url_for('search_users') }}" title="Rechercher"><i class="fa-solid fa-magnifying-glass"></i></a>
      <a href="{{ url_for('videos') }}" title="Vidéos"><i class="fa-solid fa-video"></i></a>
      <a href="{{ url_for('login') }}" title="Déconnexion" class="logout-btn"><i class="fa-solid fa-right-from-bracket"></i></a>
    </nav>
  </div>
  <input type="file" id="story-file-input" accept="image/*,video/*" multiple style="display:none;">
  <div id="story-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.9); z-index:2000; justify-content:center; align-items:center;">
    <div class="story-content" style="max-width:90%; max-height:90%; width:100%; height:100%; position:relative;"></div>
    <button id="close-story" style="position:absolute; top:20px; right:20px; background:none; border:none; color:white; font-size:2rem; cursor:pointer; z-index:20;">&times;</button>
  </div>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const currentUsername = document.body.dataset.username;
    const postsContainer = document.getElementById('posts');
    const videos = new Set();
    let currentVideo = null;
    const socket = io();
    let viewedPosts = new Set();
    const avatar = '{{ avatar }}';
    const avatarUrl = {% if avatar %}'{{ url_for("avatar_file", filename=avatar) }}' + '?t=' + Date.now() {% else %} '' {% endif %};
    const hasAvatar = {{ 'true' if avatar else 'false' }};

    // Theme toggle functionality
    const themeToggleBtn = document.getElementById('theme-toggle');
    const body = document.body;

    function setTheme(theme) {
      body.dataset.theme = theme;
      localStorage.setItem('theme', theme);
      const icon = themeToggleBtn.querySelector('i');
      icon.classList.toggle('fa-moon', theme === 'light');
      icon.classList.toggle('fa-sun', theme === 'dark');
    }

    // Load saved theme or default to light
    const savedTheme = localStorage.getItem('theme') || 'light';
    setTheme(savedTheme);

    if (themeToggleBtn) {
      themeToggleBtn.addEventListener('click', () => {
        const newTheme = body.dataset.theme === 'light' ? 'dark' : 'light';
        setTheme(newTheme);
      });
    }

    // --- Badge Management ---
    const msgBadge = document.getElementById("unread-count");
    const notifBadge = document.getElementById("notifications-count");
    const msgLink = document.getElementById("messages-link");
    const notifLink = document.getElementById("notifications-link");

    // Load badge counts from localStorage
    const savedMsgs = localStorage.getItem("unreadMsgs");
    const savedNotifs = localStorage.getItem("unreadNotifs");

    if (savedMsgs && parseInt(savedMsgs) > 0) {
      msgBadge.textContent = savedMsgs;
      msgBadge.style.display = "inline-block";
    }
    if (savedNotifs && parseInt(savedNotifs) > 0) {
      notifBadge.textContent = savedNotifs;
      notifBadge.style.display = "inline-block";
    }

    // Reset badges when clicking Messages link or visiting conversations/chat pages
    if (window.location.pathname.includes('/conversations') || window.location.pathname.includes('/chat/')) {
      localStorage.setItem("unreadMsgs", 0);
      msgBadge.style.display = "none";
      msgBadge.textContent = "0";
    }

    // Reset badges when clicking Notifications link or visiting notifications page
    if (window.location.pathname.includes('/notifications')) {
      localStorage.setItem("unreadNotifs", 0);
      notifBadge.style.display = "none";
      notifBadge.textContent = "0";
    }

    // Reset message badge on click
    msgLink.addEventListener("click", () => {
      localStorage.setItem("unreadMsgs", 0);
      msgBadge.style.display = "none";
      msgBadge.textContent = "0";
    });

    // Reset notification badge on click
    notifLink.addEventListener('click', () => {
      localStorage.setItem("unreadNotifs", 0);
      notifBadge.style.display = "none";
      notifBadge.textContent = "0";
    });

    if ('scrollRestoration' in history) history.scrollRestoration = 'manual';

    const homeBtn = document.getElementById('home-btn');
    const homeBadge = homeBtn.querySelector('.message-badge');
    let newPostsCount = 0;

    window.addEventListener('load', () => window.scrollTo(0, 0));

    window.addEventListener('pageshow', (event) => {
      if (event.persisted) {
        window.location.reload();
      }
    });

    homeBtn.addEventListener('click', e => {
      e.preventDefault();
      location.reload();
    });

    // --- Handle Back Button ---
    window.addEventListener('popstate', () => {
      document.querySelectorAll('.comments-section.open').forEach(section => {
        section.classList.remove('open');
      });
    });

    async function toggleLike(button) {
      const post = button.closest('.post');
      const postId = post.dataset.postId;
      const countEl = post.querySelector('.like-count');
      try {
        const res = await fetch(`/like/${postId}`, { method: 'POST', credentials: 'same-origin' });
        if (!res.ok) return;
        const data = await res.json();
        countEl.textContent = data.likes;
        button.classList.toggle('liked', data.liked);
        const icon = button.querySelector('i');
        icon.classList.toggle('fa-solid', data.liked);
        icon.classList.toggle('fa-regular', !data.liked);
        socket.emit('like_updated', { post_id: parseInt(postId), likes: data.likes, liked: data.liked });
      } catch (err) { console.error(err); }
    }

    function bindLikes(post) {
      const btn = post.querySelector('.like-btn');
      if (!btn) return;
      btn.addEventListener('click', () => toggleLike(btn));
      const icon = btn.querySelector('i');
      const isLiked = btn.classList.contains('liked');
      icon.classList.toggle('fa-solid', isLiked);
      icon.classList.toggle('fa-regular', !isLiked);
    }

    function bindFollowButtons(post) {
      const btn = post.querySelector('.follow-btn');
      if (!btn) return;
      const postUsername = post.querySelector('.username').textContent.trim();

      function updateButton(button, isFollowing) {
        if (isFollowing) {
          button.dataset.following = "true";
          button.classList.add('following');
          button.innerHTML = 'Abonné ✔';
          button.disabled = true;
        } else {
          button.dataset.following = "false";
          button.classList.remove('following');
          button.innerHTML = '<i class="fa-solid fa-plus"></i> Suivre';
          button.disabled = false;
        }
      }

      if (!window.followingUsers) window.followingUsers = new Set();
      if (window.followingUsers.has(postUsername)) updateButton(btn, true);
      else updateButton(btn, btn.dataset.following === "true");

      btn.addEventListener('click', async () => {
        if (btn.dataset.following === "true") return;
        try {
          const res = await fetch(`/follow/${encodeURIComponent(postUsername)}`, { method: 'POST', credentials: 'same-origin' });
          if (!res.ok) throw new Error('Erreur serveur');
          const data = await res.json();
          if (data.following) {
            window.followingUsers.add(postUsername);
            document.querySelectorAll('.post').forEach(p => {
              const usernameEl = p.querySelector('.username');
              const followBtn = p.querySelector('.follow-btn');
              if (usernameEl && followBtn && usernameEl.textContent.trim() === postUsername) {
                updateButton(followBtn, true);
              }
            });
          } else {
            window.followingUsers.delete(postUsername);
            updateButton(btn, false);
          }
        } catch (e) {
          console.error(e);
          alert('Impossible de suivre pour le moment.');
        }
      });
    }

    function applyFollowStateToNewPosts(newPosts) {
      newPosts.forEach(post => {
        const usernameEl = post.querySelector('.username');
        if (!usernameEl) return;
        const postUsername = usernameEl.textContent.trim();
        const followBtn = post.querySelector('.follow-btn');
        if (!followBtn) return;
        if (window.followingUsers && window.followingUsers.has(postUsername)) {
          followBtn.dataset.following = "true";
          followBtn.classList.add('following');
          followBtn.innerHTML = 'Abonné ✔';
          followBtn.disabled = true;
        } else {
          followBtn.dataset.following = "false";
          followBtn.classList.remove('following');
          followBtn.innerHTML = '<i class="fa-solid fa-plus"></i> Suivre';
          followBtn.disabled = false;
        }
        bindFollowButtons(post);
      });
    }

    /* ---------- Video autoplay and loop ---------- */
    const ioObserver = new IntersectionObserver((entries) => {
      let best = null;
      entries.forEach(entry => {
        const vid = entry.target;
        const visible = entry.isIntersecting && entry.intersectionRatio >= 0.6;
        if (visible && !best) best = vid;
        if (!visible && !vid.paused) vid.pause();
      });
      if (best && currentVideo !== best) {
        if (currentVideo) currentVideo.pause();
        currentVideo = best;
        currentVideo.play().catch(() => {});
      }
    }, { threshold: [0, 0.25, 0.5, 0.75, 1] });

    function observeVideo(vid) {
      if (!videos.has(vid)) {
        videos.add(vid);
        ioObserver.observe(vid);
        vid.pause();
        vid.addEventListener('ended', () => {
          vid.currentTime = 0;
          vid.play().catch(() => {});
        });
        vid.addEventListener('click', (e) => {
          if (e.target.classList.contains('mute-btn') || e.target.closest('.mute-btn')) return;
          if (vid.paused) {
            vid.play().catch(() => {});
          } else {
            vid.pause();
          }
        });
      }
    }

    /* ---------- Mute button functionality ---------- */
    function bindMuteButton(video, muteBtn) {
      if (!muteBtn) return;
      muteBtn.addEventListener('click', () => {
        video.muted = !video.muted;
        const icon = muteBtn.querySelector('i');
        icon.classList.toggle('fa-volume-xmark', video.muted);
        icon.classList.toggle('fa-volume-high', !video.muted);
      });
    }

    /* ---------- Comment Form Submission --- */
    function bindCommentForm(post) {
      const form = post.querySelector('.comment-form form');
      if (!form) return;
      const textarea = form.querySelector('textarea');
      const submitButton = form.querySelector('button');
      const postId = form.dataset.postId;
      const commentsBox = post.querySelector('#commentsBox-' + postId);

      form.addEventListener('submit', e => {
        e.preventDefault();
        let content = textarea.value.trim();
        if (!content) return;
        textarea.value = '';
        submitButton.disabled = true;
        fetch(`/comments/${postId}`, {
          method: 'POST',
          credentials: 'same-origin',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: `comment=${encodeURIComponent(content)}`
        }).then(res => {
          if (res.ok) {
            return res.json().then(data => {
              const commentId = data.comment_id;
              const commentDiv = document.createElement('div');
              commentDiv.className = 'comment';
              commentDiv.dataset.commentId = commentId;
              const avatarHtml = data.avatar
                ? `<a href="/profile/${encodeURIComponent(currentUsername)}"><img src="/avatars/${encodeURIComponent(data.avatar)}?t=${Date.now()}" alt="avatar" class="avatar-comment" /></a>`
                : `<a href="/profile/${encodeURIComponent(currentUsername)}"><div class="avatar-fallback">${currentUsername[0].toUpperCase()}</div></a>`;
              commentDiv.innerHTML = `
                ${avatarHtml}
                <div class="comment-content">
                  <p><strong><a href="/profile/${encodeURIComponent(currentUsername)}">${currentUsername}</a></strong></p>
                  <p>${content}</p>
                  <small>${new Date().toLocaleString('fr-FR', { dateStyle: 'short', timeStyle: 'short' })}</small>
                </div>
              `;
              const noComments = commentsBox.querySelector('.no-comments');
              if (noComments) noComments.remove();
              commentsBox.appendChild(commentDiv);
              commentsBox.scrollTop = commentsBox.scrollHeight;
              textarea.focus();
              const countEl = post.querySelector('.comment-count');
              countEl.textContent = parseInt(countEl.textContent || "0") + 1;
              socket.emit('send_comment', { post_id: parseInt(postId), comment_id: commentId, username: currentUsername, content, avatar: data.avatar });
            });
          } else {
            textarea.value = content;
          }
        }).catch(err => {
          console.error(err);
          textarea.value = content;
        }).finally(() => {
          submitButton.disabled = false;
        });
      });

      textarea.addEventListener('input', () => {
        submitButton.disabled = !textarea.value.trim();
      });
    }

    /* ---------- Comments Toggle --- */
    function bindCommentToggle(post) {
      const btn = post.querySelector('.comment-btn');
      const commentsSection = post.querySelector('.comments-section');
      if (!btn || !commentsSection) return;
      btn.addEventListener('click', () => {
        const isOpen = commentsSection.classList.contains('open');
        if (!isOpen) {
          commentsSection.classList.add('open');
          const commentsBox = commentsSection.querySelector('.comments-box');
          commentsBox.scrollTop = 0;
          history.pushState({ commentsOpen: true, postId: post.dataset.postId }, '', window.location.href);
        } else {
          commentsSection.classList.remove('open');
          history.back();
        }
        if (currentVideo) currentVideo.pause();
      });
    }

    /* ---------- Post View Observer --- */
    const postObserver = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting && entry.intersectionRatio >= 0.5) {
          const postId = entry.target.dataset.postId;
          if (!viewedPosts.has(postId)) {
            socket.emit('view_post', { post_id: parseInt(postId) });
            viewedPosts.add(postId);
          }
        }
      });
    }, { threshold: 0.5 });

    /* ---------- Init posts existants ---------- */
    document.querySelectorAll('.post').forEach(post => {
      bindLikes(post);
      bindFollowButtons(post);
      bindCommentForm(post);
      bindCommentToggle(post);
      postObserver.observe(post);
      post.querySelectorAll('video').forEach(video => {
        observeVideo(video);
        const muteBtn = video.parentElement.querySelector('.mute-btn');
        bindMuteButton(video, muteBtn);
      });
      const description = post.querySelector('.description');
      const toggleButton = post.querySelector('.toggle-description');
      if (description && toggleButton) {
        if (description.scrollHeight > description.clientHeight) {
          description.classList.add('long');
        }
        toggleButton.addEventListener('click', () => {
          if (description.classList.contains('expanded')) {
            description.classList.remove('expanded');
            toggleButton.textContent = 'Afficher plus';
          } else {
            description.classList.add('expanded');
            toggleButton.textContent = 'Afficher moins';
          }
        });
      }
    });
    document.querySelectorAll('.post img').forEach(img => {
      img.addEventListener('click', () => { if (currentVideo) currentVideo.pause(); });
    });

    /* ---------- Socket.IO ---------- */
    socket.on('like_updated', data => {
      const post = document.querySelector(`.post[data-post-id="${data.post_id}"]`);
      if (post) {
        const countEl = post.querySelector('.like-count');
        if (countEl) countEl.textContent = data.likes;
        const btn = post.querySelector('.like-btn');
        if (btn) btn.classList.toggle('liked', data.liked);
        const icon = btn.querySelector('i');
        icon.classList.toggle('fa-solid', data.liked);
        icon.classList.toggle('fa-regular', !data.liked);
      }
    });

    socket.on('new_comment', data => {
      const post = document.querySelector(`.post[data-post-id="${data.post_id}"]`);
      if (!post) return;
      const commentsBox = post.querySelector('#commentsBox-' + data.post_id);
      if (!commentsBox) return;

      const existingComment = commentsBox.querySelector(`.comment[data-comment-id="${data.comment_id}"]`);
      if (!existingComment) {
        const commentDiv = document.createElement('div');
        commentDiv.className = 'comment';
        commentDiv.dataset.commentId = data.comment_id;
        const avatarHtml = data.avatar
          ? `<a href="/profile/${encodeURIComponent(data.username)}"><img src="/avatars/${encodeURIComponent(data.avatar)}?t=${Date.now()}" alt="avatar" class="avatar-comment" /></a>`
          : `<a href="/profile/${encodeURIComponent(data.username)}"><div class="avatar-fallback">${data.username[0].toUpperCase()}</div></a>`;
        commentDiv.innerHTML = `
          ${avatarHtml}
          <div class="comment-content">
            <p><strong><a href="/profile/${encodeURIComponent(data.username)}">${data.username}</a></strong></p>
            <p>${data.content}</p>
            <small>${new Date().toLocaleString('fr-FR', { dateStyle: 'short', timeStyle: 'short' })}</small>
          </div>
        `;
        const noComments = commentsBox.querySelector('.no-comments');
        if (noComments) noComments.remove();
        commentsBox.appendChild(commentDiv);
        if (commentsBox.parentElement.classList.contains('open')) {
          commentsBox.scrollTop = commentsBox.scrollHeight;
        }
        const countEl = post.querySelector('.comment-count');
        countEl.textContent = parseInt(countEl.textContent || "0") + 1;
      }
    });

    /* ---------- Nouveau post badge Accueil ---------- */
    socket.on('new_post', postHtml => {
      newPostsCount++;
      homeBadge.style.display = 'inline';
      homeBadge.textContent = newPostsCount;
    });

    /* ---------- Socket.IO Badge Handlers ---------- */
    socket.on('new_message', (message) => {
      const currentChatUser = window.location.pathname.includes('/chat/') ? window.location.pathname.split('/chat/')[1] : null;
      if (!currentChatUser || currentChatUser !== message.sender) {
        let count = parseInt(localStorage.getItem("unreadMsgs") || "0") + 1;
        localStorage.setItem("unreadMsgs", count);
        msgBadge.textContent = count;
        msgBadge.style.display = "inline-block";
      }
    });

    socket.on('new_notification', (notification) => {
      if (!window.location.pathname.includes('/notifications')) {
        let count = parseInt(localStorage.getItem("unreadNotifs") || "0") + 1;
        localStorage.setItem("unreadNotifs", count);
        notifBadge.textContent = count;
        notifBadge.style.display = "inline-block";
      }
    });

    /* ---------- Carousel Initialization ---------- */
    function initCarousel(post) {
      const track = post.querySelector('.carousel-track');
      const dots = post.querySelectorAll('.carousel-indicators .dot');
      if (!track || dots.length === 0) return;

      Array.from(track.children).forEach(child => {
        child.style.width = '100%';
        child.style.flex = '0 0 100%';
      });

      track.style.overflowX = 'auto';
      track.style.scrollSnapType = 'x mandatory';

      track.addEventListener('scroll', () => {
        const index = Math.round(track.scrollLeft / track.offsetWidth);
        dots.forEach((dot, i) => dot.classList.toggle('active', i === index));
      });

      dots.forEach((dot, index) => {
        dot.addEventListener('click', () => {
          track.scrollTo({
            left: index * track.offsetWidth,
            behavior: 'smooth'
          });
        });
      });
    }

    document.querySelectorAll('.post').forEach(post => initCarousel(post));

    /* ---------- Stories Functionality ---------- */
    const addTriggers = document.querySelectorAll('.add-story-trigger');
    addTriggers.forEach(trigger => {
      trigger.addEventListener('click', () => {
        document.getElementById('story-file-input').click();
      });
    });

    const viewTriggers = document.querySelectorAll('.view-trigger');
    viewTriggers.forEach(trigger => {
      trigger.addEventListener('click', storyClickHandler);
    });

    const fileInput = document.getElementById('story-file-input');
    fileInput.addEventListener('change', async (e) => {
      const files = e.target.files;
      if (files.length === 0) return;
      const formData = new FormData();
      for (let file of files) {
        formData.append('file', file);
      }
      try {
        const res = await fetch('/add_story', { method: 'POST', body: formData });
        if (res.ok) {
          location.reload();
        }
      } catch (err) { console.error(err); }
    });

    let touchStartTime, touchStartX, touchTimer, isPaused = false, currentIndex = 0, stories = [], timerId, startTime, duration, isOwnStory = false, viewedStories = new Set();

    function storyClickHandler(e) {
      e.preventDefault();
      const modal = document.getElementById('story-modal');
      const content = modal.querySelector('.story-content');
      content.innerHTML = '';
      const username = e.currentTarget.dataset.username;
      fetch(`/get_stories/${username}`)
      .then(res => res.json())
      .then(data => {
        stories = data.stories;
        isOwnStory = data.is_own;
        if (stories.length === 0) return;
        let html = `
          <div class="story-progress">
            ${stories.map(() => '<div class="progress-bar"><div class="progress-fill"></div></div>').join('')}
          </div>
          <div class="story-carousel">
            <div class="story-track">
              ${stories.map(s => {
                if (s.type === 'image') return `<div class="story-slide"><img src="${s.media_url}"></div>`;
                else return `<div class="story-slide"><video src="${s.media_url}" playsinline></video></div>`;
              }).join('')}
            </div>
          </div>
          <div class="tap-left"></div>
          <div class="tap-right"></div>
        `;
        if (isOwnStory) {
          html += `
            <div id="viewer-count" style="display:none;">
              <i class="fa-solid fa-eye"></i>
              <span>0</span>
            </div>
            <div id="viewer-modal" style="display:none;">
              <div id="viewer-list"></div>
            </div>
          `;
        }
        content.innerHTML = html;
        modal.style.display = 'flex';
        const track = content.querySelector('.story-track');
        const slides = track.children;
        const progressBars = content.querySelectorAll('.progress-bar');
        const fills = content.querySelectorAll('.progress-fill');
        const leftTap = content.querySelector('.tap-left');
        const rightTap = content.querySelector('.tap-right');
        const viewerCountEl = content.querySelector('#viewer-count');
        const viewerModal = content.querySelector('#viewer-modal');
        const viewerList = content.querySelector('#viewer-list');

        if (isOwnStory && viewerCountEl) {
          viewerCountEl.style.display = 'flex';
          viewerModal.classList.toggle('dark', body.dataset.theme === 'dark');
          viewerCountEl.addEventListener('click', () => {
            viewerModal.style.display = viewerModal.style.display === 'block' ? 'none' : 'block';
          });
          modal.addEventListener('click', e => {
            if (!viewerModal.contains(e.target) && !viewerCountEl.contains(e.target)) {
              viewerModal.style.display = 'none';
            }
          });
        }

        function updateViewerInfo(index) {
          if (!isOwnStory) return;
          const count = stories[index].viewer_count || 0;
          viewerCountEl.querySelector('span').textContent = count;
          viewerList.innerHTML = '';
          const viewers = stories[index].viewers || [];
          viewers.forEach(v => {
            const item = document.createElement('div');
            item.className = 'viewer-item';
            const avatarHtml = v.avatar
              ? `<img src="/avatars/${v.avatar}?t=${Date.now()}" alt="${v.username}" class="viewer-avatar">`
              : `<div class="avatar-fallback viewer-avatar">${v.username[0].toUpperCase()}</div>`;
            const avatarA = `<a href="/profile/${encodeURIComponent(v.username)}">${avatarHtml}</a>`;
            const usernameA = `<a href="/profile/${encodeURIComponent(v.username)}" class="viewer-username">${v.username}</a>`;
            item.innerHTML = `
              ${avatarA}
              ${usernameA}
            `;
            viewerList.appendChild(item);
          });
        }

        function goTo(index) {
          if (index < 0 || index >= slides.length) return;
          pauseStory();
          for (let i = 0; i < index; i++) {
            fills[i].style.width = '100%';
          }
          for (let i = index + 1; i < slides.length; i++) {
            fills[i].style.width = '0%';
          }
          fills[index].style.width = '0%';
          track.scrollLeft = index * track.offsetWidth;
          currentIndex = index;
          if (!isOwnStory && !viewedStories.has(stories[index].id)) {
            fetch(`/view_story/${stories[index].id}`, { method: 'POST' })
              .then(res => {
                if (res.ok) viewedStories.add(stories[index].id);
              })
              .catch(err => console.error(err));
          }
          updateViewerInfo(index);
          startStory();
        }

        function startStory() {
          isPaused = false;
          const slide = slides[currentIndex];
          const media = slide.querySelector('img, video');
          startTime = Date.now();
          if (media.tagName === 'VIDEO') {
            media.currentTime = 0;
            media.play();
            duration = media.duration * 1000;
            media.ontimeupdate = () => {
              if (isPaused) return;
              const perc = (media.currentTime / media.duration) * 100;
              fills[currentIndex].style.width = perc + '%';
            };
            media.onended = nextStory;
          } else {
            duration = 5000;
            requestAnimationFrame(updateProgress);
            timerId = setTimeout(nextStory, duration);
          }
        }

        function updateProgress() {
          if (isPaused) return;
          const elapsed = Date.now() - startTime;
          const perc = Math.min((elapsed / duration) * 100, 100);
          fills[currentIndex].style.width = perc + '%';
          if (perc < 100) {
            requestAnimationFrame(updateProgress);
          } else {
            nextStory();
          }
        }

        function pauseStory() {
          isPaused = true;
          const slide = slides[currentIndex];
          const media = slide.querySelector('video');
          if (media) media.pause();
          clearTimeout(timerId);
        }

        function resumeStory() {
          isPaused = false;
          const slide = slides[currentIndex];
          const media = slide.querySelector('video');
          if (media) media.play();
          else requestAnimationFrame(updateProgress);
        }

        function nextStory() {
          if (currentIndex < stories.length - 1) {
            goTo(currentIndex + 1);
          } else {
            closeModal();
          }
        }

        function prevStory() {
          if (currentIndex > 0) {
            goTo(currentIndex - 1);
          }
        }

        leftTap.addEventListener('click', prevStory);
        rightTap.addEventListener('click', nextStory);

        let isHold = false;
        modal.addEventListener('touchstart', e => {
          if (e.target.closest('#close-story') || e.target.closest('#viewer-count') || e.target.closest('#viewer-modal')) return;
          touchStartX = e.touches[0].clientX;
          touchStartTime = Date.now();
          touchTimer = setTimeout(() => {
            isHold = true;
            pauseStory();
          }, 250);
        });

        modal.addEventListener('touchend', e => {
          clearTimeout(touchTimer);
          const dur = Date.now() - touchStartTime;
          const dx = e.changedTouches[0].clientX - touchStartX;
          if (Math.abs(dx) > 50) return; // swipe ignore
          if (dur < 250) {
            if (touchStartX < window.innerWidth / 2) prevStory();
            else nextStory();
          } else if (isHold) {
            isHold = false;
            resumeStory();
          }
        });

        modal.addEventListener('mousedown', e => {
          if (e.target.closest('#close-story') || e.target.closest('#viewer-count') || e.target.closest('#viewer-modal')) return;
          touchStartX = e.clientX;
          touchStartTime = Date.now();
          touchTimer = setTimeout(() => {
            isHold = true;
            pauseStory();
          }, 250);
        });

        modal.addEventListener('mouseup', e => {
          clearTimeout(touchTimer);
          const dur = Date.now() - touchStartTime;
          const dx = e.clientX - touchStartX;
          if (Math.abs(dx) > 50) return;
          if (dur < 250) {
            if (touchStartX < window.innerWidth / 2) prevStory();
            else nextStory();
          } else if (isHold) {
            isHold = false;
            resumeStory();
          }
        });

        goTo(0);
      })
      .catch(err => console.error(err));
    }

    function closeModal() {
      const modal = document.getElementById('story-modal');
      modal.style.display = 'none';
      const content = modal.querySelector('.story-content');
      content.innerHTML = '';
      stories = [];
      currentIndex = 0;
      isPaused = false;
      isOwnStory = false;
      viewedStories.clear();
    }

    const closeStory = document.getElementById('close-story');
    closeStory.addEventListener('click', closeModal);

    const storyModal = document.getElementById('story-modal');
    storyModal.addEventListener('click', e => {
      if (e.target === storyModal) {
        closeModal();
      }
    });

  });
</script>
</body>
</html>
