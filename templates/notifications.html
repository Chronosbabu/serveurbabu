<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Notifications</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<style>
:root {
  --bg-color: #f0f2f5;
  --text-color: #262626;
  --border-color: #dbdbdb;
  --card-bg: #fff;
  --link-hover: #0095f6;
  --shadow-color: rgba(0,0,0,0.1);
  --notification-bg: #fff;
}

[data-theme="dark"] {
  --bg-color: #1a1a1a;
  --text-color: #e0e0e0;
  --border-color: #333;
  --card-bg: #262626;
  --link-hover: #4dabf7;
  --shadow-color: rgba(0,0,0,0.3);
  --notification-bg: #262626;
}

body { 
  font-family: Arial; 
  background: var(--bg-color); 
  color: var(--text-color);
  margin:0; 
}
.container { 
  max-width:600px; 
  margin:0 auto; 
  padding:20px; 
}
h2 { 
  text-align:center; 
  color: var(--text-color);
}
.scroll-box {
  max-height: 500px;
  overflow-y: auto;
  background: var(--notification-bg);
  padding:10px;
  border-radius:10px;
  box-shadow:0 2px 8px var(--shadow-color);
}
.notification-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding:12px 16px;
  border-bottom:1px solid var(--border-color);
  font-size:0.95rem;
  transition: background 0.2s ease;
}
.notification-item:hover {
  background: var(--border-color);
}
.notification-item:last-child { border-bottom:none; }
.notification-avatar, .avatar-fallback {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  object-fit: cover;
}
.avatar-fallback {
  background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  font-size: 1rem;
  color: #fff;
}
.notification-message {
  flex: 1;
  color: var(--text-color);
}
.notification-message a {
  color: var(--link-hover);
  font-weight: 600;
}
.notification-message a:hover {
  text-decoration: underline;
}
#theme-toggle {
  position: absolute;
  top: 20px;
  right: 20px;
  background: none;
  border: none;
  color: var(--text-color);
  font-size: 1.5rem;
  cursor: pointer;
  transition: color 0.2s ease, transform 0.2s ease;
}
#theme-toggle:hover {
  color: var(--link-hover);
  transform: scale(1.1);
}
</style>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body data-theme="light">
<div class="container">
    <h2>Notifications<button id="theme-toggle" title="Changer de thème"><i class="fa-solid fa-moon"></i></button></h2>
    <div class="scroll-box" id="notifications-list">
        {% for notif in notifications %}
        <div class="notification-item">
          {% if notif.avatar %}
          <img src="{{ notif.avatar }}" alt="{{ notif.sender }}" class="notification-avatar">
          {% else %}
          <div class="avatar-fallback">{{ notif.sender[0]|upper }}</div>
          {% endif %}
          <span class="notification-message">
            <a href="{{ url_for('profile', username=notif.sender) }}">{{ notif.sender }}</a> 
            {% if notif.type == 'like' or notif.type == 'comment' %}
              a {{ 'aimé' if notif.type == 'like' else 'commenté' }} votre publication.
            {% else %}
              {{ notif.message }}
            {% endif %}
          </span>
        </div>
        {% endfor %}
    </div>
</div>

<script>
const socket = io();
const userId = {{ session["user_id"]|tojson }};
socket.emit("join", { user_id: userId });

// Theme toggle functionality
const themeToggleBtn = document.getElementById('theme-toggle');
const body = document.body;

function setTheme(theme) {
  body.dataset.theme = theme;
  localStorage.setItem('theme', theme);
  const icon = themeToggleBtn.querySelector('i');
  icon.classList.toggle('fa-moon', theme === 'light');
  icon.classList.toggle('fa-sun', theme === 'dark');
}

// Load saved theme or default to light
const savedTheme = localStorage.getItem('theme') || 'light';
setTheme(savedTheme);

if (themeToggleBtn) {
  themeToggleBtn.addEventListener('click', () => {
    const newTheme = body.dataset.theme === 'light' ? 'dark' : 'light';
    setTheme(newTheme);
  });
}

// Réception des nouvelles notifications
socket.on("new_notification", data => {
    const list = document.getElementById("notifications-list");
    if(list){
        const div = document.createElement("div");
        div.className = "notification-item";
        const avatarImg = data.avatar ? `<img src="${data.avatar}" alt="${data.sender}" class="notification-avatar">` : `<div class="avatar-fallback">${data.sender[0].toUpperCase()}</div>`;
        const message = data.type === 'like' ? `a aimé votre publication.` : 
                        data.type === 'comment' ? `a commenté votre publication.` : 
                        data.type === 'follow' ? `a commencé à vous suivre.` : data.message;
        div.innerHTML = `${avatarImg}<span class="notification-message"><a href="/profile/${data.sender}">${data.sender}</a> ${message}</span>`;
        list.prepend(div);
    }
});
</script>
</body>
</html>
