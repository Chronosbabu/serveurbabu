<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no">
  <title>Conversations</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    /* ---------- GLOBAL ---------- */
    :root {
      --bg-color: #fafafa;
      --text-color: #262626;
      --border-color: #dbdbdb;
      --card-bg: #fff;
      --link-hover: #0095f6;
      --shadow-color: rgba(0,0,0,0.05);
      --badge-bg: #ed4956;
      --badge-border: #fff;
      --empty-text-color: #8e8e8e;
      --status-color: #8e8e8e;
      --read-color: #4caf50;
    }

    [data-theme="dark"] {
      --bg-color: #1a1a1a;
      --text-color: #e0e0e0;
      --border-color: #333;
      --card-bg: #262626;
      --link-hover: #4dabf7;
      --shadow-color: rgba(0,0,0,0.3);
      --badge-bg: #ff6b6b;
      --badge-border: #262626;
      --empty-text-color: #6b7280;
      --status-color: #6b7280;
      --read-color: #66bb6a;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body {
      height: 100%;
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      line-height: 1.5;
      overflow: hidden; /* Prevent body scrolling */
      -webkit-text-size-adjust: 100% !important; /* Prevent zoom text scaling */
      transform: scale(1) !important; /* Prevent scaling */
    }
    a { text-decoration: none; color: inherit; }
    .main-container { 
      max-width: 935px; 
      margin: 0 auto; 
      height: 100%;
      display: flex;
      flex-direction: column;
      padding: 0 20px 80px 20px;
    }

    /* ---------- HEADER ---------- */
    .main-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 20px;
      background: var(--card-bg);
      border-bottom: 1px solid var(--border-color);
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      box-shadow: 0 1px 2px var(--shadow-color);
    }
    .logo {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--text-color);
      font-family: 'Lobster', cursive;
      letter-spacing: 1px;
      flex-shrink: 0;
    }
    .header-icons {
      display: flex;
      align-items: center;
      gap: 24px;
      flex-wrap: nowrap;
    }
    .header-icons a {
      color: var(--text-color);
      font-size: 1.5rem;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: color 0.2s ease, transform 0.2s ease;
      position: relative;
      background: none;
      border: none;
      cursor: pointer;
      transform: scale(1) !important;
    }
    .header-icons a:hover {
      color: var(--link-hover);
      transform: scale(1.1) !important;
    }
    .header-icons a.active {
      color: var(--link-hover);
    }
    .message-badge {
      position: absolute;
      top: -8px;
      right: -8px;
      background: var(--badge-bg);
      color: #fff;
      font-size: 0.7rem;
      font-weight: 600;
      padding: 3px 6px;
      border-radius: 50%;
      line-height: 1;
      border: 2px solid var(--badge-border);
      transform: scale(1) !important;
    }

    /* ---------- BOTTOM NAVIGATION BAR ---------- */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: var(--card-bg);
      border-top: 1px solid var(--border-color);
      display: flex;
      justify-content: space-around;
      align-items: center;
      padding: 12px 0;
      z-index: 1000;
      box-shadow: 0 -1px 2px var(--shadow-color);
    }
    .bottom-nav a {
      color: var(--text-color);
      font-size: 1.5rem;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: color 0.2s ease, transform 0.2s ease;
      transform: scale(1) !important;
    }
    .bottom-nav a:hover {
      color: var(--link-hover);
      transform: scale(1.1) !important;
    }
    .bottom-nav a.active {
      color: var(--link-hover);
    }

    /* ---------- CONVERSATION LIST ---------- */
    .conversation-list {
      flex: 1;
      max-width: 935px;
      width: 100%;
      margin: 76px 0 80px 0; /* Adjust for fixed header and bottom nav */
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      box-shadow: 0 2px 8px var(--shadow-color);
      transform: scale(1) !important;
    }
    .conversation-list::-webkit-scrollbar { width: 6px; }
    .conversation-list::-webkit-scrollbar-thumb { background: var(--shadow-color); border-radius: 3px; }

    /* ---------- CONVERSATION ITEM ---------- */
    .conversation {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      transform: scale(1) !important;
    }
    .conversation:last-child { border-bottom: none; }
    .conversation:hover {
      transform: translateY(-2px) !important;
      box-shadow: 0 2px 8px var(--shadow-color);
    }
    .conversation.unread .conversation-info h4,
    .conversation.unread .conversation-info p {
      font-weight: 600;
      color: var(--link-hover);
    }

    /* ---------- PROFILE PIC ---------- */
    .profile-pic {
      flex-shrink: 0;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);
      margin-right: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 1.1rem;
      color: #fff;
      border: 2px solid var(--card-bg);
      box-shadow: 0 0 0 1px var(--shadow-color);
      transition: transform 0.2s ease;
      transform: scale(1) !important;
    }
    .conversation:hover .profile-pic { transform: scale(1.05) !important; }
    .profile-pic img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      transform: scale(1) !important;
    }

    /* ---------- ONLINE INDICATOR ---------- */
    .online-indicator {
      position: absolute;
      bottom: 2px;
      right: 2px;
      width: 12px;
      height: 12px;
      background: #4CAF50;
      border: 2px solid var(--card-bg);
      border-radius: 50%;
      display: none;
      transform: scale(1) !important;
    }
    .profile-wrapper {
      position: relative;
      display: inline-block;
    }

    /* ---------- CONVERSATION INFOS ---------- */
    .conversation-info {
      flex: 1;
      min-width: 0;
    }
    .conversation-info h4 {
      margin: 0;
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--text-color);
      text-overflow: ellipsis;
      overflow: hidden;
      white-space: nowrap;
      transition: color 0.2s ease;
      transform: scale(1) !important;
      -webkit-text-size-adjust: 100% !important;
    }
    .conversation-info p {
      margin-top: 4px;
      color: var(--empty-text-color);
      font-size: 0.85rem;
      text-overflow: ellipsis;
      overflow: hidden;
      white-space: nowrap;
      display: flex;
      align-items: center;
      transform: scale(1) !important;
      -webkit-text-size-adjust: 100% !important;
    }
    .status-indicator {
      font-size: 0.8rem;
      color: var(--status-color);
      margin-left: 5px;
      transform: scale(1) !important;
    }
    .status-indicator.read {
      color: var(--read-color);
    }

    /* ---------- LAST MESSAGE TIME + BADGE ---------- */
    .right-side {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      justify-content: center;
      margin-left: 12px;
    }
    .time {
      font-size: 0.75rem;
      color: var(--empty-text-color);
      margin-bottom: 6px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      transform: scale(1) !important;
      -webkit-text-size-adjust: 100% !important;
    }
    .unread-badge {
      background: var(--badge-bg);
      color: #fff;
      font-size: 0.7rem;
      font-weight: 600;
      padding: 3px 6px;
      border-radius: 50%;
      min-width: 20px;
      text-align: center;
      line-height: 1;
      border: 2px solid var(--badge-border);
      display: none;
      transform: scale(1) !important;
    }

    /* ---------- EMPTY STATE ---------- */
    .empty {
      text-align: center;
      padding: 40px 20px;
      color: var(--empty-text-color);
      font-size: 0.9rem;
      font-weight: 500;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      margin: 20px 0;
      box-shadow: 0 2px 8px var(--shadow-color);
      transform: scale(1) !important;
      -webkit-text-size-adjust: 100% !important;
    }
    .empty i {
      font-size: 1.5rem;
      color: var(--link-hover);
      margin-bottom: 8px;
      transform: scale(1) !important;
    }

    /* ---------- RESPONSIVE ---------- */
    @media (max-width: 600px) {
      .main-container { padding: 0 16px 70px 16px; }
      .main-header { padding: 10px 16px; }
      .conversation-list { 
        margin: 66px 0 70px 0; /* Adjust for smaller header and nav */
        border-radius: 8px;
      }
      .conversation { padding: 10px 12px; }
      .profile-pic { 
        width: 36px; 
        height: 36px; 
        font-size: 0.9rem; 
        transform: scale(1) !important;
      }
      .conversation-info h4 { 
        font-size: 0.9rem; 
        transform: scale(1) !important;
        -webkit-text-size-adjust: 100% !important;
      }
      .conversation-info p { 
        font-size: 0.8rem; 
        transform: scale(1) !important;
        -webkit-text-size-adjust: 100% !important;
      }
      .time { 
        font-size: 0.7rem; 
        transform: scale(1) !important;
        -webkit-text-size-adjust: 100% !important;
      }
      .unread-badge { 
        font-size: 0.65rem; 
        padding: 2px 5px; 
        min-width: 18px; 
        transform: scale(1) !important;
      }
      .header-icons { gap: 16px; }
      .header-icons a { 
        font-size: 1.3rem; 
        width: 36px; 
        height: 36px; 
        transform: scale(1) !important;
      }
      .bottom-nav { padding: 10px 0; }
      .bottom-nav a { 
        font-size: 1.3rem; 
        width: 36px; 
        height: 36px; 
        transform: scale(1) !important;
      }
      .logo { font-size: 1.5rem; }
      .empty { 
        font-size: 0.85rem; 
        padding: 30px 16px; 
        transform: scale(1) !important;
        -webkit-text-size-adjust: 100% !important;
      }
      .empty i { 
        font-size: 1.3rem; 
        transform: scale(1) !important;
      }
      .online-indicator { 
        width: 10px; 
        height: 10px; 
        bottom: 1px; 
        right: 1px; 
        transform: scale(1) !important;
      }
      .status-indicator { 
        font-size: 0.7rem; 
        transform: scale(1) !important;
      }
    }
  </style>
</head>
<body data-theme="light">
  <div class="main-container">
    <header class="main-header">
      <h2 class="logo">CHRONOS</h2>
      <nav class="header-icons">
        <a href="{{ url_for('index') }}" title="Accueil"><i class="fa-solid fa-house"></i></a>
        <a href="{{ url_for('add_post') }}" title="Nouvelle publication"><i class="fa-solid fa-circle-plus"></i></a>
        <a href="{{ url_for('profile', username=session.get('username')) }}" title="Profil"><i class="fa-regular fa-user"></i></a>
        <a href="{{ url_for('conversations') }}" title="Messages" id="messages-link" class="active">
          <i class="fa-regular fa-message"></i>
          <span class="message-badge" id="unread-count" style="display:none;">0</span>
        </a>
      </nav>
    </header>

    <div class="conversation-list">
      {% for conv in conversations %}
      <div class="conversation{% if conv.unread_count > 0 %} unread{% endif %}" data-username="{{ conv.username }}" data-last-msg="{{ conv.last_msg }}">
        <div class="profile-wrapper">
          <div class="profile-pic">
            {% if conv.profile_pic %}
            <img src="{{ url_for('avatar_file', filename=conv.profile_pic) }}?t={{ 'now'|timestamp }}" alt="{{ conv.username }}">
            {% else %}
            {{ conv.username[0]|upper }}
            {% endif %}
          </div>
          <span class="online-indicator" id="status-{{ conv.username }}"></span>
        </div>
        <div class="conversation-info">
          <h4>{{ conv.username }}</h4>
          <p class="last-msg">
            {% if conv.last_msg|length > 25 %}
              {{ conv.last_msg[:25] }}...
            {% else %}
              {{ conv.last_msg }}
            {% endif %}
            {% if conv.last_sender == session['username'] and conv.last_status %}
              <span class="status-indicator {{ conv.last_status }}"><i class="fa-solid fa-check{{ '-double' if conv.last_status != 'sent' else '' }}"></i></span>
            {% endif %}
          </p>
        </div>
        <div class="right-side">
          <div class="time">{{ conv.last_date }}</div>
          <div class="unread-badge">{% if conv.unread_count > 0 %}{{ conv.unread_count }}{% endif %}</div>
        </div>
      </div>
      {% else %}
      <div class="empty"><i class="fa-solid fa-inbox"></i><br>Aucune conversation pour l'instant.</div>
      {% endfor %}
    </div>

    <nav class="bottom-nav">
      <a href="{{ url_for('notifications') }}" title="Notifications" id="notifications-link">
        <i class="fa-regular fa-bell"></i>
        <span class="message-badge" id="notifications-count" style="display:none;">0</span>
      </a>
      <a href="{{ url_for('search_users') }}" title="Rechercher"><i class="fa-solid fa-magnifying-glass"></i></a>
      <a href="{{ url_for('login') }}" title="Déconnexion" class="logout-btn"><i class="fa-solid fa-right-from-bracket"></i></a>
    </nav>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const socket = io();
      const currentUser = "{{ session.get('username') }}";
      const msgBadge = document.getElementById("unread-count");
      const notifBadge = document.getElementById("notifications-count");
      const msgLink = document.getElementById("messages-link");
      const notifLink = document.getElementById("notifications-link");

      // Theme application from localStorage
      const body = document.body;
      const savedTheme = localStorage.getItem('theme') || 'light';
      body.dataset.theme = savedTheme;

      // Adjust conversation list height
      function adjustConversationListHeight() {
        const headerHeight = document.querySelector('.main-header').offsetHeight || 60;
        const bottomNavHeight = document.querySelector('.bottom-nav').offsetHeight || 60;
        const availableHeight = window.innerHeight - headerHeight - bottomNavHeight;
        const conversationList = document.querySelector('.conversation-list');
        conversationList.style.height = `${availableHeight}px`;
        conversationList.style.marginTop = `${headerHeight}px`;
        conversationList.style.marginBottom = `${bottomNavHeight}px`;
      }

      // Initialize layout
      window.addEventListener('load', () => {
        adjustConversationListHeight();
      });

      // Handle resize for keyboard or window changes
      window.addEventListener('resize', () => {
        adjustConversationListHeight();
      });

      // Handle navigation
      window.addEventListener('popstate', () => {
        adjustConversationListHeight();
      });

      // --- Request online users on page load ---
      socket.emit('request_online_users');

      // --- Handle Socket.IO connection ---
      socket.on('connect', () => {
        socket.emit('request_online_users');
      });

      // --- Handle online users list ---
      socket.on('online_users', (data) => {
        document.querySelectorAll('.online-indicator').forEach(indicator => {
          indicator.style.display = 'none';
        });
        if (data.users) {
          data.users.forEach(username => {
            const indicator = document.getElementById(`status-${username}`);
            if (indicator) {
              indicator.style.display = 'block';
            }
          });
        }
      });

      // --- Load badge counts from localStorage ---
      const savedMsgs = localStorage.getItem("unreadMsgs");
      const savedNotifs = localStorage.getItem("unreadNotifs");

      if (savedMsgs && parseInt(savedMsgs) > 0) {
        msgBadge.textContent = savedMsgs;
        msgBadge.style.display = "inline-block";
      }
      if (savedNotifs && parseInt(savedNotifs) > 0) {
        notifBadge.textContent = savedNotifs;
        notifBadge.style.display = "inline-block";
      }

      // --- Reset badges when visiting conversations or chat pages ---
      if (window.location.pathname.includes('/conversations') || window.location.pathname.includes('/chat/')) {
        localStorage.setItem("unreadMsgs", 0);
        msgBadge.style.display = "none";
        msgBadge.textContent = "0";
      }

      // --- Reset notifications badge when visiting notifications page ---
      if (window.location.pathname.includes('/notifications')) {
        localStorage.setItem("unreadNotifs", 0);
        notifBadge.style.display = "none";
        notifBadge.textContent = "0";
      }

      // --- Reset message badge on click ---
      msgLink.addEventListener("click", () => {
        localStorage.setItem("unreadMsgs", 0);
        msgBadge.style.display = "none";
        msgBadge.textContent = "0";
      });

      // --- Reset notification badge on click ---
      notifLink.addEventListener("click", () => {
        localStorage.setItem("unreadNotifs", 0);
        notifBadge.style.display = "none";
        notifBadge.textContent = "0";
      });

      // --- Initialize unread badges for conversations ---
      document.querySelectorAll('.conversation').forEach(conv => {
        const badge = conv.querySelector('.unread-badge');
        if (badge.textContent && parseInt(badge.textContent) > 0) {
          badge.style.display = 'block';
        }
      });

      // --- Handle new messages ---
      socket.on('new_message', (msg) => {
        if (msg.sender !== currentUser) {
          const conv = document.querySelector(`.conversation[data-username='${msg.sender}']`);
          const currentChatUser = window.location.pathname.includes('/chat/') ? window.location.pathname.split('/chat/')[1] : null;
          if (!currentChatUser || currentChatUser !== msg.sender) {
            let count = parseInt(localStorage.getItem("unreadMsgs") || "0") + 1;
            localStorage.setItem("unreadMsgs", count);
            msgBadge.textContent = count;
            msgBadge.style.display = "inline-block";
          }
          if (conv) {
            const badge = conv.querySelector('.unread-badge');
            let count = parseInt(badge.textContent || "0", 10);
            count += 1;
            badge.textContent = count;
            badge.style.display = 'block';
            conv.classList.add('unread');

            const lastMsg = msg.text.length > 25 ? msg.text.substring(0, 25) + '...' : msg.text;
            const lastMsgElem = conv.querySelector('.last-msg');
            lastMsgElem.innerHTML = `${lastMsg} ${msg.sender === currentUser ? `<span class="status-indicator ${msg.status}"><i class="fa-solid fa-check${msg.status !== 'sent' ? '-double' : ''}"></i></span>` : ''}`;
            conv.dataset.lastMsg = lastMsg;
            const timeElem = conv.querySelector('.time');
            timeElem.textContent = new Date(msg.date).toLocaleString();

            const parent = conv.parentElement;
            parent.prepend(conv);

            socket.emit('mark_delivered', { sender: msg.sender, id: msg.id });
          } else {
            location.reload();
          }
        }
      });

      // --- Handle conversation click ---
      document.querySelectorAll('.conversation').forEach(conv => {
        conv.addEventListener('click', () => {
          const username = conv.dataset.username;
          socket.emit('mark_read', { sender: username });
          const badge = conv.querySelector('.unread-badge');
          badge.style.display = 'none';
          badge.textContent = '';
          conv.classList.remove('unread');
          window.location.href = `/chat/${username}`;
        });
      });

      // --- Handle read confirmation ---
      socket.on('update_unread', (data) => {
        const username = data.from;
        const conv = document.querySelector(`.conversation[data-username='${username}']`);
        if (conv) {
          const badge = conv.querySelector('.unread-badge');
          badge.style.display = 'none';
          badge.textContent = '';
          conv.classList.remove('unread');
        }
      });

      // --- Handle user online/offline status ---
      socket.on('user_online', (data) => {
        const indicator = document.getElementById(`status-${data.username}`);
        if (indicator) {
          indicator.style.display = "block";
        }
      });

      socket.on('user_offline', (data) => {
        const indicator = document.getElementById(`status-${data.username}`);
        if (indicator) {
          indicator.style.display = "none";
        }
      });

      // --- Handle avatar updates ---
      socket.on('avatar_updated', (data) => {
        const conv = document.querySelector(`.conversation[data-username='${data.username}']`);
        if (conv) {
          const img = conv.querySelector('.profile-pic img');
          if (img) {
            img.src = data.new_avatar_url;
          }
        }
      });

      // --- Handle typing in conversations ---
      const typingTimeouts = {};
      socket.on('user_typing', (data) => {
        const conv = document.querySelector(`.conversation[data-username='${data.sender}']`);
        if (conv) {
          const lastMsgElem = conv.querySelector('.last-msg');
          if (!lastMsgElem.dataset.original) {
            lastMsgElem.dataset.original = lastMsgElem.innerHTML;
          }
          lastMsgElem.textContent = 'écrit...';
          if (typingTimeouts[data.sender]) {
            clearTimeout(typingTimeouts[data.sender]);
          }
          typingTimeouts[data.sender] = setTimeout(() => {
            if (lastMsgElem.dataset.original) {
              lastMsgElem.innerHTML = lastMsgElem.dataset.original;
              delete lastMsgElem.dataset.original;
            } else {
              lastMsgElem.textContent = conv.dataset.lastMsg || '';
            }
          }, 2000);
        }
      });

      socket.on('stop_typing', (data) => {
        const conv = document.querySelector(`.conversation[data-username='${data.sender}']`);
        if (conv) {
          const lastMsgElem = conv.querySelector('.last-msg');
          if (typingTimeouts[data.sender]) {
            clearTimeout(typingTimeouts[data.sender]);
            delete typingTimeouts[data.sender];
          }
          if (lastMsgElem.dataset.original) {
            lastMsgElem.innerHTML = lastMsgElem.dataset.original;
            delete lastMsgElem.dataset.original;
          } else {
            lastMsgElem.textContent = conv.dataset.lastMsg || '';
          }
        }
      });
    });
  </script>
</body>
</html>
