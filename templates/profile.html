<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Profil ‚Äî {{ profile_user.username }}</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    /* ---------- GLOBAL ---------- */
    :root {
      --bg-color: #fafafa;
      --text-color: #262626;
      --border-color: #dbdbdb;
      --card-bg: #fff;
      --link-hover: #0095f6;
      --shadow-color: rgba(0,0,0,0.05);
      --button-bg: #0095f6;
      --button-hover: #00376b;
      --comment-form-bg: #fff;
      --textarea-bg: #fafafa;
    }

    [data-theme="dark"] {
      --bg-color: #1a1a1a;
      --text-color: #e0e0e0;
      --border-color: #333;
      --card-bg: #262626;
      --link-hover: #4dabf7;
      --shadow-color: rgba(0,0,0,0.3);
      --button-bg: #4dabf7;
      --button-hover: #1c6dd0;
      --comment-form-bg: #262626;
      --textarea-bg: #333;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      line-height: 1.5;
      overflow-x: hidden;
    }
    a { text-decoration: none; color: inherit; }
    .main-container { max-width: 935px; margin: 0 auto; padding: 20px 20px 80px 20px; }

    /* ---------- HEADER ---------- */
    .main-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 20px;
      background: var(--card-bg);
      border-bottom: 1px solid var(--border-color);
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 1px 2px var(--shadow-color);
    }
    .logo {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--text-color);
      font-family: 'Lobster', cursive;
      letter-spacing: 1px;
      flex-shrink: 0;
    }
    .header-icons {
      display: flex;
      align-items: center;
      gap: 24px;
      flex-wrap: nowrap;
    }
    .header-icons a, .header-icons button {
      color: var(--text-color);
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: color 0.2s ease, transform 0.2s ease;
      position: relative;
      background: none;
      border: none;
      cursor: pointer;
    }
    .header-icons a:hover, .header-icons button:hover {
      color: var(--link-hover);
      transform: scale(1.1);
    }

    /* ---------- BOTTOM NAVIGATION BAR ---------- */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: var(--card-bg);
      border-top: 1px solid var(--border-color);
      display: flex;
      justify-content: space-around;
      align-items: center;
      padding: 12px 0;
      z-index: 1000;
      box-shadow: 0 -1px 2px var(--shadow-color);
    }
    .bottom-nav a {
      color: var(--text-color);
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: color 0.2s ease, transform 0.2s ease;
      position: relative;
    }
    .bottom-nav a:hover {
      color: var(--link-hover);
      transform: scale(1.1);
    }
    .bottom-nav a.active {
      color: var(--link-hover);
    }
    .message-badge {
      position: absolute;
      top: -8px;
      right: -8px;
      background: #ed4956;
      color: #fff;
      font-size: 0.7rem;
      font-weight: 600;
      padding: 3px 6px;
      border-radius: 50%;
      line-height: 1;
      border: 2px solid var(--card-bg);
    }

    /* ---------- POSTS ---------- */
    .scroll-box {
      padding: 20px 0;
    }
    .post {
      background: var(--card-bg);
      margin-bottom: 24px;
      border: 1px solid var(--border-color);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px var(--shadow-color);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      position: relative;
    }
    .post:hover {
      transform: translateY(-4px);
      box-shadow: 0 4px 12px var(--shadow-color);
    }
    .user-info {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border-color);
    }
    .avatar-post, .avatar-fallback {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      object-fit: cover;
      background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 1.1rem;
      color: #fff;
      border: 2px solid var(--card-bg);
      box-shadow: 0 0 0 1px var(--shadow-color);
      transition: transform 0.2s ease;
    }
    .avatar-post:hover, .avatar-fallback:hover {
      transform: scale(1.05);
    }
    .username-link {
      margin-left: 12px;
      font-weight: 600;
      font-size: 0.95rem;
      color: var(--text-color);
      transition: color 0.2s ease;
    }
    .username-link:hover {
      color: var(--link-hover);
    }
    .description {
      padding: 12px 16px;
      font-size: 0.9rem;
      line-height: 1.4;
      word-wrap: break-word;
      overflow-wrap: break-word;
      overflow: hidden;
      display: -webkit-box;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: 2;
      position: relative;
    }
    .description.expanded {
      -webkit-line-clamp: unset;
    }
    .toggle-description {
      display: none;
      color: var(--link-hover);
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 600;
      padding: 0 16px 12px 16px;
      transition: color 0.2s ease;
    }
    .toggle-description:hover {
      color: var(--button-hover);
    }
    .description.long + .toggle-description {
      display: block;
    }

    /* ---------- POST MENU ---------- */
    .post-menu-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      background: none;
      border: none;
      font-size: 1.2rem;
      color: var(--text-color);
      cursor: pointer;
      transition: color 0.2s ease, transform 0.2s ease;
    }
    .post-menu-btn:hover {
      color: var(--link-hover);
      transform: scale(1.1);
    }
    .post-menu {
      position: absolute;
      top: 40px;
      right: 12px;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      box-shadow: 0 4px 8px var(--shadow-color);
      display: none;
      z-index: 100;
    }
    .post-menu.active {
      display: block;
    }
    .post-menu button {
      background: none;
      border: none;
      padding: 10px 16px;
      font-size: 0.85rem;
      color: var(--text-color);
      width: 100%;
      text-align: left;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    .post-menu button:hover {
      background: var(--textarea-bg);
    }
    .post-menu button.delete-btn {
      color: #ed4956;
    }
    .post-menu button.delete-btn:hover {
      background: #ffe6e9;
    }

    /* ---------- MEDIA ---------- */
    .post-image, video {
      width: 100%;
      max-height: 80vh;
      object-fit: cover;
      display: block;
      background: #000;
      cursor: pointer;
    }
    .video-container {
      position: relative;
    }
    .mute-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1rem;
      z-index: 10;
      transition: background 0.2s ease, transform 0.2s ease;
    }
    .mute-btn:hover {
      background: rgba(0, 0, 0, 0.9);
      transform: scale(1.1);
    }

    /* ---------- CAROUSEL MULTIMEDIA ---------- */
    .carousel {
      position: relative;
      width: 100%;
      overflow: hidden;
    }
    .carousel-track {
      display: flex;
      width: 100%;
      overflow-x: auto;
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      scroll-behavior: smooth;
    }
    .carousel-track::-webkit-scrollbar { display: none; }
    .carousel-track > * {
      flex: 0 0 100%;
      width: 100%;
      scroll-snap-align: start;
    }
    .carousel-indicators {
      position: absolute;
      bottom: 12px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 8px;
      z-index: 10;
    }
    .carousel-indicators .dot {
      width: 8px;
      height: 8px;
      background: rgba(255, 255, 255, 0.5);
      border-radius: 50%;
      transition: transform 0.2s ease, background 0.2s ease;
      cursor: pointer;
    }
    .carousel-indicators .dot.active {
      background: #fff;
      transform: scale(1.4);
    }

    /* ---------- ACTIONS ---------- */
    .post-actions {
      display: flex;
      align-items: center;
      padding: 8px 16px;
      border-top: 1px solid var(--border-color);
    }
    .like-btn {
      border: none;
      background: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-color);
      transition: transform 0.2s ease, color 0.2s ease;
    }
    .like-btn:hover {
      transform: scale(1.15);
      color: #ed4956;
    }
    .like-btn.liked {
      color: #ed4956;
      animation: heart-bounce 0.3s ease;
    }
    @keyframes heart-bounce {
      0% { transform: scale(1); }
      50% { transform: scale(1.3); }
      100% { transform: scale(1); }
    }
    .comment-btn {
      display: flex;
      align-items: center;
      margin-left: 16px;
      font-size: 1.5rem;
      color: var(--text-color);
      transition: transform 0.2s ease, color 0.2s ease;
    }
    .comment-btn:hover {
      transform: scale(1.15);
      color: var(--link-hover);
    }
    .share-btn {
      display: flex;
      align-items: center;
      margin-left: 16px;
      font-size: 1.5rem;
      color: var(--text-color);
      border: none;
      background: none;
      cursor: pointer;
      transition: transform 0.2s ease, color 0.2s ease;
    }
    .share-btn:hover {
      transform: scale(1.15);
      color: var(--link-hover);
    }
    .share-btn.shared {
      color: var(--link-hover);
      animation: share-bounce 0.3s ease;
    }
    @keyframes share-bounce {
      0% { transform: scale(1); }
      50% { transform: scale(1.3); }
      100% { transform: scale(1); }
    }
    .like-count, .comment-count, .share-count {
      margin-left: 8px;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-color);
    }
    .follow-btn {
      margin-left: auto;
      background: var(--button-bg);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 6px 16px;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: background 0.2s ease, transform 0.2s ease;
    }
    .follow-btn i {
      font-size: 0.9rem;
    }
    .follow-btn:hover {
      background: var(--button-hover);
      transform: scale(1.05);
    }
    .follow-btn.following {
      background: var(--textarea-bg);
      color: var(--text-color);
      border: 1px solid var(--border-color);
    }
    .follow-btn.following:hover {
      background: var(--border-color);
    }

    /* ---------- DATE ---------- */
    .date {
      font-size: 0.75rem;
      color: #8e8e8e;
      padding: 8px 16px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* ---------- COMMENTS ---------- */
    .comments-section {
      display: none;
      flex-direction: column;
      height: 300px;
      position: relative;
      border-top: 1px solid var(--border-color);
    }
    .comments-section.open {
      display: flex;
    }
    .comments-box {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      scrollbar-width: none;
    }
    .comments-box::-webkit-scrollbar { display: none; }
    .comment {
      display: flex;
      align-items: flex-start;
      padding: 8px 0;
      opacity: 1;
      z-index: 1;
    }
    .avatar-comment, .avatar-fallback {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      object-fit: cover;
      background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 1rem;
      color: #fff;
      border: 2px solid var(--card-bg);
      box-shadow: 0 0 0 1px var(--shadow-color);
      margin-right: 10px;
      transition: transform 0.2s ease;
    }
    .avatar-comment:hover, .avatar-fallback:hover {
      transform: scale(1.05);
    }
    .comment-content {
      flex: 1;
      max-width: calc(100% - 46px);
    }
    .comment-content p:first-child {
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--text-color);
    }
    .comment-content p:first-child a:hover {
      color: var(--link-hover);
    }
    .comment-content p:nth-child(2) {
      font-size: 0.85rem;
      color: var(--text-color);
      word-wrap: break-word;
      overflow-wrap: break-word;
      white-space: normal;
      max-width: 100%;
      line-height: 1.4;
    }
    .comment-content small {
      font-size: 0.75rem;
      color: #8e8e8e;
      display: block;
      margin-top: 4px;
    }
    .no-comments {
      font-size: 0.9rem;
      color: #6b7280;
      text-align: center;
      padding: 16px 0;
    }

    /* ---------- COMMENT FORM ---------- */
    .comment-form {
      padding: 12px 16px;
      border-top: 1px solid var(--border-color);
      background: var(--comment-form-bg);
      position: sticky;
      bottom: 0;
      width: 100%;
      z-index: 20;
    }
    .comment-form form {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .comment-form textarea {
      flex: 1;
      padding: 8px 12px;
      font-size: 0.85rem;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      resize: none;
      height: 40px;
      background: var(--textarea-bg);
      color: var(--text-color);
      font-family: inherit;
      word-wrap: break-word;
      overflow-wrap: break-word;
      white-space: pre-wrap;
    }
    .comment-form textarea:focus {
      outline: none;
      border-color: var(--link-hover);
      box-shadow: 0 0 0 1px var(--link-hover);
    }
    .comment-form button {
      background: var(--button-bg);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.2s ease;
    }
    .comment-form button:hover {
      background: var(--button-hover);
      transform: scale(1.05);
    }
    .comment-form button:disabled {
      background: #b2dffc;
      cursor: not-allowed;
    }

    /* ---------- RESPONSIVE ---------- */
    @media (max-width: 600px) {
      .main-container { padding: 16px 16px 70px 16px; }
      .avatar-post, .avatar-fallback, .avatar-comment { width: 36px; height: 36px; font-size: 0.9rem; }
      .post-image, video { max-height: 70vh; }
      .header-icons { gap: 16px; }
      .header-icons a, .header-icons button { font-size: 1.3rem; }
      .bottom-nav { padding: 10px 0; }
      .bottom-nav a { font-size: 1.3rem; }
      .mute-btn { width: 28px; height: 28px; font-size: 0.9rem; }
      .logo { font-size: 1.5rem; }
      .post { margin-bottom: 16px; }
      .user-info { padding: 10px 12px; }
      .username-link { font-size: 0.9rem; }
      .description { font-size: 0.85rem; padding: 10px 12px; }
      .post-actions { padding: 6px 12px; }
      .follow-btn { padding: 5px 12px; font-size: 0.8rem; }
      .share-btn { font-size: 1.3rem; }
      .date { padding: 6px 12px; }
      .post-menu-btn { font-size: 1.1rem; }
      .post-menu { top: 36px; right: 10px; }
      .post-menu button { font-size: 0.8rem; padding: 8px 12px; }
      .comments-section { height: 250px; }
      .comment-form { padding: 10px 12px; }
      .comment-form textarea { font-size: 0.8rem; height: 36px; }
      .comment-form button { padding: 6px 12px; font-size: 0.8rem; }
    }

    /* Additional profile-specific styles */
    .profile-header {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      background: var(--card-bg);
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 2px 8px var(--shadow-color);
      margin-bottom: 20px;
      position: relative;
    }
    .profile-avatar, .profile-avatar-fallback {
      width: 90px;
      height: 90px;
      border-radius: 50%;
      object-fit: cover;
      background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 36px;
      font-weight: bold;
      color: #fff;
      cursor: pointer;
    }
    .change-avatar-btn {
      position: absolute;
      top: 75px;
      left: 75px;
      background: var(--button-bg);
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 0.9rem;
      z-index: 10;
      transition: background 0.2s ease, transform 0.2s ease;
    }
    .change-avatar-btn:hover {
      background: var(--button-hover);
      transform: scale(1.1);
    }
    .profile-meta {
      margin-left: 20px;
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .profile-meta h1 {
      margin: 0;
      font-size: 26px;
      word-break: break-word;
    }
    .profile-meta p {
      margin: 6px 0;
      color: #555;
    }
    .follow-count {
      margin-top: 8px;
      font-weight: bold;
      color: var(--text-color);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .follow-count span {
      font-size: 16px;
      color: var(--link-hover);
    }
    button#message-btn, button#account-btn {
      background: var(--button-bg);
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 6px 14px;
      cursor: pointer;
      margin-top: 8px;
      font-size: 14px;
      font-weight: bold;
      transition: background 0.3s ease, transform 0.2s ease;
    }
    button#message-btn:hover, button#account-btn:hover {
      background: var(--button-hover);
      transform: scale(1.05);
    }
    .profile-section-title {
      font-size: 20px;
      margin: 15px 0;
      font-weight: bold;
    }
    .avatar-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .avatar-modal img {
      max-width: 95%;
      max-height: 95%;
      border-radius: 12px;
      box-shadow: 0 0 15px rgba(0,0,0,0.6);
    }
    .profile-buttons {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 8px;
    }
  </style>
</head>
<body data-username="{{ current_username }}" data-theme="light">
  <div class="main-container">
    <header class="main-header">
      <h2 class="logo">CHRONOS</h2>
      <nav class="header-icons">
        <a href="{{ url_for('index') }}" title="Accueil"><i class="fa-solid fa-house"></i></a>
        <a href="{{ url_for('add_post') }}" title="Nouvelle publication"><i class="fa-solid fa-circle-plus"></i></a>
        <a href="{{ url_for('profile', username=current_username) }}" title="Profil"><i class="fa-regular fa-user"></i></a>
        <a href="{{ url_for('conversations') }}" title="Messages" id="messages-link">
          <i class="fa-regular fa-message"></i>
          <span class="message-badge" id="unread-count" style="display:none;">0</span>
        </a>
        <button id="theme-toggle" title="Changer de th√®me"><i class="fa-solid fa-moon"></i></button>
      </nav>
    </header>

    <div class="profile-header">
      {% if profile_user.avatar %}
        <img src="{{ url_for('avatar_file', filename=profile_user.avatar) }}?t={{ 'now'|timestamp }}" 
             alt="avatar" class="profile-avatar" id="profile-avatar" />
      {% else %}
        <div class="profile-avatar-fallback" id="profile-avatar">
          {{ profile_user.username[:1]|upper }}
        </div>
      {% endif %}
      {% if current_username == profile_user.username %}
        <button class="change-avatar-btn" id="change-avatar-btn" title="Changer la photo de profil">
          <i class="fa-solid fa-camera"></i>
        </button>
        <input type="file" id="avatar-input" accept="image/*" style="display: none;" />
      {% endif %}
      <div class="profile-meta">
        <h1>@{{ profile_user.username }}</h1>
        <p>{{ profile_user.bio if profile_user.bio else "Aucune bio pour le moment." }}</p>
        <div class="follow-count">üë• <span id="follower-count">{{ profile_user.followers|length }}</span></div>
        <div class="profile-buttons">
          {% if current_username != profile_user.username %}
            <button class="follow-btn{% if profile_user.following %} following{% endif %}" data-following="{{ 'true' if profile_user.following else 'false' }}" id="follow-btn">
              {% if profile_user.following %}
                Abonn√© ‚úî
              {% else %}
                <i class="fa-solid fa-plus"></i> Suivre
              {% endif %}
            </button>
            <button id="message-btn">üí¨ Message</button>
            <button id="account-btn" title="Compte"><i class="fa-solid fa-cash-register"></i></button>
          {% else %}
            <button id="account-btn" title="Compte"><i class="fa-solid fa-cash-register"></i></button>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="profile-section-title">üìù Publications</div>

    <main class="scroll-box" id="profile-posts">
      {% if posts|length == 0 %}
        <p style="color:#6b7280;">Aucune publication pour l‚Äôinstant.</p>
      {% else %}
        {% for post in posts %}
          <div class="post" data-post-id="{{ post.id }}">
            <div class="user-info">
              {% if profile_user.avatar %}
                <a class="avatar-link" href="{{ url_for('profile', username=profile_user.username) }}">
                  <img src="{{ url_for('avatar_file', filename=profile_user.avatar) }}?t={{ 'now'|timestamp }}" alt="avatar" class="avatar-post" />
                </a>
              {% else %}
                <a class="avatar-link" href="{{ url_for('profile', username=profile_user.username) }}">
                  <div class="avatar-fallback">{{ profile_user.username[:1]|upper }}</div>
                </a>
              {% endif %}
              <a class="username-link" href="{{ url_for('profile', username=profile_user.username) }}">
                <p class="username">{{ profile_user.username }}</p>
              </a>
              {% if current_username == profile_user.username %}
                <button class="post-menu-btn" title="Options">
                  <i class="fa-solid fa-ellipsis"></i>
                </button>
                <div class="post-menu">
                  <button class="boost-btn">Booster</button>
                  <button class="delete-btn">Supprimer</button>
                </div>
              {% endif %}
            </div>

            <p class="description">{{ post.description }}</p>
            <span class="toggle-description">Afficher plus</span>

            {# ---- Single file ---- #}
            {% if post.type == "image" and not post.files %}
              <img src="{{ url_for('uploaded_file', filename=post.file) }}" alt="image" class="post-image" />
            {% elif post.type == "video" and not post.files %}
              <div class="video-container">
                <video src="{{ url_for('uploaded_file', filename=post.file) }}" muted loop class="post-video"></video>
                <button class="mute-btn" title="Activer/D√©sactiver le son">
                  <i class="fa-solid fa-volume-xmark"></i>
                </button>
              </div>
            {% endif %}

            {# ---- Multiple files (carousel) ---- #}
            {% if post.files|length > 0 %}
              <div class="carousel">
                <div class="carousel-track">
                  {% for file in post.files %}
                    {% if file.type == "image" %}
                      <img src="{{ url_for('uploaded_file', filename=file.name) }}" alt="image" class="post-image" />
                    {% elif file.type == "video" %}
                      <div class="video-container">
                        <video src="{{ url_for('uploaded_file', filename=file.name) }}" muted loop class="post-video"></video>
                        <button class="mute-btn" title="Activer/D√©sactiver le son">
                          <i class="fa-solid fa-volume-xmark"></i>
                        </button>
                      </div>
                    {% endif %}
                  {% endfor %}
                </div>
                <div class="carousel-indicators">
                  {% for file in post.files %}
                    <span class="dot{% if loop.first %} active{% endif %}"></span>
                  {% endfor %}
                </div>
              </div>
            {% endif %}

            <div class="post-actions">
              <button class="like-btn{% if post.liked_by_user %} liked{% endif %}">
                <i class="{% if post.liked_by_user %}fa-solid{% else %}fa-regular{% endif %} fa-heart"></i>
              </button>
              <span class="like-count">{{ post.likes if post.likes else 0 }}</span>
              <button class="comment-btn">
                <i class="fa-regular fa-comment"></i>
                <span class="comment-count">{{ post.comments_count if post.comments_count else 0 }}</span>
              </button>
              <button class="follow-btn{% if post.following %} following{% endif %}" data-following="{{ 'true' if post.following else 'false' }}">
                {% if post.following %}
                  Abonn√© ‚úî
                {% else %}
                  <i class="fa-solid fa-plus"></i> Suivre
                {% endif %}
              </button>
              <button class="share-btn{% if post.shared_by_user %} shared{% endif %}">
                <i class="{% if post.shared_by_user %}fa-solid{% else %}fa-regular{% endif %} fa-share-from-square"></i>
              </button>
              <span class="share-count">{{ post.shares if post.shares else 0 }}</span>
            </div>

            <p class="date">Publi√© le {{ post.date }}</p>
            <section class="comments-section" id="comments-{{ post.id }}">
              <div class="comments-box" id="commentsBox-{{ post.id }}">
                {% if post.comments|length == 0 %}
                  <p class="no-comments">Aucun commentaire pour l‚Äôinstant.</p>
                {% else %}
                  {% for comment in post.comments %}
                  <div class="comment">
                    {% if comment.avatar %}
                    <a href="{{ url_for('profile', username=comment.username) }}">
                      <img src="{{ url_for('avatar_file', filename=comment.avatar) }}?t={{ 'now'|timestamp }}" alt="avatar" class="avatar-comment" />
                    </a>
                    {% else %}
                    <a href="{{ url_for('profile', username=comment.username) }}">
                      <div class="avatar-fallback">{{ comment.username[:1]|upper }}</div>
                    </a>
                    {% endif %}
                    <div class="comment-content">
                      <p><strong><a href="{{ url_for('profile', username=comment.username) }}">{{ comment.username }}</a></strong></p>
                      <p>{{ comment.content }}</p>
                      <small>{{ comment.date }}</small>
                    </div>
                  </div>
                  {% endfor %}
                {% endif %}
              </div>
              <div class="comment-form">
                <form data-post-id="{{ post.id }}">
                  <textarea name="comment" placeholder="√âcrire un commentaire..." required></textarea>
                  <button type="submit">Commenter</button>
                </form>
              </div>
            </section>
          </div>
        {% endfor %}
      {% endif %}
    </main>

    <nav class="bottom-nav">
      <a href="{{ url_for('notifications') }}" title="Notifications" id="notifications-link">
        <i class="fa-regular fa-bell"></i>
        <span class="message-badge" id="notifications-count" style="display:none;">0</span>
      </a>
      <a href="{{ url_for('search_users') }}" title="Rechercher"><i class="fa-solid fa-magnifying-glass"></i></a>
      <a href="{{ url_for('login') }}" title="D√©connexion" class="logout-btn"><i class="fa-solid fa-right-from-bracket"></i></a>
    </nav>
  </div>

  <!-- Modal pour avatar -->
  <div class="avatar-modal" id="avatar-modal">
    {% if profile_user.avatar %}
      <img src="{{ url_for('avatar_file', filename=profile_user.avatar) }}?t={{ 'now'|timestamp }}" alt="avatar-zoom" />
    {% else %}
      <div style="color:white; font-size:100px;">{{ profile_user.username[:1]|upper }}</div>
    {% endif %}
  </div>

  <script>
  const socket = io();
  socket.emit("join_room", "{{ profile_user.username }}");

  // Theme toggle functionality
  const themeToggleBtn = document.getElementById('theme-toggle');
  const body = document.body;

  function setTheme(theme) {
    body.dataset.theme = theme;
    localStorage.setItem('theme', theme);
    const icon = themeToggleBtn.querySelector('i');
    icon.classList.toggle('fa-moon', theme === 'light');
    icon.classList.toggle('fa-sun', theme === 'dark');
  }

  // Load saved theme or default to light
  const savedTheme = localStorage.getItem('theme') || 'light';
  setTheme(savedTheme);

  if (themeToggleBtn) {
    themeToggleBtn.addEventListener('click', () => {
      const newTheme = body.dataset.theme === 'light' ? 'dark' : 'light';
      setTheme(newTheme);
    });
  }

  socket.on("update_follow", (data) => {
      if (data.target_user === "{{ profile_user.username }}") {
          const countEl = document.getElementById("follower-count");
          let current = parseInt(countEl.textContent);
          if (data.following) current += 1;
          else current -= 1;
          countEl.textContent = current;
          const followBtn = document.getElementById('follow-btn');
          if (followBtn) {
              if (data.following) {
                  followBtn.dataset.following = "true";
                  followBtn.classList.add('following');
                  followBtn.innerHTML = 'Abonn√© ‚úî';
                  followBtn.disabled = true;
              } else {
                  followBtn.dataset.following = "false";
                  followBtn.classList.remove('following');
                  followBtn.innerHTML = '<i class="fa-solid fa-plus"></i> Suivre';
                  followBtn.disabled = false;
              }
          }
      }
  });

  socket.on("avatar_updated", (data) => {
      console.log(`Mise √† jour de l'avatar re√ßue pour ${data.username}: ${data.new_avatar_url}`);
      if (data.username === "{{ profile_user.username }}" || data.username === "{{ current_username }}") {
          document.querySelectorAll(`img[src*="/avatars/"]`).forEach(img => {
              if (img.closest(`[href*="/profile/${data.username}"]`) || img.id === "profile-avatar") {
                  img.src = data.new_avatar_url;
                  console.log(`Avatar mis √† jour: ${img.src}`);
              }
          });
          const modalImg = document.querySelector("#avatar-modal img");
          if (modalImg && data.username === "{{ profile_user.username }}") {
              modalImg.src = data.new_avatar_url;
              console.log(`Avatar modal mis √† jour: ${modalImg.src}`);
          }
      }
  });

  socket.on("post_deleted", (data) => {
      const post = document.querySelector(`.post[data-post-id="${data.post_id}"]`);
      if (post) {
          post.remove();
      }
      const postsContainer = document.getElementById("profile-posts");
      if (postsContainer && !postsContainer.querySelector(".post")) {
          postsContainer.innerHTML = '<p style="color:#6b7280;">Aucune publication pour l‚Äôinstant.</p>';
      }
  });

  socket.on('like_updated', data => {
      const post = document.querySelector(`.post[data-post-id="${data.post_id}"]`);
      if (post) {
          const countEl = post.querySelector('.like-count');
          if (countEl) countEl.textContent = data.likes;
          const btn = post.querySelector('.like-btn');
          if (btn) btn.classList.toggle('liked', data.liked);
          const icon = btn.querySelector('i');
          icon.classList.toggle('fa-solid', data.liked);
          icon.classList.toggle('fa-regular', !data.liked);
      }
  });

  socket.on('share_updated', data => {
      const post = document.querySelector(`.post[data-post-id="${data.post_id}"]`);
      if (post) {
          const countEl = post.querySelector('.share-count');
          if (countEl) countEl.textContent = data.shares;
          const btn = post.querySelector('.share-btn');
          if (btn) btn.classList.toggle('shared', data.shared);
          const icon = btn.querySelector('i');
          icon.classList.toggle('fa-solid', data.shared);
          icon.classList.toggle('fa-regular', !data.shared);
      }
  });

  socket.on('new_comment', data => {
      const post = document.querySelector(`.post[data-post-id="${data.post_id}"]`);
      if (!post) return;
      const commentsBox = post.querySelector('#commentsBox-' + data.post_id);
      if (!commentsBox) return;

      const existingComment = commentsBox.querySelector(`.comment[data-comment-id="${data.comment_id}"]`);
      if (!existingComment) {
        const commentDiv = document.createElement('div');
        commentDiv.className = 'comment';
        commentDiv.dataset.commentId = data.comment_id;
        const avatarHtml = data.avatar
          ? `<a href="/profile/${encodeURIComponent(data.username)}"><img src="/avatars/${encodeURIComponent(data.avatar)}?t=${Date.now()}" alt="avatar" class="avatar-comment" /></a>`
          : `<a href="/profile/${encodeURIComponent(data.username)}"><div class="avatar-fallback">${data.username[0].toUpperCase()}</div></a>`;
        commentDiv.innerHTML = `
          ${avatarHtml}
          <div class="comment-content">
            <p><strong><a href="/profile/${encodeURIComponent(data.username)}">${data.username}</a></strong></p>
            <p>${data.content}</p>
            <small>${new Date().toLocaleString('fr-FR', { dateStyle: 'short', timeStyle: 'short' })}</small>
          </div>
        `;
        const noComments = commentsBox.querySelector('.no-comments');
        if (noComments) noComments.remove();
        commentsBox.appendChild(commentDiv);
        if (commentsBox.parentElement.classList.contains('open')) {
          commentsBox.scrollTop = commentsBox.scrollHeight;
        }
        const countEl = post.querySelector('.comment-count');
        countEl.textContent = parseInt(countEl.textContent || "0") + 1;
      }
  });

  const avatar = document.getElementById("profile-avatar");
  const modal = document.getElementById("avatar-modal");
  const changeAvatarBtn = document.getElementById("change-avatar-btn");
  const avatarInput = document.getElementById("avatar-input");
  const accountBtn = document.getElementById("account-btn");

  if (avatar && modal) {
      avatar.addEventListener("click", () => {
          {% if current_username != profile_user.username %}
            modal.style.display = "flex";
            history.pushState({ avatarOpen: true }, "");
          {% endif %}
      });

      modal.addEventListener("click", () => {
          modal.style.display = "none";
          if (history.state && history.state.avatarOpen) history.back();
      });

      window.addEventListener("popstate", () => modal.style.display = "none");
      window.addEventListener("keydown", (e) => {
          if (e.key === "Escape") {
              modal.style.display = "none";
              if (history.state && history.state.avatarOpen) history.back();
          }
      });
  }

  if (changeAvatarBtn && avatarInput) {
      changeAvatarBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          if (confirm("Changer la photo de profil ?")) {
              avatarInput.click();
          }
      });

      avatarInput.addEventListener("change", () => {
          const file = avatarInput.files[0];
          if (!file) return;

          const formData = new FormData();
          formData.append("avatar", file);

          fetch("/update_avatar", {
              method: "POST",
              body: formData
          })
          .then(response => response.json())
          .then(data => {
              if (data.success) {
                  document.querySelectorAll(".profile-avatar, .avatar-post").forEach(img => {
                      if (img.tagName === "IMG") {
                          img.src = data.avatar_url;
                          console.log(`Avatar local mis √† jour: ${img.src}`);
                      }
                  });
                  const modalImg = document.querySelector("#avatar-modal img");
                  if (modalImg) {
                      modalImg.src = data.avatar_url;
                      console.log(`Avatar modal local mis √† jour: ${modalImg.src}`);
                  }
                  alert("Photo de profil mise √† jour !");
                  avatarInput.value = "";
              } else {
                  alert("Erreur : " + (data.error || "√âchec de la mise √† jour"));
              }
          })
          .catch(err => {
              console.error("Erreur r√©seau:", err);
              alert("Erreur r√©seau lors de la mise √† jour.");
          });
      });
  }

  if (accountBtn) {
      accountBtn.addEventListener("click", () => {
          window.location.href = "/account";
      });
  }

  document.addEventListener("DOMContentLoaded", () => {
      const btn = document.getElementById("message-btn");
      if (btn) {
          btn.addEventListener("click", () => {
              const message = prompt(`Envoyer un message √† {{ profile_user.username }} :`);
              if (message && message.trim() !== "") {
                  fetch("/send_message", {
                      method: "POST",
                      headers: { "Content-Type": "application/json" },
                      body: JSON.stringify({
                          recipient: "{{ profile_user.username }}",
                          message: message
                      })
                  })
                  .then(response => response.json())
                  .then(data => {
                      if (data.success) {
                          alert("Message envoy√© !");
                          window.location.href = "{{ url_for('conversations') }}";
                      } else {
                          alert("Erreur lors de l'envoi du message.");
                      }
                  });
              }
          });
      }

      const followBtn = document.getElementById("follow-btn");
      if (followBtn) {
          followBtn.addEventListener('click', async () => {
              if (followBtn.dataset.following === "true") return;
              try {
                  const postUsername = "{{ profile_user.username }}";
                  const res = await fetch(`/follow/${encodeURIComponent(postUsername)}`, { method: 'POST', credentials: 'same-origin' });
                  if (!res.ok) throw new Error('Erreur serveur');
                  const data = await res.json();
                  if (data.following) {
                      if (!window.followingUsers) window.followingUsers = new Set();
                      window.followingUsers.add(postUsername);
                      followBtn.dataset.following = "true";
                      followBtn.classList.add('following');
                      followBtn.innerHTML = 'Abonn√© ‚úî';
                      followBtn.disabled = true;
                      socket.emit("update_follow", { target_user: postUsername, following: true });
                  } else {
                      window.followingUsers.delete(postUsername);
                      followBtn.dataset.following = "false";
                      followBtn.classList.remove('following');
                      followBtn.innerHTML = '<i class="fa-solid fa-plus"></i> Suivre';
                      followBtn.disabled = false;
                      socket.emit("update_follow", { target_user: postUsername, following: false });
                  }
              } catch (e) {
                  console.error(e);
                  alert('Impossible de suivre pour le moment.');
              }
          });
      }

      const currentUsername = "{{ current_username }}";
      const postsContainer = document.getElementById('profile-posts');
      const videos = new Set();
      let currentVideo = null;

      if ('scrollRestoration' in history) history.scrollRestoration = 'manual';

      async function toggleLike(button) {
          const post = button.closest('.post');
          const postId = post.dataset.postId;
          const countEl = post.querySelector('.like-count');
          try {
              const res = await fetch(`/like/${postId}`, { method: 'POST', credentials: 'same-origin' });
              if (!res.ok) return;
              const data = await res.json();
              countEl.textContent = data.likes;
              button.classList.toggle('liked', data.liked);
              const icon = button.querySelector('i');
              icon.classList.toggle('fa-solid', data.liked);
              icon.classList.toggle('fa-regular', !data.liked);
              socket.emit('like_updated', { post_id: parseInt(postId), likes: data.likes, liked: data.liked });
          } catch (err) { console.error(err); }
      }

      async function toggleShare(button) {
          const post = button.closest('.post');
          const postId = post.dataset.postId;
          const countEl = post.querySelector('.share-count');
          try {
              const postUrl = `${window.location.origin}/post/${postId}`;
              await navigator.clipboard.writeText(postUrl);
              const res = await fetch(`/share/${postId}`, { method: 'POST', credentials: 'same-origin' });
              if (!res.ok) return;
              const data = await res.json();
              countEl.textContent = data.shares;
              button.classList.toggle('shared', data.shared);
              const icon = button.querySelector('i');
              icon.classList.toggle('fa-solid', data.shared);
              icon.classList.toggle('fa-regular', !data.shared);
              socket.emit('share_updated', { post_id: parseInt(postId), shares: data.shares, shared: data.shared });
              alert('Lien du post copi√© dans le presse-papiers !');
          } catch (err) {
              console.error(err);
              alert('Erreur lors du partage du post.');
          }
      }

      function bindLikes(post) {
          const btn = post.querySelector('.like-btn');
          if (!btn) return;
          btn.addEventListener('click', () => toggleLike(btn));
          const icon = btn.querySelector('i');
          const isLiked = btn.classList.contains('liked');
          icon.classList.toggle('fa-solid', isLiked);
          icon.classList.toggle('fa-regular', !isLiked);
      }

      function bindShareButtons(post) {
          const btn = post.querySelector('.share-btn');
          if (!btn) return;
          btn.addEventListener('click', () => toggleShare(btn));
          const icon = btn.querySelector('i');
          const isShared = btn.classList.contains('shared');
          icon.classList.toggle('fa-solid', isShared);
          icon.classList.toggle('fa-regular', !isShared);
      }

      function bindFollowButtons(post) {
          const btn = post.querySelector('.follow-btn');
          if (!btn) return;
          const postUsername = post.querySelector('.username').textContent.trim();

          function updateButton(button, isFollowing) {
              if (isFollowing) {
                  button.dataset.following = "true";
                  button.classList.add('following');
                  button.innerHTML = 'Abonn√© ‚úî';
                  button.disabled = true;
              } else {
                  button.dataset.following = "false";
                  button.classList.remove('following');
                  button.innerHTML = '<i class="fa-solid fa-plus"></i> Suivre';
                  button.disabled = false;
              }
          }

          if (!window.followingUsers) window.followingUsers = new Set();
          if (window.followingUsers.has(postUsername)) updateButton(btn, true);
          else updateButton(btn, btn.dataset.following === "true");

          btn.addEventListener('click', async () => {
              if (btn.dataset.following === "true") return;
              try {
                  const res = await fetch(`/follow/${encodeURIComponent(postUsername)}`, { method: 'POST', credentials: 'same-origin' });
                  if (!res.ok) throw new Error('Erreur serveur');
                  const data = await res.json();
                  if (data.following) {
                      window.followingUsers.add(postUsername);
                      document.querySelectorAll('.post').forEach(p => {
                          const usernameEl = p.querySelector('.username');
                          const followBtn = p.querySelector('.follow-btn');
                          if (usernameEl && followBtn && usernameEl.textContent.trim() === postUsername) {
                              updateButton(followBtn, true);
                          }
                      });
                      socket.emit("update_follow", { target_user: postUsername, following: true });
                  } else {
                      window.followingUsers.delete(postUsername);
                      updateButton(btn, false);
                      socket.emit("update_follow", { target_user: postUsername, following: false });
                  }
              } catch (e) {
                  console.error(e);
                  alert('Impossible de suivre pour le moment.');
              }
          });
      }

      function bindPostMenu(post) {
          const menuBtn = post.querySelector('.post-menu-btn');
          const menu = post.querySelector('.post-menu');
          if (!menuBtn || !menu) return;

          menuBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              const isActive = menu.classList.contains('active');
              document.querySelectorAll('.post-menu.active').forEach(m => m.classList.remove('active'));
              if (!isActive) {
                  menu.classList.add('active');
              }
          });

          const deleteBtn = menu.querySelector('.delete-btn');
          if (deleteBtn) {
              deleteBtn.addEventListener('click', async () => {
                  if (confirm("Voulez-vous vraiment supprimer cette publication ?")) {
                      const postId = post.dataset.postId;
                      try {
                          const res = await fetch(`/posts/${postId}`, { method: 'DELETE', credentials: 'same-origin' });
                          const data = await res.json();
                          if (data.success) {
                              post.remove();
                              if (!postsContainer.querySelector('.post')) {
                                  postsContainer.innerHTML = '<p style="color:#6b7280;">Aucune publication pour l‚Äôinstant.</p>';
                              }
                              socket.emit('post_deleted', { post_id: parseInt(postId) });
                          } else {
                              alert("Erreur : " + (data.error || "√âchec de la suppression"));
                          }
                      } catch (err) {
                          console.error(err);
                          alert("Erreur r√©seau lors de la suppression.");
                      }
                  }
                  menu.classList.remove('active');
              });
          }

          const boostBtn = menu.querySelector('.boost-btn');
          if (boostBtn) {
              boostBtn.addEventListener('click', async () => {
                  const postId = post.dataset.postId;
                  menu.classList.remove('active');
                  const choice = prompt("Choisissez la dur√©e:\n1. Un jour\n2. Une semaine\n3. Un mois\n4. Un an");
                  if (!choice) return;
                  const durations = {'1':1, '2':7, '3':30, '4':365};
                  const duration_days = durations[choice];
                  if (!duration_days) {
                      alert("Choix invalide");
                      return;
                  }
                  const pass1 = prompt("Entrez votre mot de passe ChronosMoney:");
                  if (!pass1) return;
                  try {
                      const res = await fetch(`/boost_init/${postId}`, {
                          method: 'POST',
                          headers: {'Content-Type': 'application/json'},
                          body: JSON.stringify({duration_days, password: pass1})
                      });
                      const data = await res.json();
                      if (!data.success) {
                          alert(data.error);
                          return;
                      }
                  } catch (e) {
                      alert("Erreur");
                      return;
                  }
                  const curr_choice = prompt("Choisissez la devise:\n1. Franc congolais (FC)\n2. Dollars (USD)");
                  if (!curr_choice) return;
                  const currencies = {'1':'franc', '2':'dollar'};
                  const currency = currencies[curr_choice];
                  if (!currency) {
                      alert("Choix invalide");
                      return;
                  }
                  const pass2 = prompt("Confirmez votre mot de passe ChronosMoney:");
                  if (!pass2) return;
                  try {
                      const res = await fetch(`/boost_confirm/${postId}`, {
                          method: 'POST',
                          headers: {'Content-Type': 'application/json'},
                          body: JSON.stringify({duration_days, currency, password: pass2})
                      });
                      const data = await res.json();
                      if (data.success) {
                          alert(data.message);
                          location.reload();
                      } else {
                          alert(data.error);
                      }
                  } catch (e) {
                      alert("Erreur");
                  }
              });
          }

          document.addEventListener('click', (e) => {
              if (!menu.contains(e.target) && !menuBtn.contains(e.target)) {
                  menu.classList.remove('active');
              }
          });
      }

      const ioObserver = new IntersectionObserver((entries) => {
          let best = null;
          entries.forEach(entry => {
              const vid = entry.target;
              const visible = entry.isIntersecting && entry.intersectionRatio >= 0.6;
              if (visible && !best) best = vid;
              if (!visible && !vid.paused) vid.pause();
          });
          if (best && currentVideo !== best) {
              if (currentVideo) currentVideo.pause();
              currentVideo = best;
              currentVideo.play().catch(() => {});
          }
      }, { threshold: [0, 0.25, 0.5, 0.75, 1] });

      function observeVideo(vid) {
          if (!videos.has(vid)) {
              videos.add(vid);
              ioObserver.observe(vid);
              vid.pause();
              vid.addEventListener('ended', () => {
                  vid.currentTime = 0;
                  vid.play().catch(() => {});
              });
              vid.addEventListener('click', (e) => {
                  if (e.target.classList.contains('mute-btn') || e.target.closest('.mute-btn')) return;
                  if (vid.paused) {
                      vid.play().catch(() => {});
                  } else {
                      vid.pause();
                  }
              });
              let startX, startTime, wasPlaying;
              vid.addEventListener('touchstart', (e) => {
                  const rect = vid.getBoundingClientRect();
                  if (e.touches[0].clientY < rect.top + rect.height / 2) return;
                  e.preventDefault();
                  startX = e.touches[0].clientX;
                  startTime = vid.currentTime;
                  wasPlaying = !vid.paused;
                  vid.pause();
              });
              vid.addEventListener('touchmove', (e) => {
                  if (startX === undefined) return;
                  e.preventDefault();
                  const deltaX = e.touches[0].clientX - startX;
                  const seekSeconds = deltaX / 10;
                  vid.currentTime = Math.max(0, Math.min(startTime + seekSeconds, vid.duration));
              });
              vid.addEventListener('touchend', (e) => {
                  if (startX === undefined) return;
                  e.preventDefault();
                  if (wasPlaying) vid.play().catch(() => {});
                  startX = undefined;
              });
          }
      }

      function bindMuteButton(video, muteBtn) {
          if (!muteBtn) return;
          muteBtn.addEventListener('click', () => {
              video.muted = !video.muted;
              const icon = muteBtn.querySelector('i');
              icon.classList.toggle('fa-volume-xmark', video.muted);
              icon.classList.toggle('fa-volume-high', !video.muted);
          });
      }

      function bindCommentForm(post) {
        const form = post.querySelector('.comment-form form');
        if (!form) return;
        const textarea = form.querySelector('textarea');
        const submitButton = form.querySelector('button');
        const postId = form.dataset.postId;
        const commentsBox = post.querySelector('#commentsBox-' + postId);

        form.addEventListener('submit', e => {
          e.preventDefault();
          let content = textarea.value.trim();
          if (!content) return;
          textarea.value = '';
          submitButton.disabled = true;
          fetch(`/comments/${postId}`, {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `comment=${encodeURIComponent(content)}`
          }).then(res => {
            if (res.ok) {
              return res.json().then(data => {
                const commentId = data.comment_id;
                const commentDiv = document.createElement('div');
                commentDiv.className = 'comment';
                commentDiv.dataset.commentId = commentId;
                const avatarHtml = data.avatar
                  ? `<a href="/profile/${encodeURIComponent(currentUsername)}"><img src="/avatars/${encodeURIComponent(data.avatar)}?t=${Date.now()}" alt="avatar" class="avatar-comment" /></a>`
                  : `<a href="/profile/${encodeURIComponent(currentUsername)}"><div class="avatar-fallback">${currentUsername[0].toUpperCase()}</div></a>`;
                commentDiv.innerHTML = `
                  ${avatarHtml}
                  <div class="comment-content">
                    <p><strong><a href="/profile/${encodeURIComponent(currentUsername)}">${currentUsername}</a></strong></p>
                    <p>${content}</p>
                    <small>${new Date().toLocaleString('fr-FR', { dateStyle: 'short', timeStyle: 'short' })}</small>
                  </div>
                `;
                const noComments = commentsBox.querySelector('.no-comments');
                if (noComments) noComments.remove();
                commentsBox.appendChild(commentDiv);
                commentsBox.scrollTop = commentsBox.scrollHeight;
                textarea.focus();
                const countEl = post.querySelector('.comment-count');
                countEl.textContent = parseInt(countEl.textContent || "0") + 1;
                socket.emit('send_comment', { post_id: parseInt(postId), comment_id: commentId, username: currentUsername, content, avatar: data.avatar });
              });
            } else {
              textarea.value = content;
            }
          }).catch(err => {
            console.error(err);
            textarea.value = content;
          }).finally(() => {
            submitButton.disabled = false;
          });
        });

        textarea.addEventListener('input', () => {
          submitButton.disabled = !textarea.value.trim();
        });
      }

      function bindCommentToggle(post) {
        const btn = post.querySelector('.comment-btn');
        const commentsSection = post.querySelector('.comments-section');
        if (!btn || !commentsSection) return;
        btn.addEventListener('click', () => {
          const isOpen = commentsSection.classList.contains('open');
          if (!isOpen) {
            commentsSection.classList.add('open');
            const commentsBox = commentsSection.querySelector('.comments-box');
            commentsBox.scrollTop = 0;
            history.pushState({ commentsOpen: true, postId: post.dataset.postId }, '', window.location.href);
          } else {
            commentsSection.classList.remove('open');
            history.back();
          }
          if (currentVideo) currentVideo.pause();
        });
      }

      function initCarousel(post) {
          const track = post.querySelector('.carousel-track');
          const dots = post.querySelectorAll('.carousel-indicators .dot');
          if (!track || dots.length === 0) return;
          Array.from(track.children).forEach(child => {
              child.style.width = '100%';
              child.style.flex = '0 0 100%';
          });
          track.style.overflowX = 'auto';
          track.style.scrollSnapType = 'x mandatory';
          track.addEventListener('scroll', () => {
              const index = Math.round(track.scrollLeft / track.offsetWidth);
              dots.forEach((dot, i) => dot.classList.toggle('active', i === index));
          });
          dots.forEach((dot, index) => {
              dot.addEventListener('click', () => {
                  track.scrollTo({
                      left: index * track.offsetWidth,
                      behavior: 'smooth'
                  });
              });
          });
      }

      document.querySelectorAll('.post').forEach(post => {
          bindLikes(post);
          bindShareButtons(post);
          bindFollowButtons(post);
          bindPostMenu(post);
          bindCommentForm(post);
          bindCommentToggle(post);
          post.querySelectorAll('video').forEach(video => {
              observeVideo(video);
              const muteBtn = video.parentElement.querySelector('.mute-btn');
              bindMuteButton(video, muteBtn);
          });
          const description = post.querySelector('.description');
          const toggleButton = post.querySelector('.toggle-description');
          if (description && toggleButton) {
              if (description.scrollHeight > description.clientHeight) {
                  description.classList.add('long');
              }
              toggleButton.addEventListener('click', () => {
                  if (description.classList.contains('expanded')) {
                      description.classList.remove('expanded');
                      toggleButton.textContent = 'Afficher plus';
                  } else {
                      description.classList.add('expanded');
                      toggleButton.textContent = 'Afficher moins';
                  }
              });
          }
          initCarousel(post);
      });

      document.querySelectorAll('.post img').forEach(img => {
          img.addEventListener('click', () => { if (currentVideo) currentVideo.pause(); });
      });

      window.addEventListener('popstate', () => {
        document.querySelectorAll('.comments-section.open').forEach(section => {
          section.classList.remove('open');
        });
      });
  });
  </script>
</body>
</html>
