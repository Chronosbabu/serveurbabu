<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Recherche</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    /* ---------- GLOBAL ---------- */
    :root {
      --bg-color: #fafafa;
      --text-color: #262626;
      --border-color: #dbdbdb;
      --card-bg: #fff;
      --link-hover: #0095f6;
      --shadow-color: rgba(0,0,0,0.05);
      --button-bg: #0095f6;
      --button-hover: #00376b;
      --comment-form-bg: #fff;
      --textarea-bg: #fafafa;
      --no-results-color: #8e8e8e;
    }

    [data-theme="dark"] {
      --bg-color: #1a1a1a;
      --text-color: #e0e0e0;
      --border-color: #333;
      --card-bg: #262626;
      --link-hover: #4dabf7;
      --shadow-color: rgba(0,0,0,0.3);
      --button-bg: #4dabf7;
      --button-hover: #1c6dd0;
      --comment-form-bg: #262626;
      --textarea-bg: #333;
      --no-results-color: #6b7280;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      line-height: 1.5;
      overflow-x: hidden;
    }
    a { text-decoration: none; color: inherit; }
    .main-container { max-width: 935px; margin: 0 auto; padding: 20px 20px 80px 20px; }

    /* ---------- HEADER ---------- */
    .main-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 20px;
      background: var(--card-bg);
      border-bottom: 1px solid var(--border-color);
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 1px 2px var(--shadow-color);
    }
    .logo {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--text-color);
      font-family: 'Lobster', cursive;
      letter-spacing: 1px;
      flex-shrink: 0;
    }
    .header-icons {
      display: flex;
      align-items: center;
      gap: 24px;
      flex-wrap: nowrap;
    }
    .header-icons a, .header-icons button {
      color: var(--text-color);
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: color 0.2s ease, transform 0.2s ease;
      background: none;
      border: none;
      cursor: pointer;
    }
    .header-icons a:hover, .header-icons button:hover {
      color: var(--link-hover);
      transform: scale(1.1);
    }

    /* ---------- BOTTOM NAVIGATION BAR ---------- */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: var(--card-bg);
      border-top: 1px solid var(--border-color);
      display: flex;
      justify-content: space-around;
      align-items: center;
      padding: 12px 0;
      z-index: 1000;
      box-shadow: 0 -1px 2px var(--shadow-color);
    }
    .bottom-nav a {
      color: var(--text-color);
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: color 0.2s ease, transform 0.2s ease;
    }
    .bottom-nav a:hover {
      color: var(--link-hover);
      transform: scale(1.1);
    }
    .bottom-nav a.active {
      color: var(--link-hover);
    }

    /* ---------- SEARCH SECTION ---------- */
    .search-section {
      margin: 20px 0;
    }
    .search-section form {
      display: flex;
      gap: 8px;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 8px;
    }
    .search-section input {
      flex: 1;
      padding: 8px;
      border: none;
      font-size: 0.9rem;
      outline: none;
      background: transparent;
      color: var(--text-color);
    }
    .search-section button {
      padding: 8px 12px;
      border: none;
      background: var(--button-bg);
      color: #fff;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s ease, transform 0.2s ease;
    }
    .search-section button:hover {
      background: var(--button-hover);
      transform: scale(1.05);
    }

    /* ---------- USERS AND POSTS ---------- */
    .scroll-box {
      padding: 20px 0;
    }
    .section-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin: 20px 0 12px;
      color: var(--text-color);
    }
    .user-item {
      display: flex;
      align-items: center;
      gap: 12px;
      background: var(--card-bg);
      padding: 12px 16px;
      border: 1px solid var(--border-color);
      border-radius: 12px;
      margin-bottom: 12px;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .user-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 2px 8px var(--shadow-color);
    }
    .post {
      background: var(--card-bg);
      margin-bottom: 24px;
      border: 1px solid var(--border-color);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px var(--shadow-color);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .post:hover {
      transform: translateY(-4px);
      box-shadow: 0 4px 12px var(--shadow-color);
    }
    .user-info {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border-color);
    }
    .avatar-user, .avatar-post, .avatar-fallback {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      object-fit: cover;
      background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 1.1rem;
      color: #fff;
      border: 2px solid var(--card-bg);
      box-shadow: 0 0 0 1px var(--shadow-color);
      transition: transform 0.2s ease;
    }
    .avatar-user:hover, .avatar-post:hover, .avatar-fallback:hover {
      transform: scale(1.05);
    }
    .username-link {
      font-weight: 600;
      font-size: 0.95rem;
      color: var(--text-color);
      transition: color 0.2s ease;
    }
    .username-link:hover {
      color: var(--link-hover);
    }
    .description {
      padding: 12px 16px;
      font-size: 0.9rem;
      line-height: 1.4;
      word-wrap: break-word;
      overflow-wrap: break-word;
      overflow: hidden;
      display: -webkit-box;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: 2;
      position: relative;
    }
    .description.expanded {
      -webkit-line-clamp: unset;
    }
    .toggle-description {
      display: none;
      color: var(--link-hover);
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 600;
      padding: 0 16px 12px 16px;
      transition: color 0.2s ease;
    }
    .toggle-description:hover {
      color: var(--button-hover);
    }
    .description.long + .toggle-description {
      display: block;
    }

    /* ---------- MEDIA ---------- */
    .post-image, video {
      width: 100%;
      max-height: 80vh;
      object-fit: cover;
      display: block;
      background: #000;
      cursor: pointer;
    }
    .video-container {
      position: relative;
    }
    .mute-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1rem;
      z-index: 10;
      transition: background 0.2s ease, transform 0.2s ease;
    }
    .mute-btn:hover {
      background: rgba(0, 0, 0, 0.9);
      transform: scale(1.1);
    }

    /* ---------- CAROUSEL MULTIMEDIA ---------- */
    .carousel {
      position: relative;
      width: 100%;
      overflow: hidden;
    }
    .carousel-track {
      display: flex;
      width: 100%;
      overflow-x: auto;
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      scroll-behavior: smooth;
    }
    .carousel-track::-webkit-scrollbar { display: none; }
    .carousel-track > * {
      flex: 0 0 100%;
      width: 100%;
      scroll-snap-align: start;
    }
    .carousel-indicators {
      position: absolute;
      bottom: 12px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 8px;
      z-index: 10;
    }
    .carousel-indicators .dot {
      width: 8px;
      height: 8px;
      background: rgba(255, 255, 255, 0.5);
      border-radius: 50%;
      transition: transform 0.2s ease, background 0.2s ease;
      cursor: pointer;
    }
    .carousel-indicators .dot.active {
      background: #fff;
      transform: scale(1.4);
    }

    /* ---------- ACTIONS ---------- */
    .post-actions {
      display: flex;
      align-items: center;
      padding: 8px 16px;
      border-top: 1px solid var(--border-color);
    }
    .like-btn {
      border: none;
      background: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-color);
      transition: transform 0.2s ease, color 0.2s ease;
    }
    .like-btn:hover {
      transform: scale(1.15);
      color: #ed4956;
    }
    .like-btn.liked {
      color: #ed4956;
      animation: heart-bounce 0.3s ease;
    }
    @keyframes heart-bounce {
      0% { transform: scale(1); }
      50% { transform: scale(1.3); }
      100% { transform: scale(1); }
    }
    .comment-btn {
      display: flex;
      align-items: center;
      margin-left: 16px;
      font-size: 1.5rem;
      color: var(--text-color);
      transition: transform 0.2s ease, color 0.2s ease;
    }
    .comment-btn:hover {
      transform: scale(1.15);
      color: var(--link-hover);
    }
    .like-count, .comment-count {
      margin-left: 8px;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-color);
    }
    .follow-btn {
      margin-left: auto;
      background: var(--button-bg);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 6px 16px;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: background 0.2s ease, transform 0.2s ease;
    }
    .follow-btn i {
      font-size: 0.9rem;
    }
    .follow-btn:hover {
      background: var(--button-hover);
      transform: scale(1.05);
    }
    .follow-btn.following {
      background: var(--textarea-bg);
      color: var(--text-color);
      border: 1px solid var(--border-color);
      cursor: not-allowed;
    }
    .follow-btn.following:hover {
      background: var(--border-color);
      transform: none;
    }

    /* ---------- DATE ---------- */
    .date {
      font-size: 0.75rem;
      color: var(--no-results-color);
      padding: 8px 16px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* ---------- COMMENTS ---------- */
    .comments-section {
      display: none;
      flex-direction: column;
      height: 300px;
      position: relative;
      border-top: 1px solid var(--border-color);
    }
    .comments-section.open {
      display: flex;
    }
    .comments-box {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      scrollbar-width: none;
    }
    .comments-box::-webkit-scrollbar { display: none; }
    .comment {
      display: flex;
      align-items: flex-start;
      padding: 8px 0;
      opacity: 1;
      z-index: 1;
    }
    .avatar-comment, .avatar-fallback {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      object-fit: cover;
      background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 1rem;
      color: #fff;
      border: 2px solid var(--card-bg);
      box-shadow: 0 0 0 1px var(--shadow-color);
      margin-right: 10px;
      transition: transform 0.2s ease;
    }
    .avatar-comment:hover, .avatar-fallback:hover {
      transform: scale(1.05);
    }
    .comment-content {
      flex: 1;
      max-width: calc(100% - 46px);
    }
    .comment-content p:first-child {
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--text-color);
    }
    .comment-content p:first-child a:hover {
      color: var(--link-hover);
    }
    .comment-content p:nth-child(2) {
      font-size: 0.85rem;
      color: var(--text-color);
      word-wrap: break-word;
      overflow-wrap: break-word;
      white-space: normal;
      max-width: 100%;
      line-height: 1.4;
    }
    .comment-content small {
      font-size: 0.75rem;
      color: var(--no-results-color);
      display: block;
      margin-top: 4px;
    }
    .no-comments {
      font-size: 0.9rem;
      color: var(--no-results-color);
      text-align: center;
      padding: 16px 0;
    }

    /* ---------- COMMENT FORM ---------- */
    .comment-form {
      padding: 12px 16px;
      border-top: 1px solid var(--border-color);
      background: var(--comment-form-bg);
      position: sticky;
      bottom: 0;
      width: 100%;
      z-index: 20;
    }
    .comment-form form {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .comment-form textarea {
      flex: 1;
      padding: 8px 12px;
      font-size: 0.85rem;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      resize: none;
      height: 40px;
      background: var(--textarea-bg);
      color: var(--text-color);
      font-family: inherit;
      word-wrap: break-word;
      overflow-wrap: break-word;
      white-space: pre-wrap;
    }
    .comment-form textarea:focus {
      outline: none;
      border-color: var(--link-hover);
      box-shadow: 0 0 0 1px var(--link-hover);
    }
    .comment-form button {
      background: var(--button-bg);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.2s ease;
    }
    .comment-form button:hover {
      background: var(--button-hover);
      transform: scale(1.05);
    }
    .comment-form button:disabled {
      background: #b2dffc;
      cursor: not-allowed;
    }

    /* ---------- RESPONSIVE ---------- */
    @media (max-width: 600px) {
      .main-container { padding: 16px 16px 70px 16px; }
      .avatar-user, .avatar-post, .avatar-fallback, .avatar-comment { width: 36px; height: 36px; font-size: 0.9rem; }
      .post-image, video { max-height: 70vh; }
      .header-icons { gap: 16px; }
      .header-icons a, .header-icons button { font-size: 1.3rem; }
      .bottom-nav { padding: 10px 0; }
      .bottom-nav a { font-size: 1.3rem; }
      .mute-btn { width: 28px; height: 28px; font-size: 0.9rem; }
      .logo { font-size: 1.5rem; }
      .post { margin-bottom: 16px; }
      .user-item { padding: 10px 12px; }
      .user-info { padding: 10px 12px; }
      .username-link { font-size: 0.9rem; }
      .description { font-size: 0.85rem; padding: 10px 12px; }
      .post-actions { padding: 6px 12px; }
      .follow-btn { padding: 5px 12px; font-size: 0.8rem; }
      .date { padding: 6px 12px; }
      .search-section form { padding: 6px; }
      .search-section input { font-size: 0.85rem; }
      .search-section button { padding: 6px 10px; }
      .comments-section { height: 250px; }
      .comment-form { padding: 10px 12px; }
      .comment-form textarea { font-size: 0.8rem; height: 36px; }
      .comment-form button { padding: 6px 12px; font-size: 0.8rem; }
    }
  </style>
</head>
<body data-username="{{ current_username }}" data-theme="light">
  <div class="main-container">
    <header class="main-header">
      <h2 class="logo">CHRONOS</h2>
      <nav class="header-icons">
        <a href="{{ url_for('index') }}" title="Accueil"><i class="fa-solid fa-house"></i></a>
        <a href="{{ url_for('add_post') }}" title="Nouvelle publication"><i class="fa-solid fa-circle-plus"></i></a>
        <a href="{{ url_for('profile', username=current_username) }}" title="Profil"><i class="fa-regular fa-user"></i></a>
        <a href="{{ url_for('conversations') }}" title="Messages"><i class="fa-regular fa-message"></i></a>
        <button id="theme-toggle" title="Changer de thème"><i class="fa-solid fa-moon"></i></button>
      </nav>
    </header>

    <section class="search-section">
      <form method="GET" id="search-form">
        <input type="text" name="q" placeholder="Rechercher un utilisateur ou un sujet..." value="{{ query }}" id="search-input" />
        <button type="submit" title="Rechercher"><i class="fa-solid fa-magnifying-glass"></i></button>
      </form>
    </section>

    <!-- Résultats utilisateurs -->
    <div class="section-title"><i class="fa-solid fa-users"></i> Utilisateurs trouvés</div>
    <main class="scroll-box" id="users-results">
      {% if users|length == 0 %}
        <p style="color: var(--no-results-color);">Aucun utilisateur trouvé.</p>
      {% else %}
        {% for user in users %}
        <div class="user-item">
          {% if user.avatar %}
            <a href="{{ url_for('profile', username=user.username) }}">
              <img src="{{ url_for('avatar_file', filename=user.avatar) }}" alt="avatar" class="avatar-user" />
            </a>
          {% else %}
            <a href="{{ url_for('profile', username=user.username) }}">
              <div class="avatar-fallback">{{ user.username[:1]|upper }}</div>
            </a>
          {% endif %}
          <a class="username-link" href="{{ url_for('profile', username=user.username) }}">
            {{ user.username }}
          </a>
        </div>
        {% endfor %}
      {% endif %}
    </main>

    <!-- Résultats publications -->
    <div class="section-title"><i class="fa-solid fa-newspaper"></i> Publications correspondantes</div>
    <section class="scroll-box" id="posts-results">
      {% if posts|length == 0 %}
        <p style="color: var(--no-results-color);">Aucune publication trouvée.</p>
      {% else %}
        {% for post in posts %}
        <div class="post" data-post-id="{{ post.id }}">
          <div class="user-info">
            {% if post.avatar %}
            <a class="avatar-link" href="{{ url_for('profile', username=post.username) }}">
              <img src="{{ url_for('avatar_file', filename=post.avatar) }}" alt="avatar" class="avatar-post" />
            </a>
            {% else %}
            <a class="avatar-link" href="{{ url_for('profile', username=post.username) }}">
              <div class="avatar-fallback">{{ post.username[:1]|upper }}</div>
            </a>
            {% endif %}
            <a class="username-link" href="{{ url_for('profile', username=post.username) }}">
              <p class="username">{{ post.username }}</p>
            </a>
          </div>
          <p class="description">{{ post.description }}</p>
          <span class="toggle-description">Afficher plus</span>
          {# ---- Single file ---- #}
          {% if post.type == "image" and not post.files %}
          <img src="{{ url_for('uploaded_file', filename=post.file) }}" alt="image" class="post-image" />
          {% elif post.type == "video" and not post.files %}
          <div class="video-container">
            <video src="{{ url_for('uploaded_file', filename=post.file) }}" muted loop loop class="post-video"></video>
            <button class="mute-btn" title="Activer/Désactiver le son">
              <i class="fa-solid fa-volume-xmark"></i>
            </button>
          </div>
          {% endif %}

          {# ---- Multiple files (carousel) ---- #}
          {% if post.files|length > 0 %}
          <div class="carousel">
            <div class="carousel-track">
              {% for file in post.files %}
              {% if file.type == "image" %}
              <img src="{{ url_for('uploaded_file', filename=file.name) }}" alt="image" class="post-image" />
              {% elif file.type == "video" %}
              <div class="video-container">
                <video src="{{ url_for('uploaded_file', filename=file.name) }}" muted loop class="post-video"></video>
                <button class="mute-btn" title="Activer/Désactiver le son">
                  <i class="fa-solid fa-volume-xmark"></i>
                </button>
              </div>
              {% endif %}
              {% endfor %}
            </div>
            <div class="carousel-indicators">
              {% for file in post.files %}
              <span class="dot{% if loop.first %} active{% endif %}"></span>
              {% endfor %}
            </div>
          </div>
          {% endif %}

          <div class="post-actions">
            <button class="like-btn{% if post.liked_by_user %} liked{% endif %}" data-liked="{{ 'true' if post.liked_by_user else 'false' }}">
              <i class="{% if post.liked_by_user %}fa-solid{% else %}fa-regular{% endif %} fa-heart"></i>
            </button>
            <span class="like-count">{{ post.likes if post.likes else 0 }}</span>
            <button class="comment-btn">
              <i class="fa-regular fa-comment"></i>
              <span class="comment-count">{{ post.comments_count if post.comments_count else 0 }}</span>
            </button>
            <button class="follow-btn{% if post.following %} following{% endif %}" data-following="{{ 'true' if post.following else 'false' }}">
              {% if post.following %}
              Abonné ✔
              {% else %}
              <i class="fa-solid fa-plus"></i> Suivre
              {% endif %}
            </button>
          </div>
          <p class="date">Publié le {{ post.date }}</p>
          <section class="comments-section" id="comments-{{ post.id }}">
            <div class="comments-box" id="commentsBox-{{ post.id }}">
              {% if post.comments|length == 0 %}
                <p class="no-comments">Aucun commentaire pour l’instant.</p>
              {% else %}
                {% for comment in post.comments %}
                <div class="comment">
                  {% if comment.avatar %}
                  <a href="{{ url_for('profile', username=comment.username) }}">
                    <img src="{{ url_for('avatar_file', filename=comment.avatar) }}?t={{ 'now'|timestamp }}" alt="avatar" class="avatar-comment" />
                  </a>
                  {% else %}
                  <a href="{{ url_for('profile', username=comment.username) }}">
                    <div class="avatar-fallback">{{ comment.username[:1]|upper }}</div>
                  </a>
                  {% endif %}
                  <div class="comment-content">
                    <p><strong><a href="{{ url_for('profile', username=comment.username) }}">{{ comment.username }}</a></strong></p>
                    <p>{{ comment.content }}</p>
                    <small>{{ comment.date }}</small>
                  </div>
                </div>
                {% endfor %}
              {% endif %}
            </div>
            <div class="comment-form">
              <form data-post-id="{{ post.id }}">
                <textarea name="comment" placeholder="Écrire un commentaire..." required></textarea>
                <button type="submit">Commenter</button>
              </form>
            </div>
          </section>
        </div>
        {% endfor %}
      {% endif %}
    </section>

    <nav class="bottom-nav">
      <a href="{{ url_for('notifications') }}" title="Notifications"><i class="fa-regular fa-bell"></i></a>
      <a href="{{ url_for('search_users') }}" title="Rechercher" class="active"><i class="fa-solid fa-magnifying-glass"></i></a>
      <a href="{{ url_for('login') }}" title="Déconnexion" class="logout-btn"><i class="fa-solid fa-right-from-bracket"></i></a>
    </nav>
  </div>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const currentUsername = document.body.dataset.username;
    const postsContainer = document.getElementById('posts-results');
    const usersContainer = document.getElementById('users-results');
    const videos = new Set();
    let currentVideo = null;
    const socket = io();

    // Initialize global Sets for tracking likes and follows
    if (!window.likedPosts) window.likedPosts = new Set();
    if (!window.followingUsers) window.followingUsers = new Set();

    // Theme toggle functionality
    const themeToggleBtn = document.getElementById('theme-toggle');
    const body = document.body;

    function setTheme(theme) {
      body.dataset.theme = theme;
      localStorage.setItem('theme', theme);
      const icon = themeToggleBtn.querySelector('i');
      icon.classList.toggle('fa-moon', theme === 'light');
      icon.classList.toggle('fa-sun', theme === 'dark');
    }

    // Load saved theme or default to light
    const savedTheme = localStorage.getItem('theme') || 'light';
    setTheme(savedTheme);

    if (themeToggleBtn) {
      themeToggleBtn.addEventListener('click', () => {
        const newTheme = body.dataset.theme === 'light' ? 'dark' : 'light';
        setTheme(newTheme);
      });
    }

    function debounce(func, delay) {
      let timeout;
      return function() {
        clearTimeout(timeout);
        timeout = setTimeout(func, delay);
      };
    }

    const searchInput = document.getElementById('search-input');
    if (searchInput) {
      searchInput.addEventListener('input', debounce(() => {
        const query = searchInput.value.trim();
        if (query) {
          fetch(`/search?q=${encodeURIComponent(query)}`)
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const doc = parser.parseFromString(html, 'text/html');

              // Update users
              const newUsers = doc.querySelector('#users-results');
              if (newUsers) {
                usersContainer.innerHTML = newUsers.innerHTML;
              }

              // Update posts
              const newPosts = doc.querySelector('#posts-results');
              if (newPosts) {
                postsContainer.innerHTML = newPosts.innerHTML;
                // Re-initialize JS on new posts
                postsContainer.querySelectorAll('.post').forEach(post => {
                  const postId = post.dataset.postId;
                  const postUsername = post.querySelector('.username').textContent.trim();
                  // Restore like state
                  if (window.likedPosts.has(parseInt(postId))) {
                    const likeBtn = post.querySelector('.like-btn');
                    likeBtn.classList.add('liked');
                    likeBtn.dataset.liked = 'true';
                    const icon = likeBtn.querySelector('i');
                    icon.classList.add('fa-solid');
                    icon.classList.remove('fa-regular');
                  }
                  // Restore follow state
                  if (window.followingUsers.has(postUsername)) {
                    const followBtn = post.querySelector('.follow-btn');
                    followBtn.classList.add('following');
                    followBtn.dataset.following = 'true';
                    followBtn.innerHTML = 'Abonné ✔';
                    followBtn.disabled = true;
                  }
                  bindLikes(post);
                  bindFollowButtons(post);
                  bindCommentToggle(post);
                  bindCommentForm(post);
                  post.querySelectorAll('video').forEach(video => observeVideo(video));
                  const muteBtn = post.querySelector('.mute-btn');
                  if (muteBtn) bindMuteButton(video, muteBtn);
                  initCarousel(post);
                  const description = post.querySelector('.description');
                  const toggleButton = post.querySelector('.toggle-description');
                  if (description && toggleButton) {
                    if (description.scrollHeight > description.clientHeight) {
                      description.classList.add('long');
                    }
                    toggleButton.addEventListener('click', () => {
                      if (description.classList.contains('expanded')) {
                        description.classList.remove('expanded');
                        toggleButton.textContent = 'Afficher plus';
                      } else {
                        description.classList.add('expanded');
                        toggleButton.textContent = 'Afficher moins';
                      }
                    });
                  }
                });
              }
            })
            .catch(err => console.error(err));
        } else {
          // Clear results if query is empty
          usersContainer.innerHTML = '<p style="color: var(--no-results-color);">Aucun utilisateur trouvé.</p>';
          postsContainer.innerHTML = '<p style="color: var(--no-results-color);">Aucune publication trouvée.</p>';
        }
      }, 300));
    }

    /* ---------- Video autoplay and loop ---------- */
    const ioObserver = new IntersectionObserver((entries) => {
        let best = null;
        entries.forEach(entry => {
            const vid = entry.target;
            const visible = entry.isIntersecting && entry.intersectionRatio >= 0.6;
            if (visible && !best) best = vid;
            if (!visible && !vid.paused) vid.pause();
        });
        if (best && currentVideo !== best) {
            if (currentVideo) currentVideo.pause();
            currentVideo = best;
            currentVideo.play().catch(() => {});
        }
    }, { threshold: [0, 0.25, 0.5, 0.75, 1] });

    function observeVideo(vid) {
        if (!videos.has(vid)) {
            videos.add(vid);
            ioObserver.observe(vid);
            vid.pause();
            vid.addEventListener('ended', () => {
                vid.currentTime = 0;
                vid.play().catch(() => {});
            });
            vid.addEventListener('click', (e) => {
                if (e.target.classList.contains('mute-btn') || e.target.closest('.mute-btn')) return;
                if (vid.paused) {
                    vid.play().catch(() => {});
                } else {
                    vid.pause();
                }
            });
        }
    }

    /* ---------- Mute button functionality ---------- */
    function bindMuteButton(video, muteBtn) {
        if (!muteBtn) return;
        muteBtn.addEventListener('click', () => {
            video.muted = !video.muted;
            const icon = muteBtn.querySelector('i');
            icon.classList.toggle('fa-volume-xmark', video.muted);
            icon.classList.toggle('fa-volume-high', !video.muted);
        });
    }

    async function toggleLike(button) {
        const post = button.closest('.post');
        const postId = parseInt(post.dataset.postId);
        const countEl = post.querySelector('.like-count');
        try {
            const res = await fetch(`/like/${postId}`, { method: 'POST', credentials: 'same-origin' });
            if (!res.ok) return;
            const data = await res.json();
            countEl.textContent = data.likes;
            button.classList.toggle('liked', data.liked);
            button.dataset.liked = data.liked.toString();
            const icon = button.querySelector('i');
            icon.classList.toggle('fa-solid', data.liked);
            icon.classList.toggle('fa-regular', !data.liked);
            if (data.liked) {
                window.likedPosts.add(postId);
            } else {
                window.likedPosts.delete(postId);
            }
            socket.emit('like_updated', { post_id: postId, likes: data.likes, liked: data.liked });
        } catch (err) { console.error(err); }
    }

    function bindLikes(post) {
        const btn = post.querySelector('.like-btn');
        if (!btn) return;
        const postId = parseInt(post.dataset.postId);
        if (window.likedPosts.has(postId)) {
            btn.classList.add('liked');
            btn.dataset.liked = 'true';
            const icon = btn.querySelector('i');
            icon.classList.add('fa-solid');
            icon.classList.remove('fa-regular');
        }
        btn.addEventListener('click', () => toggleLike(btn));
    }

    function bindFollowButtons(post) {
        const btn = post.querySelector('.follow-btn');
        if (!btn) return;
        const postUsername = post.querySelector('.username').textContent.trim();

        function updateButton(button, isFollowing) {
            if (isFollowing) {
                button.dataset.following = "true";
                button.classList.add('following');
                button.innerHTML = 'Abonné ✔';
                button.disabled = true; // Disable button to prevent unfollow
            } else {
                button.dataset.following = "false";
                button.classList.remove('following');
                button.innerHTML = '<i class="fa-solid fa-plus"></i> Suivre';
                button.disabled = false;
            }
        }

        // Initialize button state based on window.followingUsers
        if (window.followingUsers.has(postUsername)) {
            updateButton(btn, true);
        } else {
            updateButton(btn, btn.dataset.following === "true");
        }

        btn.addEventListener('click', async () => {
            if (btn.dataset.following === "true") return; // Prevent any action if already following
            try {
                const res = await fetch(`/follow/${encodeURIComponent(postUsername)}`, { method: 'POST', credentials: 'same-origin' });
                if (!res.ok) throw new Error('Erreur serveur');
                const data = await res.json();
                if (data.following) {
                    window.followingUsers.add(postUsername);
                    document.querySelectorAll('.post').forEach(p => {
                        const usernameEl = p.querySelector('.username');
                        const followBtn = p.querySelector('.follow-btn');
                        if (usernameEl && followBtn && usernameEl.textContent.trim() === postUsername) {
                            updateButton(followBtn, true);
                        }
                    });
                }
            } catch (e) {
                console.error(e);
                alert('Impossible de suivre pour le moment.');
            }
        });
    }

    /* ---------- Comment Form Submission --- */
    function bindCommentForm(post) {
      const form = post.querySelector('.comment-form form');
      if (!form) return;
      const textarea = form.querySelector('textarea');
      const submitButton = form.querySelector('button');
      const postId = form.dataset.postId;
      const commentsBox = post.querySelector('#commentsBox-' + postId);

      form.addEventListener('submit', e => {
        e.preventDefault();
        let content = textarea.value.trim();
        if (!content) return;
        textarea.value = '';
        submitButton.disabled = true;
        fetch(`/comments/${postId}`, {
          method: 'POST',
          credentials: 'same-origin',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: `comment=${encodeURIComponent(content)}`
        }).then(res => {
          if (res.ok) {
            return res.json().then(data => {
              const commentId = data.comment_id;
              const commentDiv = document.createElement('div');
              commentDiv.className = 'comment';
              commentDiv.dataset.commentId = commentId;
              const avatarHtml = data.avatar
                ? `<a href="/profile/${encodeURIComponent(currentUsername)}"><img src="/avatars/${encodeURIComponent(data.avatar)}?t=${Date.now()}" alt="avatar" class="avatar-comment" /></a>`
                : `<a href="/profile/${encodeURIComponent(currentUsername)}"><div class="avatar-fallback">${currentUsername[0].toUpperCase()}</div></a>`;
              commentDiv.innerHTML = `
                ${avatarHtml}
                <div class="comment-content">
                  <p><strong><a href="/profile/${encodeURIComponent(currentUsername)}">${currentUsername}</a></strong></p>
                  <p>${content}</p>
                  <small>${new Date().toLocaleString('fr-FR', { dateStyle: 'short', timeStyle: 'short' })}</small>
                </div>
              `;
              const noComments = commentsBox.querySelector('.no-comments');
              if (noComments) noComments.remove();
              commentsBox.appendChild(commentDiv);
              commentsBox.scrollTop = commentsBox.scrollHeight;
              textarea.focus();
              const countEl = post.querySelector('.comment-count');
              countEl.textContent = parseInt(countEl.textContent || "0") + 1;
              socket.emit('send_comment', { post_id: parseInt(postId), comment_id: commentId, username: currentUsername, content, avatar: data.avatar });
            });
          } else {
            textarea.value = content;
          }
        }).catch(err => {
          console.error(err);
          textarea.value = content;
        }).finally(() => {
          submitButton.disabled = false;
        });
      });

      textarea.addEventListener('input', () => {
        submitButton.disabled = !textarea.value.trim();
      });
    }

    /* ---------- Comments Toggle --- */
    function bindCommentToggle(post) {
      const btn = post.querySelector('.comment-btn');
      const commentsSection = post.querySelector('.comments-section');
      if (!btn || !commentsSection) return;
      btn.addEventListener('click', () => {
        const isOpen = commentsSection.classList.contains('open');
        if (!isOpen) {
          commentsSection.classList.add('open');
          const commentsBox = commentsSection.querySelector('.comments-box');
          commentsBox.scrollTop = 0;
          history.pushState({ commentsOpen: true, postId: post.dataset.postId }, '', window.location.href);
        } else {
          commentsSection.classList.remove('open');
          history.back();
        }
        if (currentVideo) currentVideo.pause();
      });
    }

    /* ---------- Carousel Initialization ---------- */
    function initCarousel(post) {
      const track = post.querySelector('.carousel-track');
      const dots = post.querySelectorAll('.carousel-indicators .dot');
      if (!track || dots.length === 0) return;

      Array.from(track.children).forEach(child => {
        child.style.width = '100%';
        child.style.flex = '0 0 100%';
      });

      track.style.overflowX = 'auto';
      track.style.scrollSnapType = 'x mandatory';

      track.addEventListener('scroll', () => {
        const index = Math.round(track.scrollLeft / track.offsetWidth);
        dots.forEach((dot, i) => dot.classList.toggle('active', i === index));
      });

      dots.forEach((dot, index) => {
        dot.addEventListener('click', () => {
          track.scrollTo({
            left: index * track.offsetWidth,
            behavior: 'smooth'
          });
        });
      });
    }

    // Initialize all posts
    document.querySelectorAll('.post').forEach(post => {
      const postId = parseInt(post.dataset.postId);
      const postUsername = post.querySelector('.username').textContent.trim();
      // Restore like state
      if (window.likedPosts.has(postId)) {
        const likeBtn = post.querySelector('.like-btn');
        likeBtn.classList.add('liked');
        likeBtn.dataset.liked = 'true';
        const icon = likeBtn.querySelector('i');
        icon.classList.add('fa-solid');
        icon.classList.remove('fa-regular');
      }
      // Restore follow state
      if (window.followingUsers.has(postUsername)) {
        const followBtn = post.querySelector('.follow-btn');
        followBtn.classList.add('following');
        followBtn.dataset.following = 'true';
        followBtn.innerHTML = 'Abonné ✔';
        followBtn.disabled = true;
      }
      bindLikes(post);
      bindFollowButtons(post);
      bindCommentToggle(post);
      bindCommentForm(post);
      post.querySelectorAll('video').forEach(video => {
        observeVideo(video);
        const muteBtn = video.parentElement.querySelector('.mute-btn');
        bindMuteButton(video, muteBtn);
      });
      const description = post.querySelector('.description');
      const toggleButton = post.querySelector('.toggle-description');
      if (description && toggleButton) {
        if (description.scrollHeight > description.clientHeight) {
          description.classList.add('long');
        }
        toggleButton.addEventListener('click', () => {
          if (description.classList.contains('expanded')) {
            description.classList.remove('expanded');
            toggleButton.textContent = 'Afficher plus';
          } else {
            description.classList.add('expanded');
            toggleButton.textContent = 'Afficher moins';
          }
        });
      }
      initCarousel(post);
    });

    document.querySelectorAll('.post img').forEach(img => {
      img.addEventListener('click', () => { if (currentVideo) currentVideo.pause(); });
    });

    socket.on('like_updated', data => {
      const post = document.querySelector(`.post[data-post-id="${data.post_id}"]`);
      if (post) {
        const countEl = post.querySelector('.like-count');
        if (countEl) countEl.textContent = data.likes;
        const btn = post.querySelector('.like-btn');
        if (btn) {
          btn.classList.toggle('liked', data.liked);
          btn.dataset.liked = data.liked.toString();
          const icon = btn.querySelector('i');
          icon.classList.toggle('fa-solid', data.liked);
          icon.classList.toggle('fa-regular', !data.liked);
          if (data.liked) {
            window.likedPosts.add(data.post_id);
          } else {
            window.likedPosts.delete(data.post_id);
          }
        }
      }
    });

    socket.on('new_comment', data => {
      const post = document.querySelector(`.post[data-post-id="${data.post_id}"]`);
      if (!post) return;
      const commentsBox = post.querySelector('#commentsBox-' + data.post_id);
      if (!commentsBox) return;

      const existingComment = commentsBox.querySelector(`.comment[data-comment-id="${data.comment_id}"]`);
      if (!existingComment) {
        const commentDiv = document.createElement('div');
        commentDiv.className = 'comment';
        commentDiv.dataset.commentId = data.comment_id;
        const avatarHtml = data.avatar
          ? `<a href="/profile/${encodeURIComponent(data.username)}"><img src="/avatars/${encodeURIComponent(data.avatar)}?t=${Date.now()}" alt="avatar" class="avatar-comment" /></a>`
          : `<a href="/profile/${encodeURIComponent(data.username)}"><div class="avatar-fallback">${data.username[0].toUpperCase()}</div></a>`;
        commentDiv.innerHTML = `
          ${avatarHtml}
          <div class="comment-content">
            <p><strong><a href="/profile/${encodeURIComponent(data.username)}">${data.username}</a></strong></p>
            <p>${data.content}</p>
            <small>${new Date().toLocaleString('fr-FR', { dateStyle: 'short', timeStyle: 'short' })}</small>
          </div>
        `;
        const noComments = commentsBox.querySelector('.no-comments');
        if (noComments) noComments.remove();
        commentsBox.appendChild(commentDiv);
        if (commentsBox.parentElement.classList.contains('open')) {
          commentsBox.scrollTop = commentsBox.scrollHeight;
        }
        const countEl = post.querySelector('.comment-count');
        countEl.textContent = parseInt(countEl.textContent || "0") + 1;
      }
    });

    socket.on('update_follow', data => {
      if (data.following) {
        window.followingUsers.add(data.target_user);
        document.querySelectorAll('.post').forEach(post => {
          const usernameEl = post.querySelector('.username');
          const followBtn = post.querySelector('.follow-btn');
          if (usernameEl && followBtn && usernameEl.textContent.trim() === data.target_user) {
            followBtn.classList.add('following');
            followBtn.dataset.following = 'true';
            followBtn.innerHTML = 'Abonné ✔';
            followBtn.disabled = true;
          }
        });
      }
    });

    window.addEventListener('popstate', () => {
      document.querySelectorAll('.comments-section.open').forEach(section => {
        section.classList.remove('open');
      });
    });
});
</script>
</body>
</html>
