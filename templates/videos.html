<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CHRONOS - Vidéos</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    /* ---------- GLOBAL ---------- */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #000;
      color: #fff;
      line-height: 1.5;
      overflow: hidden;
    }
    a { text-decoration: none; color: inherit; }

    /* ---------- VIDEO POSTS ---------- */
    .video-scroll {
      height: 100vh;
      overflow-y: auto;
      scroll-snap-type: y mandatory;
      scrollbar-width: none;
      scroll-behavior: smooth;
    }
    .video-scroll::-webkit-scrollbar { display: none; }
    .video-post {
      position: relative;
      width: 100%;
      height: 100vh;
      scroll-snap-align: start;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #000;
    }
    .video-container {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .post-video {
      width: 100%;
      height: 100%;
      object-fit: contain;
      background: #000;
      cursor: pointer;
    }
    .mute-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1rem;
      z-index: 10;
      transition: background 0.2s ease, transform 0.2s ease;
    }
    .mute-btn:hover {
      background: rgba(0, 0, 0, 0.9);
      transform: scale(1.1);
    }
    .user-info {
      position: absolute;
      top: 20px;
      left: 20px;
      display: flex;
      align-items: center;
      z-index: 10;
    }
    .avatar-post, .avatar-fallback {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      object-fit: cover;
      background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 1.1rem;
      color: #fff;
      border: 2px solid #fff;
      box-shadow: 0 0 0 1px rgba(0,0,0,0.05);
      transition: transform 0.2s ease;
    }
    .avatar-post:hover, .avatar-fallback:hover {
      transform: scale(1.05);
    }
    .username-link {
      margin-left: 12px;
      font-weight: 600;
      font-size: 0.95rem;
      color: #fff;
      transition: color 0.2s ease;
    }
    .username-link:hover {
      color: #0095f6;
    }
    .description-container {
      position: absolute;
      top: 70px;
      left: 20px;
      right: 80px;
      z-index: 10;
    }
    .description {
      font-size: 0.9rem;
      line-height: 1.4;
      word-wrap: break-word;
      overflow-wrap: break-word;
      color: #fff;
      background: rgba(0, 0, 0, 0.5);
      padding: 8px 12px;
      border-radius: 8px;
      overflow: hidden;
      display: -webkit-box;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: 1;
    }
    .description.expanded {
      -webkit-line-clamp: unset;
    }
    .toggle-description {
      display: none;
      color: #0095f6;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 600;
      margin-top: 6px;
      transition: color 0.2s ease;
    }
    .toggle-description:hover {
      color: #00376b;
    }
    .description.long + .toggle-description {
      display: block;
    }

    /* ---------- ACTIONS ---------- */
    .video-actions {
      position: absolute;
      bottom: 120px;
      right: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      z-index: 10;
    }
    .like-btn {
      border: none;
      background: none;
      font-size: 2rem;
      cursor: pointer;
      color: #fff;
      transition: transform 0.2s ease, color 0.2s ease;
    }
    .like-btn:hover {
      transform: scale(1.15);
      color: #ed4956;
    }
    .like-btn.liked {
      color: #ed4956;
      animation: heart-bounce 0.3s ease;
    }
    @keyframes heart-bounce {
      0% { transform: scale(1); }
      50% { transform: scale(1.3); }
      100% { transform: scale(1); }
    }
    .comment-btn {
      font-size: 2rem;
      color: #fff;
      transition: transform 0.2s ease, color 0.2s ease;
    }
    .comment-btn:hover {
      transform: scale(1.15);
      color: #0095f6;
    }
    .like-count, .comment-count {
      font-size: 0.9rem;
      font-weight: 600;
      color: #fff;
      text-align: center;
      margin-top: 4px;
    }
    .follow-btn {
      background: #0095f6;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 6px 16px;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: background 0.2s ease, transform 0.2s ease;
    }
    .follow-btn i {
      font-size: 0.9rem;
    }
    .follow-btn:hover {
      background: #00376b;
      transform: scale(1.05);
    }
    .follow-btn.following {
      background: #efefef;
      color: #262626;
      border: 1px solid #dbdbdb;
    }
    .follow-btn.following:hover {
      background: #dbdbdb;
    }

    /* ---------- CAROUSEL MULTIMEDIA ---------- */
    .carousel {
      position: relative;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }
    .carousel-track {
      display: flex;
      width: 100%;
      height: 100%;
      overflow-x: auto;
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      scroll-behavior: smooth;
    }
    .carousel-track::-webkit-scrollbar { display: none; }
    .carousel-track > * {
      flex: 0 0 100%;
      width: 100%;
      height: 100%;
      scroll-snap-align: start;
    }
    .carousel-indicators {
      position: absolute;
      bottom: 12px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 8px;
      z-index: 10;
    }
    .carousel-indicators .dot {
      width: 8px;
      height: 8px;
      background: rgba(255, 255, 255, 0.5);
      border-radius: 50%;
      transition: transform 0.2s ease, background 0.2s ease;
      cursor: pointer;
    }
    .carousel-indicators .dot.active {
      background: #fff;
      transform: scale(1.4);
    }

    /* ---------- COMMENTS ---------- */
    .comments-section {
      display: none;
      flex-direction: column;
      height: 80vh;
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      z-index: 20;
      border-radius: 12px;
      overflow: hidden;
    }
    .comments-section.open {
      display: flex;
    }
    .comments-box {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      scrollbar-width: none;
    }
    .comments-box::-webkit-scrollbar { display: none; }
    .comment {
      display: flex;
      align-items: flex-start;
      padding: 8px 0;
      opacity: 1;
      z-index: 1;
    }
    .avatar-comment, .avatar-fallback {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      object-fit: cover;
      background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 1rem;
      color: #fff;
      border: 2px solid #fff;
      box-shadow: 0 0 0 1px rgba(0,0,0,0.05);
      margin-right: 10px;
      transition: transform 0.2s ease;
    }
    .avatar-comment:hover, .avatar-fallback:hover {
      transform: scale(1.05);
    }
    .comment-content {
      flex: 1;
      max-width: calc(100% - 46px);
    }
    .comment-content p:first-child {
      font-weight: 600;
      font-size: 0.9rem;
      color: #fff;
    }
    .comment-content p:first-child a:hover {
      color: #0095f6;
    }
    .comment-content p:nth-child(2) {
      font-size: 0.85rem;
      color: #fff;
      word-wrap: break-word;
      overflow-wrap: break-word;
      white-space: normal;
      max-width: 100%;
      line-height: 1.4;
    }
    .comment-content small {
      font-size: 0.75rem;
      color: #8e8e8e;
      display: block;
      margin-top: 4px;
    }
    .no-comments {
      font-size: 0.9rem;
      color: #6b7280;
      text-align: center;
      padding: 16px 0;
    }

    /* ---------- COMMENT FORM ---------- */
    .comment-form {
      padding: 12px 16px;
      border-top: 1px solid #333;
      background: #000;
      position: sticky;
      bottom: 0;
      width: 100%;
      z-index: 20;
    }
    .comment-form form {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .comment-form textarea {
      flex: 1;
      padding: 8px 12px;
      font-size: 0.85rem;
      border: 1px solid #333;
      border-radius: 8px;
      resize: none;
      height: 40px;
      background: #1a1a1a;
      color: #fff;
      font-family: inherit;
      word-wrap: break-word;
      overflow-wrap: break-word;
      white-space: pre-wrap;
    }
    .comment-form textarea:focus {
      outline: none;
      border-color: #0095f6;
      box-shadow: 0 0 0 1px #0095f6;
    }
    .comment-form button {
      background: #0095f6;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.2s ease;
    }
    .comment-form button:hover {
      background: #00376b;
      transform: scale(1.05);
    }
    .comment-form button:disabled {
      background: #b2dffc;
      cursor: not-allowed;
    }

    /* ---------- RESPONSIVE ---------- */
    @media (max-width: 600px) {
      .avatar-post, .avatar-fallback { width: 36px; height: 36px; font-size: 0.9rem; }
      .username-link { font-size: 0.9rem; }
      .description-container { top: 60px; }
      .description { font-size: 0.85rem; padding: 6px 10px; }
      .toggle-description { font-size: 0.8rem; margin-top: 4px; }
      .mute-btn { width: 28px; height: 28px; font-size: 0.9rem; }
      .like-btn, .comment-btn { font-size: 1.8rem; }
      .follow-btn { padding: 5px 12px; font-size: 0.8rem; }
      .video-actions { bottom: 100px; }
      .comments-section { height: 70vh; }
      .comment-form { padding: 10px 12px; }
      .comment-form textarea { font-size: 0.8rem; height: 36px; }
      .comment-form button { padding: 6px 12px; font-size: 0.8rem; }
    }
  </style>
</head>
<body data-username="{{ username }}">
  <main class="video-scroll" id="video-posts">
    {% for post in posts %}
    <div class="video-post" data-post-id="{{ post.id }}">
      <div class="user-info">
        {% if post.avatar %}
        <a class="avatar-link" href="{{ url_for('profile', username=post.username) }}">
          <img src="{{ url_for('avatar_file', filename=post.avatar) }}?t={{ 'now'|timestamp }}" alt="avatar" class="avatar-post" />
        </a>
        {% else %}
        <a class="avatar-link" href="{{ url_for('profile', username=post.username) }}">
          <div class="avatar-fallback">{{ post.username[:1]|upper }}</div>
        </a>
        {% endif %}
        <a class="username-link" href="{{ url_for('profile', username=post.username) }}">
          <p class="username">{{ post.username }}</p>
        </a>
      </div>
      <div class="description-container">
        <p class="description">{{ post.description }}</p>
        <span class="toggle-description">Afficher plus</span>
      </div>
      {# ---- Single video ---- #}
      {% if post.type == "video" and not post.files %}
      <div class="video-container">
        <video src="{{ url_for('uploaded_file', filename=post.file) }}" muted loop class="post-video"></video>
        <button class="mute-btn" title="Activer/Désactiver le son">
          <i class="fa-solid fa-volume-xmark"></i>
        </button>
      </div>
      {% endif %}
      {# ---- Multiple files (carousel, only videos) ---- #}
      {% if post.files|length > 0 %}
      <div class="carousel">
        <div class="carousel-track">
          {% for file in post.files %}
          {% if file.type == "video" %}
          <div class="video-container">
            <video src="{{ url_for('uploaded_file', filename=file.name) }}" muted loop class="post-video"></video>
            <button class="mute-btn" title="Activer/Désactiver le son">
              <i class="fa-solid fa-volume-xmark"></i>
            </button>
          </div>
          {% endif %}
          {% endfor %}
        </div>
        <div class="carousel-indicators">
          {% for file in post.files %}
          {% if file.type == "video" %}
          <span class="dot{% if loop.first %} active{% endif %}"></span>
          {% endif %}
          {% endfor %}
        </div>
      </div>
      {% endif %}
      <div class="video-actions">
        <button class="like-btn{% if post.liked_by_user %} liked{% endif %}">
          <i class="{% if post.liked_by_user %}fa-solid{% else %}fa-regular{% endif %} fa-heart"></i>
          <span class="like-count">{{ post.likes if post.likes else 0 }}</span>
        </button>
        <button class="comment-btn">
          <i class="fa-regular fa-comment"></i>
          <span class="comment-count">{{ post.comments_count if post.comments_count else 0 }}</span>
        </button>
        <button
          class="follow-btn{% if post.following %} following{% endif %}"
          data-following="{{ 'true' if post.following else 'false' }}"
        >
          {% if post.following %}
          Abonné ✔
          {% else %}
          <i class="fa-solid fa-plus"></i> Suivre
          {% endif %}
        </button>
      </div>
      <section class="comments-section" id="comments-{{ post.id }}">
        <div class="comments-box" id="commentsBox-{{ post.id }}">
          {% if post.comments|length == 0 %}
            <p class="no-comments">Aucun commentaire pour l’instant.</p>
          {% else %}
            {% for comment in post.comments %}
            <div class="comment">
              {% if comment.avatar %}
              <a href="{{ url_for('profile', username=comment.username) }}">
                <img src="{{ url_for('avatar_file', filename=comment.avatar) }}?t={{ 'now'|timestamp }}" alt="avatar" class="avatar-comment" />
              </a>
              {% else %}
              <a href="{{ url_for('profile', username=comment.username) }}">
                <div class="avatar-fallback">{{ comment.username[:1]|upper }}</div>
              </a>
              {% endif %}
              <div class="comment-content">
                <p><strong><a href="{{ url_for('profile', username=comment.username) }}">{{ comment.username }}</a></strong></p>
                <p>{{ comment.content }}</p>
                <small>{{ comment.date }}</small>
              </div>
            </div>
            {% endfor %}
          {% endif %}
        </div>
        <div class="comment-form">
          <form data-post-id="{{ post.id }}">
            <textarea name="comment" placeholder="Écrire un commentaire..." required></textarea>
            <button type="submit">Commenter</button>
          </form>
        </div>
      </section>
    </div>
    {% endfor %}
  </main>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const currentUsername = document.body.dataset.username;
    const postsContainer = document.getElementById('video-posts');
    const videos = new Set();
    let currentVideo = null;
    const socket = io();

    // --- Scroll Control for Sequential Video Navigation ---
    let isScrolling = false;
    let lastScrollTop = 0;

    function snapToNearestVideo() {
      if (isScrolling) return;
      isScrolling = true;
      const scrollContainer = postsContainer;
      const scrollTop = scrollContainer.scrollTop;
      const windowHeight = window.innerHeight;
      const currentIndex = Math.round(scrollTop / windowHeight);
      const targetScrollTop = currentIndex * windowHeight;

      scrollContainer.scrollTo({
        top: targetScrollTop,
        behavior: 'smooth'
      });

      setTimeout(() => {
        isScrolling = false;
      }, 500); // Adjust timeout to match smooth scroll duration
    }

    postsContainer.addEventListener('scroll', () => {
      if (!isScrolling) {
        const scrollTop = postsContainer.scrollTop;
        const scrollDirection = scrollTop > lastScrollTop ? 'down' : 'up';
        lastScrollTop = scrollTop;

        // Debounce scroll to ensure smooth snapping
        clearTimeout(postsContainer.scrollTimeout);
        postsContainer.scrollTimeout = setTimeout(snapToNearestVideo, 150);
      }
    });

    async function toggleLike(button) {
      const post = button.closest('.video-post');
      const postId = post.dataset.postId;
      const countEl = post.querySelector('.like-count');
      try {
        const res = await fetch(`/like/${postId}`, { method: 'POST', credentials: 'same-origin' });
        if (!res.ok) return;
        const data = await res.json();
        countEl.textContent = data.likes;
        button.classList.toggle('liked', data.liked);
        const icon = button.querySelector('i');
        icon.classList.toggle('fa-solid', data.liked);
        icon.classList.toggle('fa-regular', !data.liked);
        socket.emit('like_updated', { post_id: parseInt(postId), likes: data.likes, liked: data.liked });
      } catch (err) { console.error(err); }
    }

    function bindLikes(post) {
      const btn = post.querySelector('.like-btn');
      if (!btn) return;
      btn.addEventListener('click', () => toggleLike(btn));
      const icon = btn.querySelector('i');
      const isLiked = btn.classList.contains('liked');
      icon.classList.toggle('fa-solid', isLiked);
      icon.classList.toggle('fa-regular', !isLiked);
    }

    function bindFollowButtons(post) {
      const btn = post.querySelector('.follow-btn');
      if (!btn) return;
      const postUsername = post.querySelector('.username').textContent.trim();

      function updateButton(button, isFollowing) {
        if (isFollowing) {
          button.dataset.following = "true";
          button.classList.add('following');
          button.innerHTML = 'Abonné ✔';
          button.disabled = true;
        } else {
          button.dataset.following = "false";
          button.classList.remove('following');
          button.innerHTML = '<i class="fa-solid fa-plus"></i> Suivre';
          button.disabled = false;
        }
      }

      if (!window.followingUsers) window.followingUsers = new Set();
      if (window.followingUsers.has(postUsername)) updateButton(btn, true);
      else updateButton(btn, btn.dataset.following === "true");

      btn.addEventListener('click', async () => {
        if (btn.dataset.following === "true") return;
        try {
          const res = await fetch(`/follow/${encodeURIComponent(postUsername)}`, { method: 'POST', credentials: 'same-origin' });
          if (!res.ok) throw new Error('Erreur serveur');
          const data = await res.json();
          if (data.following) {
            window.followingUsers.add(postUsername);
            document.querySelectorAll('.video-post').forEach(p => {
              const usernameEl = p.querySelector('.username');
              const followBtn = p.querySelector('.follow-btn');
              if (usernameEl && followBtn && usernameEl.textContent.trim() === postUsername) {
                updateButton(followBtn, true);
              }
            });
          } else {
            window.followingUsers.delete(postUsername);
            updateButton(btn, false);
          }
        } catch (e) {
          console.error(e);
          alert('Impossible de suivre pour le moment.');
        }
      });
    }

    /* ---------- Video autoplay and loop ---------- */
    const ioObserver = new IntersectionObserver((entries) => {
      let best = null;
      entries.forEach(entry => {
        const vid = entry.target;
        const visible = entry.isIntersecting && entry.intersectionRatio >= 0.6;
        if (visible && !best) best = vid;
        if (!visible && !vid.paused) vid.pause();
      });
      if (best && currentVideo !== best) {
        if (currentVideo) currentVideo.pause();
        currentVideo = best;
        currentVideo.play().catch(() => {});
      }
    }, { threshold: [0, 0.25, 0.5, 0.75, 1] });

    function observeVideo(vid) {
      if (!videos.has(vid)) {
        videos.add(vid);
        ioObserver.observe(vid);
        vid.pause();
        vid.addEventListener('ended', () => {
          vid.currentTime = 0;
          vid.play().catch(() => {});
        });
        vid.addEventListener('click', (e) => {
          if (e.target.classList.contains('mute-btn') || e.target.closest('.mute-btn')) return;
          if (vid.paused) {
            vid.play().catch(() => {});
          } else {
            vid.pause();
          }
        });
      }
    }

    /* ---------- Mute button functionality ---------- */
    function bindMuteButton(video, muteBtn) {
      if (!muteBtn) return;
      muteBtn.addEventListener('click', () => {
        video.muted = !video.muted;
        const icon = muteBtn.querySelector('i');
        icon.classList.toggle('fa-volume-xmark', video.muted);
        icon.classList.toggle('fa-volume-high', !video.muted);
      });
    }

    /* ---------- Comment Form Submission --- */
    function bindCommentForm(post) {
      const form = post.querySelector('.comment-form form');
      if (!form) return;
      const textarea = form.querySelector('textarea');
      const submitButton = form.querySelector('button');
      const postId = form.dataset.postId;
      const commentsBox = post.querySelector('#commentsBox-' + postId);

      form.addEventListener('submit', e => {
        e.preventDefault();
        let content = textarea.value.trim();
        if (!content) return;
        textarea.value = '';
        submitButton.disabled = true;
        fetch(`/comments/${postId}`, {
          method: 'POST',
          credentials: 'same-origin',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: `comment=${encodeURIComponent(content)}`
        }).then(res => {
          if (res.ok) {
            return res.json().then(data => {
              const commentId = data.comment_id;
              const commentDiv = document.createElement('div');
              commentDiv.className = 'comment';
              commentDiv.dataset.commentId = commentId;
              const avatarHtml = data.avatar
                ? `<a href="/profile/${encodeURIComponent(currentUsername)}"><img src="/avatars/${encodeURIComponent(data.avatar)}?t=${Date.now()}" alt="avatar" class="avatar-comment" /></a>`
                : `<a href="/profile/${encodeURIComponent(currentUsername)}"><div class="avatar-fallback">${currentUsername[0].toUpperCase()}</div></a>`;
              commentDiv.innerHTML = `
                ${avatarHtml}
                <div class="comment-content">
                  <p><strong><a href="/profile/${encodeURIComponent(currentUsername)}">${currentUsername}</a></strong></p>
                  <p>${content}</p>
                  <small>${new Date().toLocaleString('fr-FR', { dateStyle: 'short', timeStyle: 'short' })}</small>
                </div>
              `;
              const noComments = commentsBox.querySelector('.no-comments');
              if (noComments) noComments.remove();
              commentsBox.appendChild(commentDiv);
              commentsBox.scrollTop = commentsBox.scrollHeight;
              textarea.focus();
              const countEl = post.querySelector('.comment-count');
              countEl.textContent = parseInt(countEl.textContent || "0") + 1;
              socket.emit('send_comment', { post_id: parseInt(postId), comment_id: commentId, username: currentUsername, content, avatar: data.avatar });
            });
          } else {
            textarea.value = content;
          }
        }).catch(err => {
          console.error(err);
          textarea.value = content;
        }).finally(() => {
          submitButton.disabled = false;
        });
      });

      textarea.addEventListener('input', () => {
        submitButton.disabled = !textarea.value.trim();
      });
    }

    /* ---------- Comments Toggle --- */
    function bindCommentToggle(post) {
      const btn = post.querySelector('.comment-btn');
      const commentsSection = post.querySelector('.comments-section');
      if (!btn || !commentsSection) return;
      btn.addEventListener('click', () => {
        const isOpen = commentsSection.classList.contains('open');
        if (!isOpen) {
          commentsSection.classList.add('open');
          const commentsBox = commentsSection.querySelector('.comments-box');
          commentsBox.scrollTop = 0;
          history.pushState({ commentsOpen: true, postId: post.dataset.postId }, '', window.location.href);
          if (currentVideo) currentVideo.pause();
        } else {
          commentsSection.classList.remove('open');
          history.back();
        }
      });
    }

    /* ---------- Init posts existants ---------- */
    document.querySelectorAll('.video-post').forEach(post => {
      bindLikes(post);
      bindFollowButtons(post);
      bindCommentForm(post);
      bindCommentToggle(post);
      post.querySelectorAll('video').forEach(video => {
        observeVideo(video);
        const muteBtn = video.parentElement.querySelector('.mute-btn');
        bindMuteButton(video, muteBtn);
      });
      const description = post.querySelector('.description');
      const toggleButton = post.querySelector('.toggle-description');
      if (description && toggleButton) {
        if (description.scrollHeight > description.clientHeight) {
          description.classList.add('long');
        }
        toggleButton.addEventListener('click', () => {
          if (description.classList.contains('expanded')) {
            description.classList.remove('expanded');
            toggleButton.textContent = 'Afficher plus';
          } else {
            description.classList.add('expanded');
            toggleButton.textContent = 'Afficher moins';
          }
        });
      }
    });

    // --- Handle Back Button ---
    window.addEventListener('popstate', () => {
      document.querySelectorAll('.comments-section.open').forEach(section => {
        section.classList.remove('open');
      });
    });

    /* ---------- Socket.IO ---------- */
    socket.on('like_updated', data => {
      const post = document.querySelector(`.video-post[data-post-id="${data.post_id}"]`);
      if (post) {
        const countEl = post.querySelector('.like-count');
        if (countEl) countEl.textContent = data.likes;
        const btn = post.querySelector('.like-btn');
        if (btn) btn.classList.toggle('liked', data.liked);
        const icon = btn.querySelector('i');
        icon.classList.toggle('fa-solid', data.liked);
        icon.classList.toggle('fa-regular', !data.liked);
      }
    });

    socket.on('new_comment', data => {
      const post = document.querySelector(`.video-post[data-post-id="${data.post_id}"]`);
      if (!post) return;
      const commentsBox = post.querySelector('#commentsBox-' + data.post_id);
      if (!commentsBox) return;

      const existingComment = commentsBox.querySelector(`.comment[data-comment-id="${data.comment_id}"]`);
      if (!existingComment) {
        const commentDiv = document.createElement('div');
        commentDiv.className = 'comment';
        commentDiv.dataset.commentId = data.comment_id;
        const avatarHtml = data.avatar
          ? `<a href="/profile/${encodeURIComponent(data.username)}"><img src="/avatars/${encodeURIComponent(data.avatar)}?t=${Date.now()}" alt="avatar" class="avatar-comment" /></a>`
          : `<a href="/profile/${encodeURIComponent(data.username)}"><div class="avatar-fallback">${data.username[0].toUpperCase()}</div></a>`;
        commentDiv.innerHTML = `
          ${avatarHtml}
          <div class="comment-content">
            <p><strong><a href="/profile/${encodeURIComponent(data.username)}">${data.username}</a></strong></p>
            <p>${data.content}</p>
            <small>${new Date().toLocaleString('fr-FR', { dateStyle: 'short', timeStyle: 'short' })}</small>
          </div>
        `;
        const noComments = commentsBox.querySelector('.no-comments');
        if (noComments) noComments.remove();
        commentsBox.appendChild(commentDiv);
        if (commentsBox.parentElement.classList.contains('open')) {
          commentsBox.scrollTop = commentsBox.scrollHeight;
        }
        const countEl = post.querySelector('.comment-count');
        countEl.textContent = parseInt(countEl.textContent || "0") + 1;
      }
    });

    /* ---------- Carousel Initialization ---------- */
    function initCarousel(post) {
      const track = post.querySelector('.carousel-track');
      const dots = post.querySelectorAll('.carousel-indicators .dot');
      if (!track || dots.length === 0) return;

      Array.from(track.children).forEach(child => {
        child.style.width = '100%';
        child.style.height = '100%';
        child.style.flex = '0 0 100%';
      });

      track.style.overflowX = 'auto';
      track.style.scrollSnapType = 'x mandatory';

      track.addEventListener('scroll', () => {
        const index = Math.round(track.scrollLeft / track.offsetWidth);
        dots.forEach((dot, i) => dot.classList.toggle('active', i === index));
      });

      dots.forEach((dot, index) => {
        dot.addEventListener('click', () => {
          track.scrollTo({
            left: index * track.offsetWidth,
            behavior: 'smooth'
          });
        });
      });
    }

    document.querySelectorAll('.video-post').forEach(post => initCarousel(post));
  });
</script>
</body>
</html>
